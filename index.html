<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EXO-BRUSH: TITAN OMEGA</title>
    <style>
        :root { --p1: #0d1117; --p2: #21262d; --p3: #306230; --p4: #9bbc0f; --accent: #ff4500; --gold: #ffd700; }
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; height: 100vh; font-family: 'Courier New', monospace; }
        #game-wrap { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); }
        canvas { background: var(--p1); image-rendering: pixelated; width: 100%; height: 100%; max-width: 430px; aspect-ratio: 9/19.5; box-shadow: 0 0 50px rgba(0,0,0,1); }
        
        /* Premium CRT & Scanline FX */
        .crt::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 15; background-size: 100% 2px, 3px 100%; pointer-events: none; }
        .crt::after { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: rgba(18, 16, 16, 0.1); opacity: 0; z-index: 16; pointer-events: none; animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.1; } 50% { opacity: 0.05; } 100% { opacity: 0.1; } }

        #ui { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; background: rgba(0,0,0,0.9); color: var(--p4); transition: 0.5s; }
        .btn { background: var(--p3); border: 4px solid var(--p4); color: #fff; padding: 20px 40px; font-size: 24px; font-weight: bold; text-transform: uppercase; cursor: pointer; transform: skewX(-10deg); }
        .btn:active { transform: skewX(-10deg) scale(0.95); }
    </style>
</head>
<body>

<div id="game-wrap" class="crt">
    <canvas id="c"></canvas>
    <div id="ui">
        <div style="font-size: 14px; letter-spacing: 5px; margin-bottom: 20px;">SYSTEMS INITIALIZING...</div>
        <div id="big-timer" style="font-size: 100px; font-weight: 900; color: #fff;">READY</div>
        <button class="btn" onclick="bootSequence()">Ignite Link</button>
    </div>
</div>

<script>
/** 
 * OMEGA ENGINE v2.0
 * Pixel-Perfect Sprite Renderer + Physics-based Juicing
 */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui');
const timerText = document.getElementById('big-timer');

let state = {
    active: false, time: 120, frame: 0, shake: 0, shots: 0,
    crystals: parseInt(localStorage.getItem('gba_crystals_v1')) || 0,
    streak: parseInt(localStorage.getItem('gba_streak_v1')) || 0,
    combo: 0, comboScale: 0, particles: []
};

// 16-bit Bitmask for Hero
const HERO_MASK = [
    "00033300", "00344430", "03466443", "346666443", "361111643", "346666443", "03466443", "00333330"
];
const P_GBA = ['transparent', '#0d1117', '#21262d', '#306230', '#8bac0f', '#9bbc0f', '#00ffff'];

let audio;
const playBeep = (f, t, d, v=0.1) => {
    if(!audio) return;
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
    g.gain.setValueAtTime(v, audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + d);
    o.connect(g); g.connect(audio.destination);
    o.start(); o.stop(audio.currentTime + d);
};

function bootSequence() {
    audio = new (window.AudioContext || window.webkitAudioContext)();
    document.querySelector('.btn').style.display = 'none';
    let c = 3;
    const itv = setInterval(() => {
        timerText.innerText = c;
        playBeep(300 + (3-c)*100, 'square', 0.2);
        c--;
        if(c < 0) {
            clearInterval(itv);
            ui.style.opacity = '0';
            setTimeout(() => ui.style.display = 'none', 500);
            state.active = true;
            canvas.width = 430; canvas.height = 932;
            requestAnimationFrame(loop);
        }
    }, 1000);
}

const spawn = (x, y, color, speed, num) => {
    for(let i=0; i<num; i++) state.particles.push({
        x, y, vx: (Math.random()-0.5)*speed, vy: (Math.random()-0.5)*speed,
        l: 1, c: color, s: Math.random()*5+2
    });
};

function drawHero() {
    const x = 215, y = 700;
    const bob = Math.sin(state.frame * 0.1) * 10;
    const recoil = state.shake * 0.8;
    
    // Smooth Bitmask Render
    HERO_MASK.forEach((row, ri) => {
        [...row].forEach((px, pi) => {
            const color = P_GBA[parseInt(px)];
            if(color !== 'transparent') {
                ctx.fillStyle = color;
                ctx.fillRect(x - 40 + pi*10, y + bob + ri*10 + recoil, 10, 10);
            }
        });
    });

    if(state.frame % 15 === 0) { // Auto-fire logic
        state.shots++;
        state.shake = 15;
        state.combo++;
        state.comboScale = 2.0;
        playBeep(150, 'sawtooth', 0.1, 0.03);
        spawn(x, y + bob - 20, '#fff', 8, 4);
    }
}

function drawTitan() {
    const stage = Math.min(3, Math.floor((120 - state.time) / 30));
    const centerX = 215 + Math.sin(state.frame * 0.03) * 30;
    const centerY = 280 + Math.cos(state.frame * 0.02) * 10;
    
    // Main Body Squash/Stretch
    const ss = 1 + Math.sin(state.frame * 0.05) * 0.05;
    ctx.fillStyle = stage === 0 ? '#306230' : (stage === 1 ? '#8bac0f' : '#ff4500');
    
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.scale(ss, 2-ss);
    ctx.beginPath();
    ctx.arc(0, 0, 100 - (stage*10), 0, Math.PI*2);
    ctx.fill();
    
    // Core Cracks
    if(stage > 0) {
        ctx.strokeStyle = '#000'; ctx.lineWidth = 5;
        ctx.beginPath(); ctx.moveTo(-50, -20); ctx.lineTo(50, 20); ctx.stroke();
    }
    ctx.restore();

    if(stage >= 2 && state.frame % 10 === 0) spawn(centerX, centerY, '#ff0', 5, 2);
}

function loop() {
    if(!state.active) return;
    state.frame++;
    if(state.frame % 60 === 0) state.time--;
    if(state.shake > 0) state.shake *= 0.85;
    if(state.comboScale > 1.0) state.comboScale -= 0.05;

    ctx.fillStyle = '#0d1117';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Parallax
    for(let i=0; i<3; i++) {
        ctx.fillStyle = `rgba(48, 98, 48, ${0.2 * (i+1)})`;
        for(let j=0; j<10; j++) {
            let py = (j * 150 + state.frame * (i+1)) % canvas.height;
            ctx.fillRect((j * 90 + i * 30) % canvas.width, py, 4, 4);
        }
    }

    ctx.save();
    if(state.shake > 1) ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake);
    
    drawTitan();
    drawHero();

    // Particles
    state.particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.l -= 0.02;
        ctx.globalAlpha = p.l; ctx.fillStyle = p.c;
        ctx.fillRect(p.x, p.y, p.s, p.s);
        if(p.l <= 0) state.particles.splice(i, 1);
    });
    ctx.restore();
    ctx.globalAlpha = 1.0;

    // Premium HUD
    ctx.fillStyle = '#fff'; ctx.font = "900 24px 'Courier New'";
    ctx.fillText(`BIO-SYNC: ${Math.max(0, state.time)}s`, 30, 60);
    ctx.fillStyle = '#ffd700';
    ctx.fillText(`CRYSTALS: ${state.crystals}`, 30, 95);
    
    // Combo Text (Juicy)
    if(state.combo > 5) {
        ctx.save();
        ctx.translate(300, 150); ctx.scale(state.comboScale, state.comboScale);
        ctx.fillStyle = '#ff4500'; ctx.font = "900 40px 'Courier New'";
        ctx.fillText(`${state.combo}x`, 0, 0);
        ctx.restore();
    }

    if(state.time <= 0) finish();
    else requestAnimationFrame(loop);
}

function finish() {
    state.active = false;
    playBeep(60, 'sawtooth', 3, 0.4);
    spawn(215, 300, '#fff', 50, 400);
    
    setTimeout(() => {
        const earned = Math.floor(state.shots / 5) + (state.streak * 5);
        state.crystals += earned; state.streak++;
        localStorage.setItem('gba_crystals_v1', state.crystals);
        localStorage.setItem('gba_streak_v1', state.streak);
        
        ui.style.display = 'flex'; ui.style.opacity = '1';
        timerText.innerText = "TITAN OVERTHROWN";
        timerText.style.fontSize = "30px";
        document.querySelector('div[style*="letter-spacing"]').innerText = `+${earned} CRYSTALS SYNCED`;
    }, 1000);
}
</script>
</body>
</html>
