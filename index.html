<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TITAN OMEGA v4 — CHRONO SYNC</title>
<style>
:root{
  --bg:#050505;
  --panel:#0f0f12;
  --gold:#ffd700;
  --cyan:#00e5ff;
  --accent:#bc42f5;
  --danger:#ff4545;
  --muted:#9aa0a6;
  --glass: rgba(255,255,255,0.04);
  --ui-radius:10px;
  --max-width:480px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(180deg,#000 0%, #05050a 100%);
  color:#fff;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
#app{
  width:100%;
  max-width:var(--max-width);
  height:92vh;
  display:flex;
  flex-direction:column;
  border-radius:14px;
  overflow:hidden;
  background:linear-gradient(180deg,var(--panel), #07070a);
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.03);
}

/* Header */
#header{
  height:92px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px;
  gap:12px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.title-wrap{display:flex;flex-direction:column;gap:6px}
#title{font-weight:700;letter-spacing:2px;color:var(--gold)}
#subtitle{font-size:12px;color:var(--muted)}

/* HUD */
.hud{
  display:flex;
  gap:12px;
  align-items:center;
}
.hud .stat{display:flex;flex-direction:column;align-items:flex-end}
.hud .stat span{font-weight:700;color:var(--gold)}
.hud .controls{display:flex;gap:8px;align-items:center}

/* Viewport */
#viewport{
  position:relative;
  flex:1;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* Canvas wrapper to maintain pixelated scaling */
.canvas-wrap{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent 40%);
}

/* Pixelated canvas */
canvas{
  image-rendering: pixelated;
  width:100%;
  height:100%;
  max-height:calc(100vh - 260px);
  display:block;
}

/* HP bar */
#hp-wrap{
  position:absolute;
  top:18px;
  left:50%;
  transform:translateX(-50%);
  width:78%;
  height:18px;
  background:linear-gradient(90deg,#111,#0b0b0b);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.04);
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.6);
}
#hp{height:100%;width:100%;background:linear-gradient(90deg,var(--danger),#ffb84d);transition:width 200ms linear}

/* Overlay / menus */
.overlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.75));
  z-index:20;
  padding:20px;
}
.panel{
  width:100%;
  max-width:420px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;
  padding:18px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
}
.input-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
.input-row input[type="text"]{
  flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;font-weight:600
}
.btn{
  background:var(--cyan);color:#001;padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer
}
.small{padding:8px 10px;font-size:13px}
.toggle{display:flex;gap:8px;align-items:center}
.toggle input{transform:scale(1.2)}

/* Reward */
#reward{display:none;flex-direction:column;align-items:center;gap:12px}
#reward h1{margin:0;color:var(--gold);letter-spacing:2px}
.reward-count{font-size:28px;color:var(--cyan);font-weight:800}

/* Footer */
#footer{
  height:86px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 18px;
  border-top:1px solid rgba(255,255,255,0.03);
}
.footer-left{display:flex;gap:12px;align-items:center}
.pilot-badge{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--gold)}
.controls-legend{font-size:12px;color:var(--muted)}

/* Animations */
.fade-in{animation:fadeIn 360ms ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* Accessibility high contrast */
.high-contrast body, .high-contrast #app{filter:contrast(1.2) saturate(1.1)}
@media (max-width:520px){
  #header{padding:10px}
  .panel{padding:12px}
}
</style>
</head>
<body>
<div id="app" role="application" aria-label="Titan Omega Chrono Sync">
  <div id="header">
    <div class="title-wrap">
      <div id="title">TITAN OMEGA: CHRONO SYNC</div>
      <div id="subtitle">v4 — polished, performant, and accessible</div>
    </div>

    <div class="hud">
      <div class="stat">
        <div style="font-size:12px;color:var(--muted)">TIMER</div>
        <span id="timer" aria-live="polite">02:00</span>
      </div>

      <div class="stat" style="margin-left:12px">
        <div style="font-size:12px;color:var(--muted)">STREAK</div>
        <span id="uiStreak">0</span>
      </div>

      <div class="controls">
        <button id="muteBtn" class="small btn" title="Toggle sound">MUTE</button>
        <button id="pauseBtn" class="small btn" title="Pause (P)">PAUSE</button>
      </div>
    </div>
  </div>

  <div id="viewport" aria-hidden="false">
    <div id="hp-wrap" aria-hidden="true"><div id="hp" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div></div>

    <div class="canvas-wrap">
      <canvas id="game" width="430" height="932" aria-label="Game canvas"></canvas>
    </div>

    <!-- Start overlay -->
    <div id="overlay" class="overlay fade-in" role="dialog" aria-modal="true">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>MISSION BRIEF</strong>
          <small style="color:var(--muted)">Controls: Space to fire • P pause • M mute</small>
        </div>

        <div class="input-row">
          <input id="name" type="text" placeholder="PILOT NAME" aria-label="Pilot name">
          <button id="startBtn" class="btn">ENGAGE</button>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:12px">
          <label class="toggle"><input id="reducedMotion" type="checkbox"> Reduced motion</label>
          <label class="toggle"><input id="highContrast" type="checkbox"> High contrast</label>
        </div>

        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="color:var(--muted);font-size:13px">Crystals: <strong id="uiCrystals">0</strong></div>
          <div style="color:var(--muted);font-size:13px">Best streak: <strong id="uiBest">0</strong></div>
        </div>
      </div>
    </div>

    <!-- Reward overlay -->
    <div id="reward" class="overlay" role="dialog" aria-modal="true">
      <div class="panel" style="text-align:center">
        <h1>MISSION COMPLETE</h1>
        <div id="rewardText" class="reward-count">+0 CRYSTALS</div>
        <div style="margin-top:8px;color:var(--muted)">Streak: <span id="rewardStreak">0</span></div>
        <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
          <button id="exitBtn" class="btn">SYNC & EXIT</button>
          <button id="retryBtn" class="btn" style="background:var(--accent)">RETRY</button>
        </div>
      </div>
    </div>

  </div>

  <div id="footer">
    <div class="footer-left">
      <div class="pilot-badge" id="uiPilot">---</div>
      <div class="controls-legend">Pixel scale: auto • Reduced motion: off</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div style="font-size:12px;color:var(--muted)">Version</div>
      <div style="font-weight:700;color:var(--gold)">v4</div>
    </div>
  </div>
</div>

<script>
/* ================================
   CONFIG
   Single-file modular style: sections below
================================ */
const CONFIG = {
  duration: 120,           // seconds
  bossHP: 1000,
  laserDamage: 12,
  baseFireRate: 0.12,     // seconds between auto shots
  overdriveThreshold: 30, // seconds left
  rewardBase: 100,
  limits: { stars: 80, particles: 220, lasers: 60 },
  canvasLogical: { w: 430, h: 932 },
  shakeDecay: 0.9,
  audio: { musicVolume: 0.08, sfxVolume: 0.9 }
};

/* ================================
   STATE
================================ */
const state = {
  active: false,
  paused: false,
  time: CONFIG.duration,
  bossHP: CONFIG.bossHP,
  overdrive: false,
  crystals: parseInt(localStorage.getItem("titan_crystals")) || 0,
  streak: parseInt(localStorage.getItem("titan_streak")) || 0,
  bestStreak: parseInt(localStorage.getItem("titan_best")) || 0,
  pilot: localStorage.getItem("titan_pilot") || 'PILOT',
  stars: [],
  lasers: [],
  particles: [],
  pools: { lasers: [], particles: [] },
  lastFire: 0,
  fireRate: CONFIG.baseFireRate,
  shake: 0,
  flash: 0,
  reducedMotion: false,
  highContrast: false,
  muted: false
};

/* ================================
   CANVAS SETUP
================================ */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha: false });
const logicalW = CONFIG.canvasLogical.w;
const logicalH = CONFIG.canvasLogical.h;
canvas.width = logicalW;
canvas.height = logicalH;

// Responsive pixel scaling
function resizeCanvas() {
  const wrap = canvas.parentElement;
  const rect = wrap.getBoundingClientRect();
  const scale = Math.min(rect.width / logicalW, rect.height / logicalH);
  canvas.style.width = Math.floor(logicalW * scale) + 'px';
  canvas.style.height = Math.floor(logicalH * scale) + 'px';
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ================================
   UTILS
================================ */
function rand(min, max){ return Math.random()*(max-min)+min; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function easeOutQuad(t){ return 1 - (1 - t) * (1 - t); }

/* ================================
   AUDIO (lightweight synth fallback)
================================ */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new AudioCtx();
}
function playBeep(freq=440, time=0.06, vol=0.12){
  if(state.muted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  g.gain.value = vol * CONFIG.audio.sfxVolume;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + time);
}

/* ================================
   POOLS
================================ */
function createLaser(){
  return { x:0,y:0,vy:0,active:false };
}
function createParticle(){
  return { x:0,y:0,vx:0,vy:0,life:0,active:false };
}
function initPools(){
  for(let i=0;i<CONFIG.limits.lasers;i++) state.pools.lasers.push(createLaser());
  for(let i=0;i<CONFIG.limits.particles;i++) state.pools.particles.push(createParticle());
}
initPools();

/* ================================
   STARS
================================ */
function initStars(){
  state.stars.length = 0;
  for(let i=0;i<CONFIG.limits.stars;i++){
    state.stars.push({
      x: Math.random()*logicalW,
      y: Math.random()*logicalH,
      v: 10 + Math.random()*40,
      o: 0.2 + Math.random()*0.8,
      size: Math.random()*2 + 0.5
    });
  }
}
initStars();

/* ================================
   GAME FLOW
================================ */
let lastTime = performance.now();
function startGame(){
  state.pilot = (document.getElementById('name').value || state.pilot).toUpperCase();
  localStorage.setItem('titan_pilot', state.pilot);
  document.getElementById('uiPilot').innerText = state.pilot;
  state.time = CONFIG.duration;
  state.bossHP = CONFIG.bossHP;
  state.overdrive = false;
  state.active = true;
  state.paused = false;
  state.lastFire = 0;
  state.fireRate = CONFIG.baseFireRate;
  state.shake = 0;
  state.flash = 0;
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('reward').style.display = 'none';
  playBeep(880,0.08,0.08);
  lastTime = performance.now();
  requestAnimationFrame(loop);
}

function endVictory(){
  state.active = false;
  state.crystals += CONFIG.rewardBase + Math.floor((CONFIG.duration - state.time) * 0.5);
  state.streak += 1;
  state.bestStreak = Math.max(state.bestStreak, state.streak);
  localStorage.setItem('titan_crystals', state.crystals);
  localStorage.setItem('titan_streak', state.streak);
  localStorage.setItem('titan_best', state.bestStreak);

  document.getElementById('rewardText').innerText = `+${CONFIG.rewardBase} CRYSTALS`;
  document.getElementById('rewardStreak').innerText = state.streak;
  document.getElementById('uiCrystals').innerText = state.crystals;
  document.getElementById('uiStreak').innerText = state.streak;
  document.getElementById('uiBest').innerText = state.bestStreak;
  document.getElementById('reward').style.display = 'flex';
  document.getElementById('reward').classList.add('fade-in');
  playBeep(1200,0.18,0.18);
}

function endFail(){
  state.active = false;
  state.streak = 0;
  localStorage.setItem('titan_streak', state.streak);
  document.getElementById('rewardText').innerText = `MISSION FAILED`;
  document.getElementById('rewardStreak').innerText = state.streak;
  document.getElementById('reward').style.display = 'flex';
  document.getElementById('reward').classList.add('fade-in');
  playBeep(120,0.18,0.18);
}

/* ================================
   LASER SYSTEM (pooling)
================================ */
function spawnLaser(x,y,vy=-700){
  const pool = state.pools.lasers;
  for(let i=0;i<pool.length;i++){
    const l = pool[i];
    if(!l.active){
      l.active = true;
      l.x = x; l.y = y; l.vy = vy;
      state.lasers.push(l);
      return l;
    }
  }
  // fallback: if none free, reuse oldest
  const l = state.lasers.shift();
  if(l){ l.x=x; l.y=y; l.vy=vy; state.lasers.push(l); return l; }
  return null;
}
function despawnLaser(l){
  l.active = false;
  const idx = state.lasers.indexOf(l);
  if(idx>=0) state.lasers.splice(idx,1);
}

/* ================================
   PARTICLE SYSTEM (pooling)
================================ */
function spawnParticle(x,y,vx,vy,life=0.9){
  const pool = state.pools.particles;
  for(let i=0;i<pool.length;i++){
    const p = pool[i];
    if(!p.active){
      p.active = true;
      p.x = x; p.y = y; p.vx = vx; p.vy = vy; p.life = life;
      state.particles.push(p);
      return p;
    }
  }
  return null;
}
function despawnParticle(p){
  p.active = false;
  const idx = state.particles.indexOf(p);
  if(idx>=0) state.particles.splice(idx,1);
}

/* ================================
   BOSS BEHAVIOUR
================================ */
const boss = {
  x: logicalW/2,
  y: 160,
  w: 160,
  h: 160,
  vx: 0,
  phaseTimer: 0,
  shield: 0,
  pulse: 0
};

function updateBoss(dt){
  boss.phaseTimer += dt;
  // simple horizontal bobbing with occasional dash
  if(boss.phaseTimer > 2.5){
    boss.vx = rand(-80,80);
    boss.phaseTimer = 0;
  }
  boss.x += boss.vx * dt;
  boss.x = clamp(boss.x, boss.w/2 + 20, logicalW - boss.w/2 - 20);
  boss.vx *= 0.98;

  // shield pulses when overdrive
  boss.pulse += dt * (state.overdrive ? 6 : 2);
  boss.shield = 6 + Math.sin(boss.pulse) * 6;
}

/* ================================
   COLLISIONS & IMPACTS
================================ */
function spawnImpact(x,y,amount=6){
  for(let i=0;i<amount;i++){
    const vx = rand(-160,160);
    const vy = rand(-160,160);
    spawnParticle(x,y,vx,vy,0.6 + Math.random()*0.6);
  }
  state.shake = Math.min(12, state.shake + 6);
  state.flash = 0.6;
  playBeep(600 + Math.random()*400, 0.06, 0.08);
}

/* ================================
   INPUT
================================ */
window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ e.preventDefault(); if(state.active && !state.paused) manualFire(); }
  if(e.key === 'p' || e.key === 'P'){ togglePause(); }
  if(e.key === 'm' || e.key === 'M'){ toggleMute(); }
});
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('exitBtn').addEventListener('click', ()=>location.reload());
document.getElementById('retryBtn').addEventListener('click', ()=>{
  document.getElementById('reward').style.display='none';
  document.getElementById('overlay').style.display='flex';
});
document.getElementById('pauseBtn').addEventListener('click', togglePause);
document.getElementById('muteBtn').addEventListener('click', toggleMute);
document.getElementById('reducedMotion').addEventListener('change', (e)=>{
  state.reducedMotion = e.target.checked;
});
document.getElementById('highContrast').addEventListener('change', (e)=>{
  state.highContrast = e.target.checked;
  if(state.highContrast) document.documentElement.classList.add('high-contrast');
  else document.documentElement.classList.remove('high-contrast');
});

/* ================================
   FIRE LOGIC
================================ */
function autoFire(dt){
  // fire rate increases as time drops and in overdrive
  const overdriveFactor = state.overdrive ? 0.6 : 1;
  const timeFactor = 1 - (state.time / CONFIG.duration) * 0.5;
  state.fireRate = CONFIG.baseFireRate * (1 - timeFactor * 0.35) * overdriveFactor;

  state.lastFire += dt;
  if(state.lastFire >= state.fireRate){
    state.lastFire = 0;
    spawnLaser(logicalW/2, 760, -820 - (state.overdrive ? 120 : 0));
    playBeep(1200, 0.02, 0.06);
  }
}
function manualFire(){
  spawnLaser(logicalW/2, 760, -920);
  playBeep(1400, 0.03, 0.08);
}

/* ================================
   UPDATE LOOP
================================ */
function update(dt){
  if(state.paused) return;

  // timer
  state.time -= dt;
  if(state.time <= 0){
    // victory if boss HP <= 0, else fail
    if(state.bossHP <= 0) endVictory(); else endFail();
    return;
  }

  // overdrive
  if(state.time <= CONFIG.overdriveThreshold) state.overdrive = true;

  // stars
  const starSpeed = state.overdrive ? 1.8 : 1.0;
  for(const s of state.stars){
    s.y += s.v * dt * starSpeed;
    if(s.y > logicalH) s.y = -2;
  }

  // boss
  updateBoss(dt);

  // auto fire
  autoFire(dt);

  // lasers movement & collision
  for(let i = state.lasers.length - 1; i >= 0; i--){
    const l = state.lasers[i];
    l.y += l.vy * dt;
    // offscreen
    if(l.y < -40){ despawnLaser(l); continue; }

    // collision with boss bounding box (simple)
    const bx = boss.x, by = boss.y, bw = boss.w, bh = boss.h;
    if(l.y < by + bh/2 && l.y > by - bh/2 && l.x > bx - bw/2 && l.x < bx + bw/2){
      // hit
      state.bossHP -= CONFIG.laserDamage;
      spawnImpact(l.x, l.y, 8);
      despawnLaser(l);
      // boss enraged when low HP
      if(state.bossHP <= CONFIG.bossHP * 0.25) state.overdrive = true;
      if(state.bossHP <= 0){
        endVictory();
        return;
      }
    }
  }

  // particles
  for(let i = state.particles.length - 1; i >= 0; i--){
    const p = state.particles[i];
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vy += 220 * dt; // gravity
    p.life -= dt;
    if(p.life <= 0) despawnParticle(p);
  }

  // shake decay
  state.shake *= Math.pow(CONFIG.shakeDecay, dt*60);
  state.flash = Math.max(0, state.flash - dt*1.6);

  // UI updates
  updateUI();
}

/* ================================
   RENDERING
================================ */
function render(){
  // clear
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,logicalW,logicalH);

  // apply screen shake
  const shakeX = (Math.random()*2-1) * state.shake;
  const shakeY = (Math.random()*2-1) * state.shake;
  ctx.save();
  ctx.translate(shakeX, shakeY);

  // starfield (parallax)
  for(const s of state.stars){
    ctx.fillStyle = state.highContrast ? '#fff' : `rgba(180,220,255,${s.o})`;
    ctx.fillRect(Math.floor(s.x), Math.floor(s.y), Math.ceil(s.size), Math.ceil(s.size));
  }

  // boss (rounded square with pulse)
  const pulse = 1 + Math.sin(boss.pulse) * 0.03 * (state.overdrive ? 2 : 1);
  const bw = boss.w * pulse, bh = boss.h * pulse;
  ctx.save();
  ctx.translate(boss.x, boss.y);
  // shield glow
  const shieldAlpha = clamp(0.12 + (1 - state.bossHP/CONFIG.bossHP) * 0.6, 0, 0.9);
  ctx.fillStyle = state.overdrive ? 'rgba(255,80,80,0.12)' : 'rgba(0,160,255,0.06)';
  ctx.beginPath();
  ctx.ellipse(0,0,bw*0.9 + boss.shield, bh*0.9 + boss.shield, 0, 0, Math.PI*2);
  ctx.fill();

  // boss body
  ctx.fillStyle = state.overdrive ? '#ff3b3b' : '#444';
  roundRect(ctx, -bw/2, -bh/2, bw, bh, 12);
  ctx.fill();

  // boss eye / core
  ctx.fillStyle = state.overdrive ? '#fff' : '#00ffff';
  ctx.beginPath();
  ctx.arc(0, 0, 18 + (1 - state.bossHP/CONFIG.bossHP) * 8, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();

  // lasers
  ctx.fillStyle = state.overdrive ? '#fffa' : '#00ffff';
  for(const l of state.lasers){
    ctx.fillRect(Math.round(l.x)-2, Math.round(l.y)-20, 4, 20);
    // glow
    ctx.globalAlpha = 0.12;
    ctx.fillRect(Math.round(l.x)-6, Math.round(l.y)-26, 12, 28);
    ctx.globalAlpha = 1;
  }

  // particles
  for(const p of state.particles){
    ctx.globalAlpha = clamp(p.life, 0, 1);
    ctx.fillStyle = state.highContrast ? '#fff' : '#ffd700';
    ctx.fillRect(Math.round(p.x), Math.round(p.y), 3, 3);
    ctx.globalAlpha = 1;
  }

  // boss HP overlay
  ctx.restore();

  // flash overlay
  if(state.flash > 0){
    ctx.fillStyle = `rgba(255,255,255,${state.flash*0.12})`;
    ctx.fillRect(0,0,logicalW,logicalH);
  }

  // HUD elements drawn via DOM (timer, bars)
  // hp bar width
  const hpEl = document.getElementById('hp');
  const pct = clamp(state.bossHP / CONFIG.bossHP * 100, 0, 100);
  hpEl.style.width = pct + '%';
}

/* helper: rounded rect */
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

/* ================================
   UI UPDATES
================================ */
function updateUI(){
  // timer
  const m = Math.floor(state.time/60);
  const s = Math.floor(state.time%60);
  document.getElementById('timer').innerText = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  document.getElementById('uiCrystals').innerText = state.crystals;
  document.getElementById('uiStreak').innerText = state.streak;
  document.getElementById('uiBest').innerText = state.bestStreak;
}

/* ================================
   MAIN LOOP
================================ */
function loop(now){
  const dt = Math.min(0.033, (now - lastTime) / 1000); // clamp dt to avoid huge jumps
  lastTime = now;
  if(state.active && !state.paused){
    update(dt);
    render();
  } else if(state.active && state.paused){
    // still render paused overlay lightly
    render();
    // dim overlay
    ctx.fillStyle = 'rgba(0,0,0,0.28)';
    ctx.fillRect(0,0,logicalW,logicalH);
  }
  requestAnimationFrame(loop);
}

/* ================================
   PAUSE / MUTE
================================ */
function togglePause(){
  state.paused = !state.paused;
  document.getElementById('pauseBtn').innerText = state.paused ? 'RESUME' : 'PAUSE';
  if(state.paused) playBeep(220,0.06,0.06);
  else playBeep(660,0.06,0.06);
}
function toggleMute(){
  state.muted = !state.muted;
  document.getElementById('muteBtn').innerText = state.muted ? 'UNMUTE' : 'MUTE';
}

/* ================================
   INIT UI VALUES
================================ */
document.getElementById('uiPilot').innerText = state.pilot;
document.getElementById('uiCrystals').innerText = state.crystals;
document.getElementById('uiStreak').innerText = state.streak;
document.getElementById('uiBest').innerText = state.bestStreak;

/* ================================
   INITIAL RENDER
================================ */
render();
resizeCanvas();

/* ================================
   Expose some debug helpers (optional)
================================ */
window.__TITAN = { state, spawnLaser, spawnParticle, playBeep };

/* ================================
   End of file
================================ */
</script>
</body>
</html>
