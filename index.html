<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Metroid Brush Timer</title>
    <style>
        :root { --retro-green: #00ff41; --retro-red: #ff0044; --retro-blue: #0088ff; }
        body { margin: 0; background: #000; font-family: 'Courier New', Courier, monospace; overflow: hidden; color: white; touch-action: none; }
        #app { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { background: #111; border: 4px solid #333; image-rendering: pixelated; width: 90vw; height: 135vw; max-height: 80vh; }
        
        /* UI Overlays */
        #hud { position: absolute; top: 5%; width: 85%; display: flex; justify-content: space-between; font-size: 14px; text-shadow: 2px 2px #000; pointer-events: none; }
        #timer { font-size: 32px; color: var(--retro-green); }
        .timer-warning { color: var(--retro-red) !important; animation: flash 0.5s infinite; }
        
        /* Menus */
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .btn { padding: 15px 30px; background: var(--retro-blue); border: 4px outset #44aaff; color: white; font-weight: bold; font-size: 20px; cursor: pointer; }
        .btn:active { border-style: inset; }
        
        #loot-box { display: none; text-align: center; }
        #parent-panel { position: absolute; bottom: 10px; right: 10px; opacity: 0.1; width: 40px; height: 40px; }
        #parent-modal { display: none; position: fixed; inset: 20px; background: #222; border: 2px solid white; padding: 20px; z-index: 100; }

        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
    </style>
</head>
<body>

<div id="app">
    <div id="hud">
        <div>Z-1: ROBOT LAB<br>STREAK: <span id="streak-val">0</span></div>
        <div id="timer">02:00</div>
    </div>
    
    <canvas id="gameCanvas" width="160" height="240"></canvas>

    <div id="overlay">
        <div id="start-screen">
            <h1 style="color:var(--retro-red)">BATTLE READY?</h1>
            <button class="btn" onclick="startTimer()">START BRUSHING</button>
        </div>
        
        <div id="loot-box">
            <h2 id="win-text">BOSS DEFEATED!</h2>
            <div style="font-size: 50px; margin: 20px;">üéÅ</div>
            <button class="btn" onclick="openLoot()">OPEN CRYSTALS</button>
        </div>
    </div>

    <!-- Hidden Parent Control -->
    <div id="parent-panel" onclick="openParent()"></div>
    <div id="parent-modal">
        <h3>Admin Access</h3>
        <input type="password" id="passcode" placeholder="Passcode (1234)">
        <div id="admin-tools" style="display:none; margin-top:10px;">
            Streak: <input type="number" id="edit-streak"><br>
            Crystals: <input type="number" id="edit-crystals"><br>
            <button onclick="saveAdmin()">SAVE</button>
        </div>
        <button onclick="document.getElementById('parent-modal').style.display='none'">CLOSE</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const timerEl = document.getElementById('timer');
    
    // --- Game State ---
    let state = {
        running: false,
        timeLeft: 120,
        countdown: 5,
        crystals: parseInt(localStorage.getItem('crystals')) || 0,
        streak: parseInt(localStorage.getItem('streak')) || 0,
        lastBrushed: localStorage.getItem('lastBrushed') || "",
        particles: [],
        hero: { x: 20, y: 180, frame: 0, state: 'walk' },
        boss: { x: 100, y: 140, hp: 100, frame: 0, hit: 0 }
    };

    // --- Audio Synthesis (No external files needed) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(freq, dur) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    // --- Timer Logic ---
    function startTimer() {
        audioCtx.resume();
        document.getElementById('start-screen').style.display = 'none';
        
        let count = 5;
        const pre = setInterval(() => {
            timerEl.innerText = `READY: ${count}`;
            playBeep(440, 0.1);
            if (count-- <= 0) {
                clearInterval(pre);
                beginBattle();
            }
        }, 1000);
    }

    function beginBattle() {
        state.running = true;
        const mainTimer = setInterval(() => {
            state.timeLeft--;
            updateTimerDisplay();
            
            // Fixed Damage Intervals (every 30s)
            if (state.timeLeft % 30 === 0) {
                state.boss.hp -= 25;
                state.boss.hit = 10;
                spawnParticles(state.boss.x + 20, state.boss.y + 20);
            }

            if (state.timeLeft <= 10) {
                timerEl.classList.add('timer-warning');
                playBeep(880, 0.05);
            }

            if (state.timeLeft <= 0) {
                clearInterval(mainTimer);
                endSession();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(state.timeLeft / 60);
        const s = state.timeLeft % 60;
        timerEl.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    // --- Animation Loop ---
    function spawnParticles(x, y) {
        for(let i=0; i<10; i++) state.particles.push({x, y, vx: Math.random()*4-2, vy: Math.random()*4-2, life: 20});
    }

    function draw() {
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Ground
        ctx.fillStyle = '#333';
        ctx.fillRect(0, 210, canvas.width, 30);

        if(state.running) {
            // Animated Hero (Metroid-style)
            state.hero.frame = (state.hero.frame + 0.1) % 4;
            ctx.fillStyle = '#f0f'; // Samus-pink/orange
            ctx.fillRect(state.hero.x, state.hero.y - (Math.sin(state.hero.frame)*2), 15, 25);
            
            // Hero Shooting
            if(Math.random() > 0.9) {
                ctx.fillStyle = '#0ff';
                ctx.fillRect(state.hero.x + 15, state.hero.y + 10, 5, 2);
            }

            // Animated Boss
            ctx.fillStyle = state.boss.hit > 0 ? '#fff' : '#666';
            if(state.boss.hit > 0) state.boss.hit--;
            ctx.fillRect(state.boss.x, state.boss.y, 40, 40);
            // Boss Eye
            ctx.fillStyle = state.boss.hp < 30 ? 'red' : 'yellow';
            ctx.fillRect(state.boss.x + 10, state.boss.y + 10, 10, 10);
        }

        // Particles
        state.particles.forEach((p, i) => {
            ctx.fillStyle = '#ff0';
            ctx.fillRect(p.x += p.vx, p.y += p.vy, 2, 2);
            if(p.life-- < 0) state.particles.splice(i, 1);
        });

        requestAnimationFrame(draw);
    }

    // --- Rewards & Persistence ---
    function endSession() {
        state.running = false;
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('loot-box').style.display = 'block';
        
        // Handle Streak
        const today = new Date().toLocaleDateString();
        if (state.lastBrushed !== today) {
            state.streak++;
            state.lastBrushed = today;
            localStorage.setItem('streak', state.streak);
            localStorage.setItem('lastBrushed', today);
        }
    }

    function openLoot() {
        const earned = Math.floor(Math.random() * 50) + 50;
        state.crystals += earned;
        localStorage.setItem('crystals', state.crystals);
        alert(`You earned ${earned} Crystals!\nTotal: ${state.crystals}`);
        location.reload();
    }

    // --- Parent Controls ---
    function openParent() {
        document.getElementById('parent-modal').style.display = 'block';
        document.getElementById('passcode').oninput = (e) => {
            if(e.target.value === '1234') {
                document.getElementById('admin-tools').style.display = 'block';
                document.getElementById('edit-streak').value = state.streak;
                document.getElementById('edit-crystals').value = state.crystals;
            }
        };
    }

    function saveAdmin() {
        localStorage.setItem('streak', document.getElementById('edit-streak').value);
        localStorage.setItem('crystals', document.getElementById('edit-crystals').value);
        location.reload();
    }

    document.getElementById('streak-val').innerText = state.streak;
    draw();
</script>

</body>
</html>
