<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>GBA-Max Brush Battle</title>
<style>
:root {
  --hud-bg: rgba(0,0,0,0.55);
  --hud-border: rgba(255,255,255,0.2);
}

html,body {
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color:#fff;
}

#gameCanvas {
  display:block;
  margin:0 auto;
  image-rendering: pixelated;
  background:#000;
}

#hud {
  position:fixed;
  top:0;
  left:0;
  right:0;
  padding-top: env(safe-area-inset-top);
  display:flex;
  justify-content:space-between;
  align-items:center;
  pointer-events:none;
}

.hudBox {
  margin:12px;
  padding:12px 18px;
  background:var(--hud-bg);
  border:1px solid var(--hud-border);
  border-radius:14px;
  font-weight:800;
  font-size:40px;
  font-variant-numeric: tabular-nums;
  letter-spacing:2px;
}

#startOverlay {
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000;
  font-size:28px;
  text-align:center;
}

#lootModal, #pinPanel {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
}

.modalContent {
  background:#111;
  padding:24px;
  border-radius:16px;
  border:1px solid #333;
  text-align:center;
}

button {
  margin:8px;
  padding:10px 16px;
  font-size:16px;
}

#hotspot {
  position:fixed;
  bottom:0;
  right:0;
  width:64px;
  height:64px;
  opacity:0;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="hud">
  <div class="hudBox" id="timer">2:00</div>
  <div class="hudBox" id="streak">ðŸ”¥ 0</div>
</div>

<div id="startOverlay">Tap To Start</div>

<div id="lootModal">
  <div class="modalContent">
    <h2>Loot Box</h2>
    <div id="lootText"></div>
    <button onclick="restart()">Play Again</button>
  </div>
</div>

<div id="pinPanel">
  <div class="modalContent">
    <h3>Parent PIN</h3>
    <input type="password" id="pinInput" maxlength="4"><br>
    <button onclick="checkPin()">Enter</button>
    <div id="adminControls" style="display:none">
      <p>Crystals <input type="number" id="editCrystals"></p>
      <p>Streak <input type="number" id="editStreak"></p>
      <button onclick="saveAdmin()">Save</button>
      <button onclick="resetData()">Reset</button>
    </div>
  </div>
</div>

<div id="hotspot"></div>

<script>
/* CONFIG */
const TOTAL_TIME = 120;
const COUNTDOWN = 5;
const FIRE_RATE = 400;
const PIXEL_SCALE = 2;
const VILLAIN_STAGE_INTERVAL = 30;
const STORAGE_CRYSTALS = "gba_crystals_v1";
const STORAGE_STREAK = "gba_streak_v1";
const PIN = "1234";

/* CANVAS SETUP */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const off = document.createElement("canvas");
const offCtx = off.getContext("2d");

const WIDTH = 960;
const HEIGHT = 540;
off.width = WIDTH/PIXEL_SCALE;
off.height = HEIGHT/PIXEL_SCALE;
canvas.width = WIDTH;
canvas.height = HEIGHT;

/* STATE */
let state="idle";
let startTime=0;
let countdownStart=0;
let shotsFired=0;
let streak = parseInt(localStorage.getItem(STORAGE_STREAK))||0;
let crystals = parseInt(localStorage.getItem(STORAGE_CRYSTALS))||0;
let lastFire=0;
let particles=[];
let villainStage=0;

/* AUDIO */
let audioCtx;
let masterGain;

function initAudio(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value=0.4;
  masterGain.connect(audioCtx.destination);
  audioCtx.onstatechange=()=>console.log("Audio state:",audioCtx.state);
}

function resumeAudio(){
  if(audioCtx && audioCtx.state==="suspended"){
    audioCtx.resume();
  }
}

function beep(){
  const o=audioCtx.createOscillator();
  o.frequency.value=880;
  o.type="square";
  o.connect(masterGain);
  o.start();
  o.stop(audioCtx.currentTime+0.1);
}

function laser(){
  const o=audioCtx.createOscillator();
  const f=audioCtx.createBiquadFilter();
  o.type="sawtooth";
  o.frequency.value=600;
  f.type="lowpass";
  f.frequency.value=1200;
  o.connect(f);
  f.connect(masterGain);
  o.start();
  o.stop(audioCtx.currentTime+0.18);
}

function boom(){
  const o=audioCtx.createOscillator();
  o.type="sine";
  o.frequency.value=60;
  o.connect(masterGain);
  o.start();
  o.stop(audioCtx.currentTime+1);
}

/* SPRITE SYSTEM */
function drawBitmaskSprite(x,y,mask,palette){
  for(let j=0;j<mask.length;j++){
    for(let i=0;i<mask[j].length;i++){
      const idx=mask[j][i];
      if(idx>=0){
        offCtx.fillStyle=palette[idx];
        offCtx.fillRect(x+i,y+j,1,1);
      }
    }
  }
}

/* HERO SPRITE */
const heroMask=[
[ -1,1,1,1,1,-1],
[ 1,2,2,2,2,1],
[ 1,2,3,3,2,1],
[ 1,2,2,2,2,1],
[ -1,4,4,4,4,-1]
];

const heroPalette=["#000","#666","#0ff","#fff","#444"];

/* VILLAIN BASE */
const villainMask=[
[1,1,1,1,1,1],
[1,2,2,2,2,1],
[1,2,3,3,2,1],
[1,2,2,2,2,1],
[1,1,1,1,1,1]
];

function getVillainPalette(){
  if(villainStage===0) return ["#000","#555","#999","#0ff"];
  if(villainStage===1) return ["#000","#444","#888","#f00"];
  if(villainStage===2) return ["#000","#333","#777","#ff0"];
  return ["#000","#222","#f00","#ff6600"];
}

/* PARTICLES */
function addParticle(x,y,color){
  particles.push({
    x,y,
    vx:(Math.random()-0.5)*2,
    vy:(Math.random()-0.5)*2,
    life:60,
    color
  });
}

function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;
    p.y+=p.vy;
    p.life--;
    offCtx.fillStyle=p.color;
    offCtx.fillRect(p.x,p.y,1,1);
    if(p.life<=0) particles.splice(i,1);
  }
}

/* BACKGROUND */
const stars=[];
for(let i=0;i<120;i++){
  stars.push({x:Math.random()*off.width,y:Math.random()*off.height,s:Math.random()*3});
}

function drawBackground(){
  offCtx.fillStyle="#000";
  offCtx.fillRect(0,0,off.width,off.height);
  stars.forEach(st=>{
    offCtx.fillStyle="white";
    offCtx.fillRect(st.x,st.y,1,1);
    st.y+=st.s*0.2;
    if(st.y>off.height) st.y=0;
  });
}

/* LOOP */
function loop(ts){
  try{
    requestAnimationFrame(loop);
    drawBackground();
    if(state==="countdown"){
      const elapsed=Math.floor((performance.now()-countdownStart)/1000);
      const remain=COUNTDOWN-elapsed;
      document.getElementById("timer").textContent=remain>0?remain:"GO";
      if(remain<=0){
        state="main";
        startTime=performance.now();
      }
    }
    else if(state==="main"){
      const elapsed=Math.floor((performance.now()-startTime)/1000);
      const remain=TOTAL_TIME-elapsed;
      villainStage=Math.min(3,Math.floor(elapsed/VILLAIN_STAGE_INTERVAL));
      document.getElementById("timer").textContent=
        `${Math.floor(remain/60)}:${String(remain%60).padStart(2,"0")}`;
      if(performance.now()-lastFire>FIRE_RATE){
        laser();
        shotsFired++;
        lastFire=performance.now();
        addParticle(80,off.height/2,"#ff0");
      }
      if(remain<=0){
        state="end";
        boom();
        triggerExplosion();
      }
    }

    /* HERO */
    const t=performance.now()/500;
    const hx=40+Math.sin(t)*5;
    const hy=off.height/2+Math.cos(t)*10;
    drawBitmaskSprite(hx|0,hy|0,heroMask,heroPalette);

    /* VILLAIN */
    drawBitmaskSprite(off.width-60,off.height/2,villainMask,getVillainPalette());

    updateParticles();
    ctx.drawImage(off,0,0,canvas.width,canvas.height);

  }catch(e){
    console.error(e);
  }
}

/* EXPLOSION */
function triggerExplosion(){
  for(let i=0;i<200;i++){
    addParticle(off.width/2,off.height/2,"#ffcc00");
  }
  setTimeout(showLoot,1200);
}

/* LOOT */
function showLoot(){
  streak++;
  const gained=Math.floor(shotsFired/6)+Math.floor(streak/2);
  crystals+=gained;
  localStorage.setItem(STORAGE_CRYSTALS,crystals);
  localStorage.setItem(STORAGE_STREAK,streak);
  document.getElementById("lootText").textContent=
    `+${gained} Crystals\nTotal: ${crystals}`;
  document.getElementById("lootModal").style.display="flex";
}

function restart(){
  document.getElementById("lootModal").style.display="none";
  shotsFired=0;
  state="countdown";
  countdownStart=performance.now();
}

/* START */
function startGame(){
  resumeAudio();
  document.getElementById("startOverlay").style.display="none";
  state="countdown";
  countdownStart=performance.now();
}

document.getElementById("startOverlay")
.addEventListener("pointerdown",()=>{
  initAudio();
  startGame();
});

requestAnimationFrame(loop);

/* PIN */
document.getElementById("hotspot")
.addEventListener("click",()=>{
  document.getElementById("pinPanel").style.display="flex";
});

function checkPin(){
  if(document.getElementById("pinInput").value===PIN){
    document.getElementById("adminControls").style.display="block";
    document.getElementById("editCrystals").value=crystals;
    document.getElementById("editStreak").value=streak;
  }
}

function saveAdmin(){
  crystals=parseInt(document.getElementById("editCrystals").value)||0;
  streak=parseInt(document.getElementById("editStreak").value)||0;
  localStorage.setItem(STORAGE_CRYSTALS,crystals);
  localStorage.setItem(STORAGE_STREAK,streak);
  document.getElementById("pinPanel").style.display="none";
}

function resetData(){
  crystals=0;
  streak=0;
  localStorage.removeItem(STORAGE_CRYSTALS);
  localStorage.removeItem(STORAGE_STREAK);
  document.getElementById("pinPanel").style.display="none";
}
</script>
</body>
</html>
