<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Exo-Brush: 16-Bit ADHD Battle</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --neon-cyan: #00f3ff;
            --pixel-font: 'Courier New', Courier, monospace;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden; font-family: var(--pixel-font);
            color: white; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #gameCanvas { image-rendering: pixelated; width: 100vw; height: 100vh; display: block; }
        
        /* UI Layers */
        #ui-overlay {
            position: absolute; top: var(--safe-top); left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; pointer-events: none;
        }
        #timer {
            font-size: 80px; font-weight: 900; color: var(--neon-cyan);
            font-variant-numeric: tabular-nums; text-shadow: 0 0 15px rgba(0, 243, 255, 0.7);
        }
        #stats { position: absolute; top: 10px; left: 20px; font-size: 18px; color: #fff; }
        
        /* Modals */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .hidden { display: none !important; }
        .btn {
            background: var(--neon-cyan); color: #000; padding: 15px 40px;
            font-size: 24px; border: none; font-weight: bold; cursor: pointer;
            box-shadow: 4px 4px 0 #0088cc; margin-top: 20px;
        }

        /* Parental Hotspot */
        #parent-hotspot {
            position: fixed; bottom: 0; right: 0; width: 60px; height: 60px;
            z-index: 1000; cursor: pointer; opacity: 0;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-overlay">
        <div id="stats">STREAK: <span id="streak-val">0</span> | CRYSTALS: <span id="crystal-val">0</span></div>
        <div id="timer">02:00</div>
    </div>

    <!-- Intro Screen -->
    <div id="intro" class="modal">
        <h1 style="color: var(--neon-cyan); text-align: center;">NEURAL LINK SYNC</h1>
        <p>TAP TO INITIALIZE PILOT</p>
        <button class="btn" onclick="startCountdown()">SYNC NOW</button>
    </div>

    <!-- Loot Box Screen -->
    <div id="lootbox" class="modal hidden">
        <h1 id="loot-msg">TITAN DEFEATED!</h1>
        <div id="loot-anim" style="font-size: 50px;">ðŸ’ŽðŸ’ŽðŸ’Ž</div>
        <button class="btn" onclick="location.reload()">RE-ARM PILOT</button>
    </div>

    <!-- Invisible Hotspot -->
    <div id="parent-hotspot" onclick="openParentalPanel()"></div>

    <script>
        /** 
         * AUDIO ENGINE: Web Audio API synthesis 
         * No external files needed.
         */
        const AudioEngine = {
            ctx: null,
            init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            beep(freq = 440, dur = 0.1) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            },
            laser() {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(880, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(110, this.ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.15);
            },
            boom() {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(20, this.ctx.currentTime + 1.5);
                gain.gain.setValueAtTime(1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 1.5);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 1.5);
            }
        };

        /** 
         * GAME ENGINE & DRAWING 
         */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, state = 'IDLE', timer = 120, frames = 0;
        let particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false;
        }
        window.onresize = resize;
        resize();

        // Parallax Layers
        const stars = Array(100).fill().map(() => ({
            x: Math.random() * 2000, y: Math.random() * 1000, 
            s: Math.random() * 3 + 1, c: ['#fff', '#00f3ff', '#ff00ff'][Math.floor(Math.random()*3)]
        }));

        function drawHero(x, y, recoil) {
            // High-quality procedural 16-bit Hero (Exo-Suit)
            ctx.fillStyle = '#444'; // Heavy Metal Chassis
            ctx.fillRect(x - 30, y - 20, 60, 50); // Body
            ctx.fillStyle = '#222'; // Joints
            ctx.fillRect(x - 35, y + 10, 15, 20); ctx.fillRect(x + 20, y + 10, 15, 20); // Legs
            
            // Visor (Pilot visible)
            ctx.fillStyle = 'rgba(0, 243, 255, 0.4)';
            ctx.fillRect(x - 15, y - 10, 30, 20);
            ctx.strokeStyle = '#00f3ff'; ctx.strokeRect(x - 15, y - 10, 30, 20);
            
            // Recoil Cannon
            const r = recoil ? 15 : 0;
            ctx.fillStyle = '#666';
            ctx.fillRect(x + 30 - r, y + 5, 40, 15);
            if(recoil) {
                ctx.fillStyle = '#fff'; ctx.beginPath();
                ctx.arc(x + 75, y + 12, 10, 0, Math.PI*2); ctx.fill(); // Muzzle Flash
            }
        }

        function drawTitan(stage) {
            const tx = width * 0.75, ty = height/2;
            const wobble = Math.sin(frames * 0.05) * 10;
            
            ctx.fillStyle = stage === 4 ? '#500' : '#333';
            ctx.fillRect(tx - 60, ty - 80 + wobble, 120, 160); // Core body
            
            // Damage overlays
            if(stage >= 2) { // Cracked
                ctx.strokeStyle = '#fff'; ctx.beginPath(); ctx.moveTo(tx-20, ty-40); ctx.lineTo(tx+20, ty+10); ctx.stroke();
            }
            if(stage >= 3) { // Leaking
                ctx.fillStyle = '#000'; ctx.fillRect(tx-10, ty+40, 5, 30); // Oil drip
                if(frames % 10 < 3) { ctx.fillStyle = '#ff0'; ctx.fillRect(tx+30, ty-20, 4, 4); } // Sparks
            }
            if(stage >= 4) { // Exposed Core
                ctx.shadowBlur = 20; ctx.shadowColor = 'red';
                ctx.fillStyle = '#f00'; ctx.beginPath(); ctx.arc(tx, ty, 20, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        function gameLoop() {
            frames++;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,width,height);
            
            // 3-Layer Parallax
            stars.forEach(s => {
                s.x -= s.s; if(s.x < 0) s.x = width;
                ctx.fillStyle = s.c;
                ctx.fillRect(s.x, s.y % height, s.s, s.s);
            });

            if(state === 'BATTLE') {
                const heroX = 150, heroY = height/2 + Math.sin(frames * 0.05) * 50;
                const firing = frames % 20 < 2;
                if(firing) AudioEngine.laser();
                
                drawHero(heroX, heroY, firing);
                
                const damageStage = Math.min(4, Math.floor((120 - timer) / 30) + 1);
                drawTitan(damageStage);
                
                if(frames % 60 === 0 && timer > 0) {
                    timer--;
                    document.getElementById('timer').innerText = 
                        `${Math.floor(timer/60).toString().padStart(2,'0')}:${(timer%60).toString().padStart(2,'0')}`;
                    if(timer === 0) triggerEnd();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        /**
         * FLOW CONTROL
         */
        function startCountdown() {
            AudioEngine.init();
            document.getElementById('intro').classList.add('hidden');
            let count = 5;
            const iv = setInterval(() => {
                AudioEngine.beep(440 + (5-count)*100);
                if(count === 0) {
                    clearInterval(iv);
                    state = 'BATTLE';
                }
                count--;
            }, 1000);
        }

        function triggerEnd() {
            state = 'END';
            AudioEngine.boom();
            // Screen shake / Flash effect
            canvas.style.filter = 'brightness(5) contrast(2)';
            setTimeout(() => {
                canvas.style.filter = 'none';
                updateStats();
                document.getElementById('lootbox').classList.remove('hidden');
            }, 500);
        }

        function updateStats() {
            let streak = parseInt(localStorage.getItem('streak') || 0) + 1;
            let crystals = parseInt(localStorage.getItem('crystals') || 0) + 50;
            localStorage.setItem('streak', streak);
            localStorage.setItem('crystals', crystals);
            document.getElementById('streak-val').innerText = streak;
            document.getElementById('crystal-val').innerText = crystals;
        }

        function openParentalPanel() {
            const pin = prompt("Enter Parental PIN:");
            if(pin === "1234") {
                const val = prompt("Set Crystals to:");
                localStorage.setItem('crystals', val);
                location.reload();
            }
        }

        // Initialize display stats
        document.getElementById('streak-val').innerText = localStorage.getItem('streak') || 0;
        document.getElementById('crystal-val').innerText = localStorage.getItem('crystals') || 0;
        gameLoop();
    </script>
</body>
</html>
