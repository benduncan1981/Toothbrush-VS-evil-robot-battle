<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSCAR vs PLAXON: 1200+ MEGA ENGINE</title>
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <style>
        :root {
            --sega-blue: #0000ff; --sega-dark: #000044; --sega-red: #ff0000;
            --sega-gold: #ffcc00; --suit-green: #39ff14; --bg: #010105;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: #fff; overflow: hidden;
            font-family: 'Inter', sans-serif; touch-action: none;
        }

        /* --- THE HUD: OSCAR'S DASHBOARD --- */
        #ui-layer { position: absolute; inset: 0; z-index: 100; pointer-events: none; display: flex; flex-direction: column; padding: env(safe-area-inset-top, 20px) 20px 40px 20px; }
        .hud-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .hud-card { background: rgba(0, 0, 70, 0.9); border: 4px solid var(--sega-blue); padding: 12px 18px; border-radius: 12px; box-shadow: 6px 6px 0 #000; backdrop-filter: blur(12px); pointer-events: auto; }
        .label { font-size: 10px; color: var(--sega-gold); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .val { font-size: 24px; font-weight: 900; }
        #main-timer { position: absolute; top: 140px; width: 100%; text-align: center; font-size: 90px; font-weight: 900; text-shadow: 6px 6px 0 var(--sega-blue); }
        #oscar-msg { position: absolute; bottom: 180px; width: 100%; text-align: center; font-size: 32px; font-weight: 900; color: var(--suit-green); text-shadow: 4px 4px 0 #000; opacity: 0; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .msg-pop { opacity: 1 !important; transform: scale(1.1); }

        /* --- POST-PROCESSING --- */
        #crt { position: absolute; inset: 0; z-index: 500; pointer-events: none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.12) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05)); background-size: 100% 3px, 2px 100%; }
        #rage { position: absolute; inset: 0; background: rgba(255,0,0,0.25); pointer-events: none; opacity: 0; transition: opacity 2s; z-index: 450; }

        /* --- SCREENS --- */
        .overlay { position: absolute; inset: 0; z-index: 1000; background: radial-gradient(circle, #000055 0%, #000 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: transform 0.8s cubic-bezier(0.7, 0, 0.3, 1); }
        .hide { transform: translateY(-100%); }
        .btn-engage { padding: 35px 85px; font-size: 38px; font-weight: 900; border-radius: 20px; background: var(--sega-red); color: #fff; border: 6px solid #fff; box-shadow: 0 12px 0 #880000; cursor: pointer; }
        .btn-engage:active { transform: translateY(8px); box-shadow: 0 4px 0 #880000; }

        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }
        #parent-door { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; opacity: 0; z-index: 2000; pointer-events: auto; }
    </style>
</head>
<body>

<div id="app">
    <div id="crt"></div><div id="rage"></div>
    <div id="ui-layer">
        <div class="hud-row">
            <div class="hud-card" id="card-streak"><span class="label">STREAK</span><span id="v-streak" class="val">0</span></div>
            <div class="hud-card"><span class="label">CRYSTALS</span><span id="v-gems" class="val">0</span></div>
        </div>
        <div id="main-timer">02:00</div>
        <div id="oscar-msg">KEEP BRUSHING OSCAR!</div>
    </div>
    <canvas id="canvas"></canvas>
    <div id="screen-start" class="overlay">
        <h1 style="font-size: 55px; color: var(--sega-gold); line-height: 0.8; margin-bottom: 50px;">OSCAR vs<br>PLAXON</h1>
        <button class="btn-engage" id="engage-btn">ENGAGE</button>
    </div>
    <div id="screen-loot" class="overlay hide">
        <h2 style="font-size: 48px; color: var(--sega-gold);">VICTORY!</h2>
        <div id="box" style="font-size: 160px; cursor: pointer;" onclick="Core.openLoot()">üéÅ</div>
        <p style="font-size: 24px; font-weight: 900; margin-top: 30px;">OPEN YOUR VAULT</p>
    </div>
    <div id="parent-door" onclick="Core.parent()"></div>
</div>

<script>
/**
 * CORE ENGINE v1200+ (Failsafe Oscar Edition)
 * Optimized for Safari iPhone 15 Touch Interactions.
 */

const Core = (() => {
    // --- MODULE: ENGINE CORE ---
    let canvas, ctx, w, h;
    let clock = 0, state = 'MENU', timeLeft = 120, lastTime = 0;
    let oscar, plaxon, stars = [], bullets = [], particles = [], gems = [];
    let db = JSON.parse(localStorage.getItem('oscar_final_v1')) || { streak: 0, crystals: 0, lastDate: null };

    // --- MODULE: AUDIO FAILSAFE ---
    let audio;
    const Sound = {
        init() {
            if (!audio) {
                audio = new (window.AudioContext || window.webkitAudioContext)();
                // Safari Audio Primer
                const buffer = audio.createBuffer(1, 1, 22050);
                const source = audio.createBufferSource();
                source.buffer = buffer;
                source.connect(audio.destination);
                source.start(0);
            }
            if (audio.state === 'suspended') audio.resume();
        },
        tone(f, t, d, v=0.1) {
            if(!audio || audio.state !== 'running') return;
            const o = audio.createOscillator(), g = audio.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
            g.gain.setValueAtTime(v, audio.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime+d);
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime+d);
        }
    };

    // --- MODULE: RENDER CLASSES ---
    class Sprite {
        constructor(x, y, w, h) { this.x = x; this.y = y; this.w = w; this.h = h; }
    }

    class Oscar extends Sprite {
        update() { this.y = (h/2) + Math.sin(clock * 0.04) * (h * 0.22); }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.fillStyle = '#0044ee'; ctx.fillRect(0, 15, this.w, this.h-15);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.strokeRect(0, 15, this.w, this.h-15);
            ctx.fillStyle = '#ffdbac'; ctx.fillRect(18, 0, 38, 38); // Face
            ctx.fillStyle = '#000'; ctx.fillRect(26, 18, 6, 6); ctx.fillRect(44, 18, 6, 6);
            ctx.fillStyle = 'rgba(0, 255, 255, 0.2)'; ctx.fillRect(12, -8, 50, 50);
            ctx.restore();
        }
    }

    class Plaxon extends Sprite {
        constructor() { super(0, 0, 220, 300); this.shake = 0; this.stage = 0; }
        update() {
            this.x = w - 260; this.y = (h/2 - this.h/2) + Math.cos(clock * 0.02) * 110;
            if(this.shake > 0) this.shake *= 0.85;
            this.stage = Math.floor((120 - timeLeft) / 30);
        }
        draw() {
            ctx.save(); ctx.translate(this.x + (Math.random()-0.5)*this.shake, this.y);
            ctx.fillStyle = '#2a2a3a'; ctx.fillRect(0, 90, this.w, 200);
            ctx.strokeStyle = '#555'; ctx.lineWidth = 5; ctx.strokeRect(0, 90, this.w, 200);
            ctx.fillStyle = timeLeft < 30 ? 'red' : 'yellow'; ctx.fillRect(45, 30, 130, 25);
            if(this.stage >= 1 && clock % 10 < 3) spawnFX(this.x+50, this.y+150, '#ffaa00', 8);
            ctx.restore();
        }
    }

    // --- MODULE: CORE ENGINE ---
    function init() {
        canvas = document.getElementById('canvas'); ctx = canvas.getContext('2d');
        resize(); window.onresize = resize;
        oscar = new Oscar(100, 0, 75, 100); plaxon = new Plaxon();
        for(let i=0; i<150; i++) stars.push({x: Math.random()*2500, y: Math.random()*2000, z: Math.random()*5+1, o: Math.random()});
        
        // FAILSAFE: Explicit Event Listeners for Safari
        const btn = document.getElementById('engage-btn');
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); startBattle(); }, { passive: false });
        btn.addEventListener('click', (e) => { e.preventDefault(); startBattle(); });

        requestAnimationFrame(loop);
    }

    function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }

    function loop(t) {
        clock++; ctx.fillStyle = '#000010'; ctx.fillRect(0,0,w,h);
        
        // Stars
        ctx.fillStyle = '#fff';
        stars.forEach(s => {
            let px = (s.x - (clock * s.z * 0.4)) % w; if(px < 0) px += w;
            ctx.globalAlpha = s.o; ctx.fillRect(px, s.y % h, s.z, s.z);
        });
        ctx.globalAlpha = 1;

        if(state === 'BATTLE') {
            oscar.update(); oscar.draw();
            plaxon.update(); plaxon.draw();
            updateCombat(); updateMessages();
        } else if (state === 'REWARD') {
            updateGems();
        }

        particles.forEach((p, i) => { 
            p.x += p.vx; p.y += p.vy; p.l -= 0.02;
            ctx.globalAlpha = p.l; ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, 4, 4);
            if(p.l <= 0) particles.splice(i, 1);
        });
        ctx.globalAlpha = 1;

        requestAnimationFrame(loop);
    }

    function startBattle() {
        if(state !== 'MENU') return;
        Sound.init();
        state = 'BATTLE';
        document.getElementById('screen-start').classList.add('hide');
        const timer = setInterval(() => {
            timeLeft--;
            document.getElementById('main-timer').innerText = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
            if(timeLeft <= 30) document.getElementById('rage').style.opacity = '1';
            if(timeLeft <= 0) { clearInterval(timer); victory(); }
        }, 1000);
    }

    function updateCombat() {
        if(clock % 16 === 0) { bullets.push({x: oscar.x+70, y: oscar.y+45, v: 16}); Sound.tone(440, 'square', 0.1); }
        for(let i=bullets.length-1; i>=0; i--) {
            const b = bullets[i]; b.x += b.v;
            ctx.fillStyle = '#00ffff'; ctx.fillRect(b.x, b.y, 35, 10);
            if(b.x > plaxon.x && b.x < plaxon.x+plaxon.w && b.y > plaxon.y && b.y < plaxon.y+plaxon.h) {
                plaxon.shake = 20; Sound.tone(110, 'sawtooth', 0.15); spawnFX(b.x, b.y, '#ff6600', 10); bullets.splice(i,1);
            }
            if(b.x > w) bullets.splice(i,1);
        }
    }

    function spawnFX(x,y,c,n) { for(let i=0; i<n; i++) particles.push({x,y,vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, l:1, c}); }

    function updateMessages() {
        const msg = document.getElementById('oscar-msg');
        const lines = ["KEEP GOING OSCAR!", "SQUASH THE GERMS!", "OSCAR IS A HERO!", "ALMOST DONE!"];
        if(clock % 240 === 0) { msg.innerText = lines[Math.floor(Math.random()*lines.length)]; msg.classList.add('msg-pop'); setTimeout(() => msg.classList.remove('msg-pop'), 2500); }
    }

    function victory() {
        state = 'FINALE';
        let booms = 0;
        const seq = setInterval(() => {
            spawnFX(plaxon.x + Math.random()*plaxon.w, plaxon.y + Math.random()*plaxon.h, '#ff3300', 40);
            Sound.tone(100+Math.random()*200, 'sawtooth', 0.5);
            booms++;
            if(booms > 20) { clearInterval(seq); Sound.victory(); document.getElementById('screen-loot').classList.remove('hide'); }
        }, 140);
    }

    function openLoot() {
        document.getElementById('box').innerText = 'üíé'; state = 'REWARD';
        for(let i=0; i<30; i++) gems.push({x: w/2, y: h/2, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20});
        db.crystals += 500;
        const today = new Date().toDateString();
        if(db.lastDate !== today) { db.streak++; db.lastDate = today; }
        localStorage.setItem('oscar_final_v1', JSON.stringify(db));
        updateHUD();
        setTimeout(() => location.reload(), 4500);
    }

    function updateGems() {
        gems.forEach(g => {
            g.x += (60 - g.x) * 0.08; g.y += (100 - g.y) * 0.08;
            ctx.fillStyle = 'gold'; ctx.beginPath(); ctx.arc(g.x, g.y, 8, 0, Math.PI*2); ctx.fill();
        });
    }

    function updateHUD() {
        document.getElementById('v-streak').innerText = db.streak;
        document.getElementById('v-gems').innerText = db.crystals;
    }

    function loadDB() { updateHUD(); }

    return { init, openLoot, parent: () => { const n = prompt("Streak?"); if(n) { db.streak = parseInt(n); localStorage.setItem('oscar_final_v1', JSON.stringify(db)); updateHUD(); } } };
})();

window.onload = Engine.init;
</script>
</body>
</html>
