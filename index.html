<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TITAN OMEGA — Toothbrush Mode (Improved HUD & Crawl)</title>
<style>
/* =========================
   THEME & LAYOUT
   ========================= */
:root{
  --bg:#05050a;
  --panel:#0b0b10;
  --accent:#00f0ff;
  --gold:#ffd700;
  --pink:#ff6fb5;
  --danger:#ff5a5a;
  --glass: rgba(255,255,255,0.03);
  --ui-radius:14px;
  --max-width:520px;
  --crt-opacity:0.06;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#000 0%, #05050a 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#fff}
a{color:inherit}
.container{
  width:100%;
  max-width:var(--max-width);
  margin:18px auto;
  border-radius:16px;
  overflow:hidden;
  background:linear-gradient(180deg,var(--panel), #07070a);
  box-shadow:0 18px 60px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.03);
  min-height:80vh;
  display:flex;
  flex-direction:column;
}

/* header */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  gap:12px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.brand{display:flex;flex-direction:column}
.brand .title{font-weight:900;letter-spacing:2px;color:var(--gold);font-size:16px}
.brand .sub{font-size:12px;color:#9aa0a6}

/* HUD area (big friendly) */
.hud{
  display:flex;
  align-items:center;
  gap:12px;
}
.timer-big{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-width:120px;
}
.timer-big .time{
  font-weight:900;
  font-size:34px;
  color:var(--accent);
  text-shadow:0 6px 18px rgba(0,240,255,0.08);
}
.timer-big .label{font-size:11px;color:#9aa0a6}

/* right controls */
.controls{display:flex;gap:8px;align-items:center}
.btn{
  background:linear-gradient(180deg,var(--accent),#00c7d9);
  color:#001;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,200,255,0.06);
}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff}

/* viewport */
.viewport{
  position:relative;
  display:flex;
  flex:1;
  min-height:520px;
  align-items:center;
  justify-content:center;
  background:radial-gradient(ellipse at center, rgba(255,255,255,0.02), transparent 30%);
  overflow:hidden;
}

/* canvas wrapper */
.canvas-wrap{
  width:100%;
  max-width:420px;
  height:calc(100vh - 260px);
  max-height:720px;
  margin:18px auto;
  position:relative;
  border-radius:12px;
  overflow:hidden;
  background:#000;
  box-shadow: inset 0 0 80px rgba(0,0,0,0.6);
}

/* pixel canvas */
canvas{
  width:100%;
  height:100%;
  image-rendering:pixelated;
  display:block;
}

/* HUD overlay inside viewport */
.hud-overlay{
  position:absolute;
  inset:auto 18px 18px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  pointer-events:none;
}

/* boss HP bar (big, glowing) */
.hp-wrap{
  width:60%;
  height:22px;
  background:linear-gradient(90deg,#111,#0b0b0b);
  border-radius:999px;
  padding:3px;
  box-shadow:0 6px 30px rgba(0,0,0,0.6);
  pointer-events:auto;
}
.hp-bar{
  height:100%;
  width:100%;
  background:linear-gradient(90deg,var(--danger),#ffb84d);
  border-radius:999px;
  box-shadow:0 6px 30px rgba(255,80,80,0.08), 0 0 18px rgba(255,120,80,0.06);
  transition:width 0.25s linear;
}

/* friendly big action area for kids */
.action-row{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:center;
  margin-top:12px;
}
.big-btn{
  pointer-events:auto;
  background:linear-gradient(180deg,var(--pink),#ff4f9a);
  color:#fff;
  border:none;
  padding:14px 20px;
  border-radius:14px;
  font-weight:900;
  font-size:16px;
  box-shadow:0 12px 30px rgba(255,80,160,0.12);
  cursor:pointer;
}

/* footer */
.footer{
  padding:12px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  border-top:1px solid rgba(255,255,255,0.03);
}

/* overlays & panels */
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;
  padding:14px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
}

/* crawl page (separate view) */
.crawl-page{
  min-height:80vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:18px;
  padding:28px;
  text-align:center;
}
.crawl-title{font-size:28px;font-weight:900;color:var(--gold);letter-spacing:2px}
.crawl-sub{font-size:14px;color:#cfd6db;max-width:720px}

/* star wars crawl box */
.crawl-box{
  width:92%;
  max-width:640px;
  height:320px;
  perspective:600px;
  overflow:hidden;
  position:relative;
  border-radius:10px;
  background:linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.95));
  border:1px solid rgba(255,255,255,0.02);
}
.crawl-inner{
  position:absolute;
  bottom:-10%;
  width:100%;
  transform-origin:50% 100%;
  color:#ffd;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:1px;
  padding:18px;
  line-height:1.4;
  font-size:16px;
  transform:rotateX(20deg) translateY(100%);
  opacity:0;
}
.crawl-inner.play{
  animation: crawlAnim linear forwards;
}
@keyframes crawlAnim{
  0%{ transform:rotateX(20deg) translateY(100%); opacity:1 }
  100%{ transform:rotateX(20deg) translateY(-220%); opacity:0.95 }
}

/* countdown big */
.countdown-big{
  font-weight:900;
  font-size:96px;
  color:var(--gold);
  text-shadow:0 12px 40px rgba(255,200,80,0.08);
}

/* CRT / scanlines overlay */
.crt{
  pointer-events:none;
  position:absolute;
  inset:0;
  mix-blend-mode:overlay;
  opacity:var(--crt-opacity);
  background-image:
    linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size:100% 3px;
  z-index:60;
}

/* vignette & bloom */
.vignette{
  pointer-events:none;
  position:absolute;
  inset:0;
  background:radial-gradient(ellipse at center, rgba(255,255,255,0.02), rgba(0,0,0,0.6));
  mix-blend-mode:soft-light;
  z-index:50;
}

/* glowing ring for timer */
.ring{
  width:84px;height:84px;border-radius:999px;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(circle at 30% 30%, rgba(0,240,255,0.08), transparent 40%);
  box-shadow:0 12px 40px rgba(0,240,255,0.06), inset 0 0 18px rgba(0,240,255,0.03);
}

/* confetti (simple) */
.confetti{
  position:absolute;inset:0;pointer-events:none;z-index:120;overflow:hidden;
}

/* small responsive */
@media (max-width:520px){
  .timer-big .time{font-size:28px}
  .countdown-big{font-size:64px}
  .canvas-wrap{max-width:360px}
}
</style>
</head>
<body>

<!-- =========================
     TWO-VIEW APP (hash navigation)
     #crawl  -> intro crawl page
     #game   -> game page
   ========================= -->

<div id="app" class="container" role="application" aria-label="Titan Omega Toothbrush Mode">

  <!-- Header (shared) -->
  <div class="header">
    <div class="brand" aria-hidden="false">
      <div class="title">TITAN OMEGA</div>
      <div class="sub">CHRONO SYNC — Toothbrush Mode</div>
    </div>

    <div class="hud" aria-hidden="false">
      <div class="timer-big" aria-live="polite">
        <div id="bigTime" class="time">02:00</div>
        <div class="label">TIME LEFT</div>
      </div>

      <div class="ring" title="Progress ring">
        <svg id="progressSvg" width="84" height="84" viewBox="0 0 100 100" aria-hidden="true">
          <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#00f0ff"/><stop offset="1" stop-color="#ff6fb5"/></linearGradient></defs>
          <circle cx="50" cy="50" r="40" stroke="rgba(255,255,255,0.06)" stroke-width="8" fill="none"></circle>
          <circle id="progressCircle" cx="50" cy="50" r="40" stroke="url(#g1)" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="0" transform="rotate(-90 50 50)"></circle>
        </svg>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end">
        <div style="font-size:12px;color:#9aa0a6">CRYSTALS</div>
        <div id="uiCrystals" style="font-weight:900;color:var(--gold)">0</div>
      </div>

      <div class="controls" style="pointer-events:auto">
        <button id="muteBtn" class="btn small" aria-pressed="false">MUTE</button>
        <button id="pauseBtn" class="btn small" aria-pressed="false">PAUSE</button>
      </div>
    </div>
  </div>

  <!-- VIEW: CRAWL PAGE -->
  <section id="view-crawl" class="crawl-page" aria-hidden="true" role="region" aria-label="Intro crawl">
    <div class="crawl-title">TITAN OMEGA: CHRONO SYNC</div>
    <div class="crawl-sub">A friendly two‑minute brushing mission. Watch the intro, then press START to begin your 2:00 timer.</div>

    <div class="crawl-box panel" role="article" aria-label="Star crawl">
      <div id="crawlInner" class="crawl-inner" aria-hidden="false">
        <div style="font-size:20px;color:var(--gold);margin-bottom:10px">TITAN OMEGA</div>
        <p>CHRONO SYNC INITIATED. PILOT, YOU HAVE TWO MINUTES TO COMPLETE THE ORBITAL BRUSHING PROTOCOL.</p>
        <p>ALIGN THE BRUSH, MAINTAIN RHYTHM, AND SWEEP GENTLY. THIS MISSION IS FOR FUN — AND CLEAN TEETH.</p>
        <p>BRUSH THE TOP TEETH FIRST, THEN THE BOTTOM. KEEP MOVING. STAY WITH THE BEAT.</p>
        <p>READY? LET'S GO!</p>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <button id="crawlStart" class="big-btn">START MISSION</button>
      <button id="crawlSkip" class="btn ghost">SKIP INTRO</button>
    </div>

    <div style="font-size:12px;color:#9aa0a6">Tip: Press Space to tap the brush for extra sparkle.</div>
  </section>

  <!-- VIEW: GAME PAGE -->
  <section id="view-game" class="viewport" aria-hidden="true" role="region" aria-label="Game">
    <div class="canvas-wrap panel" role="application" aria-label="Game canvas area">
      <canvas id="gameCanvas" width="430" height="932" aria-label="Game canvas"></canvas>

      <!-- HUD overlay inside canvas area -->
      <div class="hud-overlay" aria-hidden="true">
        <div class="hp-wrap panel" role="progressbar" aria-label="Boss health">
          <div id="hpBar" class="hp-bar" style="width:100%"></div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div style="font-size:12px;color:#9aa0a6">STREAK</div>
          <div id="uiStreak" style="font-weight:900;color:var(--gold)">0</div>
        </div>
      </div>

      <!-- CRT & vignette -->
      <div class="vignette"></div>
      <div class="crt" aria-hidden="true"></div>

      <!-- confetti container -->
      <div id="confetti" class="confetti" aria-hidden="true"></div>
    </div>

    <!-- action row for kids -->
    <div class="action-row" style="width:100%;justify-content:center;pointer-events:auto">
      <button id="tapBtn" class="big-btn" aria-label="Tap for extra brush">TAP FOR SPARKLE</button>
      <button id="skipBtn" class="btn ghost" aria-label="Exit to intro">BACK TO INTRO</button>
    </div>

    <!-- small footer inside view -->
    <div style="position:absolute;bottom:18px;left:18px;color:#9aa0a6;font-size:13px">Space = Tap • P = Pause • M = Mute</div>
  </section>

  <!-- Footer (shared) -->
  <div class="footer">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="panel" style="padding:8px 12px;border-radius:999px">
        <div style="font-size:12px;color:#9aa0a6">PILOT</div>
        <div id="uiPilot" style="font-weight:900;color:var(--gold)">---</div>
      </div>
      <div style="color:#9aa0a6;font-size:13px">Designed for kids • Friendly feedback • 2:00 brushing</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div style="font-size:12px;color:#9aa0a6">Version</div>
      <div style="font-weight:900;color:var(--gold)">v4.1</div>
    </div>
  </div>

</div>

<!-- =========================
     SCRIPT: Game logic (modular single-file)
   ========================= -->
<script>
/* =========================
   CONFIG
   ========================= */
const CONFIG = {
  duration: 120,            // 2 minutes total
  preCountdown: 5,          // numeric countdown after crawl
  crawlDuration: 5,         // crawl animation length (seconds)
  bossHP: 1200,             // boss HP (we'll drain it over duration)
  bonusPerTap: 6,           // extra damage per tap (encourages interaction)
  limits: { particles: 200, lasers: 40 },
  canvas: { w: 430, h: 932 },
  audio: { sfxVol: 0.9 }
};

/* =========================
   STATE
   ========================= */
const state = {
  view: 'crawl',            // 'crawl' or 'game'
  active: false,
  paused: false,
  time: CONFIG.duration,
  bossHP: CONFIG.bossHP,
  crystals: parseInt(localStorage.getItem('titan_crystals')) || 0,
  streak: parseInt(localStorage.getItem('titan_streak')) || 0,
  best: parseInt(localStorage.getItem('titan_best')) || 0,
  pilot: localStorage.getItem('titan_pilot') || 'PILOT',
  lastTap: 0,
  particles: [],
  pools: { particles: [] },
  shake: 0,
  flash: 0,
  muted: false
};

/* =========================
   DOM refs & initial view
   ========================= */
const viewCrawl = document.getElementById('view-crawl');
const viewGame  = document.getElementById('view-game');
const crawlInner = document.getElementById('crawlInner');
const crawlStart = document.getElementById('crawlStart');
const crawlSkip  = document.getElementById('crawlSkip');
const tapBtn     = document.getElementById('tapBtn');
const skipBtn    = document.getElementById('skipBtn');
const muteBtn    = document.getElementById('muteBtn');
const pauseBtn   = document.getElementById('pauseBtn');
const bigTime    = document.getElementById('bigTime');
const progressCircle = document.getElementById('progressCircle');
const hpBar      = document.getElementById('hpBar');
const uiCrystals = document.getElementById('uiCrystals');
const uiPilot    = document.getElementById('uiPilot');
const uiStreak   = document.getElementById('uiStreak');
const confettiEl = document.getElementById('confetti');

/* =========================
   Canvas setup
   ========================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
canvas.width = CONFIG.canvas.w;
canvas.height = CONFIG.canvas.h;
function resizeCanvas(){
  const wrap = canvas.parentElement;
  const rect = wrap.getBoundingClientRect();
  const scale = Math.min(rect.width / canvas.width, rect.height / canvas.height);
  canvas.style.width = Math.floor(canvas.width * scale) + 'px';
  canvas.style.height = Math.floor(canvas.height * scale) + 'px';
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* =========================
   Audio (simple beeps)
   ========================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
function beep(freq=440, dur=0.06, vol=0.12){
  if(state.muted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  g.gain.value = vol * CONFIG.audio.sfxVol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}

/* =========================
   Pools: particles
   ========================= */
function createParticle(){ return { x:0,y:0,vx:0,vy:0,life:0,active:false,color:'#ffd700' }; }
function initPools(){
  for(let i=0;i<CONFIG.limits.particles;i++) state.pools.particles.push(createParticle());
}
initPools();

/* =========================
   Stars (background)
   ========================= */
const stars = [];
function initStars(){
  stars.length = 0;
  for(let i=0;i<120;i++){
    stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, v: 10 + Math.random()*60, o: 0.2 + Math.random()*0.8, s: Math.random()*2+0.5 });
  }
}
initStars();

/* =========================
   Utility helpers
   ========================= */
const rand = (a,b)=>Math.random()*(b-a)+a;
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

/* =========================
   UI helpers
   ========================= */
function setView(v){
  state.view = v;
  if(v === 'crawl'){
    viewCrawl.style.display = 'flex';
    viewGame.style.display = 'none';
  } else {
    viewCrawl.style.display = 'none';
    viewGame.style.display = 'flex';
  }
}
setView('crawl');
uiPilot.innerText = state.pilot;
uiCrystals.innerText = state.crystals;
uiStreak.innerText = state.streak;

/* =========================
   Crawl controls
   ========================= */
crawlStart.addEventListener('click', ()=> {
  // play crawl animation then numeric countdown then start game
  playCrawlThenCountdown();
});
crawlSkip.addEventListener('click', ()=> {
  // skip intro and go straight to numeric countdown
  startNumericCountdown(CONFIG.preCountdown);
});

/* play crawl animation then numeric countdown */
function playCrawlThenCountdown(){
  // ensure crawlInner restarts
  crawlInner.classList.remove('play');
  void crawlInner.offsetWidth;
  crawlInner.classList.add('play');
  // after crawlDuration seconds, start numeric countdown
  setTimeout(()=> startNumericCountdown(CONFIG.preCountdown), CONFIG.crawlDuration * 1000);
}

/* numeric countdown overlay (simple modal) */
function startNumericCountdown(seconds){
  // switch to game view but pause until countdown finishes
  setView('game');
  // show big numeric overlay in center of viewport
  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = 200;
  overlay.style.pointerEvents = 'none';
  const el = document.createElement('div');
  el.className = 'countdown-big';
  el.style.pointerEvents = 'none';
  overlay.appendChild(el);
  document.querySelector('.canvas-wrap').appendChild(overlay);

  let n = seconds;
  el.innerText = n;
  beep(880,0.08,0.12);
  const t = setInterval(()=>{
    n--;
    if(n <= 0){
      clearInterval(t);
      overlay.remove();
      startGame();
      return;
    }
    el.innerText = n;
    beep(880,0.06,0.12);
  }, 1000);
}

/* =========================
   Game start / end
   ========================= */
function startGame(){
  state.active = true;
  state.paused = false;
  state.time = CONFIG.duration;
  state.bossHP = CONFIG.bossHP;
  state.shake = 0;
  state.flash = 0;
  lastTime = performance.now();
  // update UI
  updateHUD();
  // start loop
  requestAnimationFrame(loop);
  beep(1200,0.08,0.12);
}

function victory(){
  state.active = false;
  state.streak += 1;
  state.best = Math.max(state.best, state.streak);
  state.crystals += 100;
  localStorage.setItem('titan_crystals', state.crystals);
  localStorage.setItem('titan_streak', state.streak);
  localStorage.setItem('titan_best', state.best);
  // show confetti and friendly message
  showConfetti();
  alert(`Mission complete! +100 crystals\nStreak: ${state.streak}`);
  // return to crawl page for replay
  setView('crawl');
  updateHUD();
}

function fail(){
  state.active = false;
  state.streak = 0;
  localStorage.setItem('titan_streak', state.streak);
  alert('Time up! Try again to keep your streak.');
  setView('crawl');
  updateHUD();
}

/* =========================
   Tap / input (encourage interaction)
   ========================= */
tapBtn.addEventListener('click', ()=> { tapAction(); });
skipBtn.addEventListener('click', ()=> { setView('crawl'); });

window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ e.preventDefault(); if(state.active && !state.paused) tapAction(); }
  if(e.key === 'p' || e.key === 'P'){ togglePause(); }
  if(e.key === 'm' || e.key === 'M'){ toggleMute(); }
});

function tapAction(){
  // small bonus damage and visual feedback
  if(!state.active) return;
  const now = performance.now();
  if(now - state.lastTap < 120) return; // simple debounce so taps feel meaningful
  state.lastTap = now;
  // bonus damage applied immediately
  state.bossHP -= CONFIG.bonusPerTap;
  spawnImpact(canvas.width/2, canvas.height*0.35, 8);
  state.shake = Math.min(18, state.shake + 8);
  beep(1400,0.03,0.08);
  updateHUD();
}

/* =========================
   Pause / mute
   ========================= */
muteBtn.addEventListener('click', toggleMute);
pauseBtn.addEventListener('click', togglePause);

function toggleMute(){
  state.muted = !state.muted;
  muteBtn.innerText = state.muted ? 'UNMUTE' : 'MUTE';
  muteBtn.setAttribute('aria-pressed', String(state.muted));
}
function togglePause(){
  if(!state.active) return;
  state.paused = !state.paused;
  pauseBtn.innerText = state.paused ? 'RESUME' : 'PAUSE';
  pauseBtn.setAttribute('aria-pressed', String(state.paused));
  beep(state.paused ? 220 : 660, 0.06, 0.06);
}

/* =========================
   Particles (pooling)
   ========================= */
function spawnParticle(x,y,vx,vy,life=0.9,color='#ffd700'){
  const pool = state.pools.particles;
  for(let i=0;i<pool.length;i++){
    const p = pool[i];
    if(!p.active){
      p.active = true;
      p.x = x; p.y = y; p.vx = vx; p.vy = vy; p.life = life; p.color = color;
      state.particles.push(p);
      return p;
    }
  }
  // fallback: create new if pool exhausted (rare)
  const p = createParticle();
  p.active = true; p.x=x; p.y=y; p.vx=vx; p.vy=vy; p.life=life; p.color=color;
  state.particles.push(p);
  return p;
}
function despawnParticle(p){
  p.active = false;
  const idx = state.particles.indexOf(p);
  if(idx >= 0) state.particles.splice(idx,1);
}

/* spawn impact */
function spawnImpact(x,y,amount=6){
  for(let i=0;i<amount;i++){
    const vx = rand(-160,160);
    const vy = rand(-160,160);
    spawnParticle(x + rand(-6,6), y + rand(-6,6), vx, vy, 0.6 + Math.random()*0.6, '#ffd700');
  }
}

/* =========================
   Confetti (simple)
   ========================= */
function showConfetti(){
  confettiEl.innerHTML = '';
  const count = 40;
  for(let i=0;i<count;i++){
    const d = document.createElement('div');
    d.style.position = 'absolute';
    d.style.left = (50 + rand(-40,40)) + '%';
    d.style.top = '-10%';
    d.style.width = (6 + Math.random()*8) + 'px';
    d.style.height = (10 + Math.random()*12) + 'px';
    d.style.background = ['#ffd700','#00f0ff','#ff6fb5','#7cff6b'][Math.floor(Math.random()*4)];
    d.style.opacity = '0.95';
    d.style.transform = `rotate(${rand(0,360)}deg)`;
    d.style.borderRadius = '2px';
    confettiEl.appendChild(d);
    // animate via JS
    const fall = () => {
      const start = performance.now();
      const dur = 1600 + Math.random()*1200;
      const sx = parseFloat(d.style.left);
      const tx = sx + rand(-20,20);
      function frame(t){
        const p = (t - start) / dur;
        if(p >= 1){ d.remove(); return; }
        d.style.top = (p*120) + '%';
        d.style.left = (sx + (tx - sx) * p) + '%';
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    };
    setTimeout(fall, Math.random()*200);
  }
  // clear after a while
  setTimeout(()=> confettiEl.innerHTML = '', 4000);
}

/* =========================
   HUD update (timer, progress ring, hp bar)
   ========================= */
function updateHUD(){
  // timer text
  const m = Math.floor(state.time / 60);
  const s = Math.floor(state.time % 60);
  bigTime.innerText = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

  // progress ring (time left)
  const total = CONFIG.duration;
  const pct = clamp(state.time / total, 0, 1);
  const circumference = 2 * Math.PI * 40; // r=40
  const dash = circumference * (1 - pct);
  progressCircle.style.strokeDashoffset = dash;

  // hp bar width (bossHP relative to CONFIG.bossHP)
  const hpPct = clamp(state.bossHP / CONFIG.bossHP, 0, 1);
  hpBar.style.width = (hpPct * 100) + '%';

  // crystals & streak
  uiCrystals.innerText = state.crystals;
  uiStreak.innerText = state.streak;
  document.getElementById('uiPilot').innerText = state.pilot;
}

/* =========================
   Update loop: boss HP drains over time
   ========================= */
let lastTime = performance.now();
function loop(now){
  const dt = Math.min(0.033, (now - lastTime) / 1000);
  lastTime = now;
  if(state.active && !state.paused){
    // boss HP drains continuously so that full HP is removed over CONFIG.duration
    const drainPerSec = CONFIG.bossHP / CONFIG.duration;
    state.bossHP -= drainPerSec * dt; // base drain
    // clamp
    if(state.bossHP <= 0){
      state.bossHP = 0;
      updateHUD();
      victory();
      return;
    }

    // time decrement
    state.time -= dt;
    if(state.time <= 0){
      state.time = 0;
      // if bossHP > 0 at end, fail; otherwise victory already handled
      if(state.bossHP > 0){
        updateHUD();
        fail();
        return;
      }
    }

    // stars movement
    const starSpeed = 1 + (1 - state.time / CONFIG.duration) * 1.2;
    for(const s of stars){
      s.y += s.v * dt * (starSpeed * 0.02);
      if(s.y > canvas.height) s.y = -2;
    }

    // particles update
    for(let i = state.particles.length - 1; i >= 0; i--){
      const p = state.particles[i];
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += 220 * dt;
      p.life -= dt;
      if(p.life <= 0) despawnParticle(p);
    }

    // shake & flash decay
    state.shake *= 0.92;
    state.flash = Math.max(0, state.flash - dt * 1.6);

    // update HUD
    updateHUD();

    // render
    render();
  } else {
    // still render paused or idle view so canvas doesn't go blank
    render();
  }

  requestAnimationFrame(loop);
}

/* =========================
   RENDER: stars, boss, particles, glow, CRT lines
   ========================= */
function render(){
  // clear
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // apply subtle vignette via global composite (we also have CSS vignette)
  // starfield
  for(const s of stars){
    ctx.fillStyle = `rgba(180,220,255,${s.o})`;
    ctx.fillRect(Math.floor(s.x), Math.floor(s.y), Math.ceil(s.s), Math.ceil(s.s));
  }

  // boss (center top)
  const bx = canvas.width / 2;
  const by = canvas.height * 0.35;
  const bw = 160;
  const bh = 160;
  // glow
  const hpPct = clamp(state.bossHP / CONFIG.bossHP, 0, 1);
  const glowAlpha = 0.12 + (1 - hpPct) * 0.6;
  ctx.save();
  ctx.translate(bx, by);
  // outer glow
  const g = ctx.createRadialGradient(0,0,bw*0.2, 0,0,bw*1.2);
  g.addColorStop(0, `rgba(255,120,80,${glowAlpha})`);
  g.addColorStop(0.6, 'rgba(255,120,80,0.06)');
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(0,0,bw*0.9,0,Math.PI*2);
  ctx.fill();

  // boss body (rounded)
  ctx.fillStyle = '#222';
  roundRect(ctx, -bw/2, -bh/2, bw, bh, 18);
  ctx.fill();

  // core that grows as HP drops (encouraging visual)
  ctx.fillStyle = `rgba(255,255,255,${0.9 - hpPct*0.6})`;
  ctx.beginPath();
  ctx.arc(0, 0, 18 + (1 - hpPct) * 18, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();

  // lasers (visual streaks when tapping)
  // draw particles
  for(const p of state.particles){
    ctx.globalAlpha = clamp(p.life, 0, 1);
    ctx.fillStyle = p.color;
    ctx.fillRect(Math.round(p.x), Math.round(p.y), 3, 3);
    ctx.globalAlpha = 1;
  }

  // screen flash if any
  if(state.flash > 0){
    ctx.fillStyle = `rgba(255,255,255,${state.flash * 0.08})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // CRT scanlines (drawn on canvas for stronger effect)
  ctx.fillStyle = 'rgba(255,255,255,0.02)';
  for(let y=0;y<canvas.height;y+=3){
    ctx.fillRect(0,y,canvas.width,1);
  }
}

/* helper roundRect */
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

/* =========================
   Start loop when user begins game
   ========================= */
let started = false;
let lastTime = performance.now();

/* =========================
   Expose small debug helpers
   ========================= */
window.__TITAN = {
  state,
  spawnImpact,
  startGame,
  setView
};

/* =========================
   Initialize UI and listeners
   ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // set pilot name display
  document.getElementById('uiPilot').innerText = state.pilot;
  // initial view based on hash
  if(location.hash === '#game') setView('game'); else setView('crawl');
  // ensure canvas scaled
  resizeCanvas();
  // initial render
  render();
});

/* =========================
   Start the animation loop only when game starts
   ========================= */
/* (loop is started by startGame) */

/* =========================
   Small accessibility: focus outlines
   ========================= */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Tab') document.body.classList.add('show-focus');
});

/* =========================
   Save pilot name when leaving crawl (optional)
   ========================= */
document.getElementById('crawlStart').addEventListener('click', ()=>{
  // prompt for pilot name (simple)
  const name = prompt('Pilot name (optional):', state.pilot) || state.pilot;
  state.pilot = name.toUpperCase().slice(0,20);
  localStorage.setItem('titan_pilot', state.pilot);
  document.getElementById('uiPilot').innerText = state.pilot;
});

/* =========================
   End of script
   ========================= */
</script>
</body>
</html>
