<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EXO-BRUSH: OMEGA EDITION</title>
    <style>
        :root { --b: #081820; --g1: #306230; --g2: #8bac0f; --g3: #9bbc0f; --a: #ff4500; --gold: #ffd700; }
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; height: 100vh; font-family: 'Courier New', monospace; touch-action: none; }
        #wrap { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        canvas { background: var(--b); image-rendering: pixelated; width: 100%; height: 100%; max-width: 430px; aspect-ratio: 9/19.5; }
        
        /* Hardware CRT Filter */
        .crt::after { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%), linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03)); background-size: 100% 3px, 3px 100%; z-index: 10; }

        #overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; background: rgba(0,0,0,0.9); color: var(--g3); transition: 0.5s; text-align: center; }
        .p-gate { position: absolute; bottom: 0; right: 0; width: 60px; height: 60px; z-index: 100; opacity: 0; }
        .btn-ready { padding: 20px 40px; background: var(--g1); border: 4px solid var(--g3); color: #fff; font-size: 24px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 20px; }
    </style>
</head>
<body>

<div id="wrap" class="crt">
    <canvas id="c"></canvas>
    <div id="overlay">
        <div style="letter-spacing: 5px;">SYNCING PILOT...</div>
        <div id="count" style="font-size: 120px; font-weight: 900; color: #fff;">READY</div>
        <button class="btn-ready" onclick="ignite()">Engage Link</button>
    </div>
    <div class="p-gate" ontouchstart="gate()"></div>
</div>

<script>
/**
 * OMEGA ENGINE: High-Fidelity 16-bit Renderer
 */
const cv = document.getElementById('c');
const ctx = cv.getContext('2d');
const ov = document.getElementById('overlay');
const ct = document.getElementById('count');

let s = { active: false, t: 120, f: 0, sk: 0, sh: 0, cry: parseInt(localStorage.getItem('gba_crystals_v1')) || 0, str: parseInt(localStorage.getItem('gba_streak_v1')) || 0, combo: 0, p: [] };
const PAL = ['transparent', '#081820', '#306230', '#8bac0f', '#9bbc0f', '#ff4500', '#ffd700', '#fff'];

let audio;
const beep = (f, t, d, v=0.1) => {
    if(!audio) return;
    const o = audio.createOscillator(); const g = audio.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
    g.gain.setValueAtTime(v, audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + d);
    o.connect(g); g.connect(audio.destination);
    o.start(); o.stop(audio.currentTime + d);
};

function ignite() {
    audio = new (window.AudioContext || window.webkitAudioContext)();
    document.querySelector('.btn-ready').style.display = 'none';
    let n = 5;
    const t = setInterval(() => {
        ct.innerText = n; beep(400 + (5-n)*50, 'square', 0.2); n--;
        if(n < 0) {
            clearInterval(t); ov.style.opacity = '0';
            setTimeout(() => ov.style.display = 'none', 500);
            s.active = true; cv.width = 430; cv.height = 932;
            requestAnimationFrame(loop);
        }
    }, 1000);
}

const part = (x, y, c, v, n) => {
    for(let i=0; i<n; i++) s.p.push({ x, y, vx: (Math.random()-0.5)*v, vy: (Math.random()-0.5)*v, l: 1, c });
};

function drawTitan() {
    const stage = Math.min(3, Math.floor((120-s.t)/30));
    const x = 215 + Math.sin(s.f*0.02)*20, y = 250 + Math.cos(s.f*0.01)*10;
    ctx.fillStyle = [PAL[3], PAL[4], PAL[5], '#900'][stage];
    ctx.beginPath(); ctx.arc(x, y, 100 - (stage*5), 0, Math.PI*2); ctx.fill();
    if(stage > 1 && s.f%10==0) part(x, y, PAL[7], 5, 2);
}

function loop() {
    if(!s.active) return;
    s.f++; if(s.f%60==0) s.t--;
    if(s.sk > 0) s.sk *= 0.9;

    ctx.fillStyle = PAL[1]; ctx.fillRect(0,0,cv.width,cv.height);
    
    // Parallax Starfield
    for(let i=1; i<4; i++){
        ctx.fillStyle = `rgba(139, 172, 15, ${0.1*i})`;
        for(let j=0; j<15; j++){
            let y = (j*70 + s.f*i*0.5) % cv.height;
            ctx.fillRect((j*33)%cv.width, y, 3, 3);
        }
    }

    ctx.save();
    if(s.sk > 1) ctx.translate((Math.random()-0.5)*s.sk, (Math.random()-0.5)*s.sk);
    drawTitan();
    
    // Hero + Fire
    const hY = 700 + Math.sin(s.f*0.05)*20;
    ctx.fillStyle = PAL[4]; ctx.fillRect(180, hY, 70, 80);
    ctx.fillStyle = '#0ff'; ctx.fillRect(195, hY+10, 40, 20);
    
    if(s.f%20==0) { 
        s.sh++; s.sk = 12; s.combo++;
        beep(100, 'sawtooth', 0.1, 0.05);
        part(215, hY, '#fff', 10, 5);
    }

    // Particles
    s.p.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.l -= 0.02;
        ctx.globalAlpha = p.l; ctx.fillStyle = p.c;
        ctx.fillRect(p.x, p.y, 4, 4);
        if(p.l <= 0) s.p.splice(i, 1);
    });
    ctx.restore(); ctx.globalAlpha = 1;

    // HUD
    ctx.fillStyle = '#fff'; ctx.font = "900 24px 'Courier New'";
    ctx.fillText(`SYNC: ${Math.max(0, s.t)}s`, 30, 60);
    ctx.fillStyle = PAL[6]; ctx.fillText(`CRYSTALS: ${s.cry}`, 30, 95);
    if(s.combo > 5) {
        ctx.fillStyle = PAL[5]; ctx.font = "900 40px 'Courier New'";
        ctx.fillText(`COMBO x${s.combo}`, 230, 150);
    }

    if(s.t <= 0) finish(); else requestAnimationFrame(loop);
}

function finish() {
    s.active = false; beep(50, 'sawtooth', 3, 0.5);
    part(215, 250, '#fff', 40, 500);
    setTimeout(() => {
        const e = Math.floor(s.sh/6) + (s.str*5);
        s.cry += e; s.str++;
        localStorage.setItem('gba_crystals_v1', s.cry);
        localStorage.setItem('gba_streak_v1', s.str);
        ov.style.display = 'flex'; ov.style.opacity = '1';
        ct.innerText = "TITAN FALLEN"; ct.style.fontSize = "40px";
        document.querySelector('div[style*="letter-spacing"]').innerText = `+${e} CRYSTALS SYNCED`;
    }, 1000);
}

let gt = 0; function gate() {
    gt++; if(gt >= 5) {
        const p = prompt("PIN:"); if(p==="1234") {
            s.cry = parseInt(prompt("Crystals:", s.cry));
            localStorage.setItem('gba_crystals_v1', s.cry); location.reload();
        } gt=0;
    }
}
</script>
</body>
</html>
