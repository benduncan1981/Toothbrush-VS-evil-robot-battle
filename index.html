<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>TITAN OMEGA â€” CHRONO SYNC (Cockpit POV)</title>
<style>
  :root{
    --bg-deep:#020617;
    --bg-mid:#041026;
    --film-yellow:#FFE08A;
    --rim-cyan:#00F0FF;
    --core-pink:#FF3FB5;
    --metal:#0b1220;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;background:var(--bg-mid);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased;}
  body{display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);overflow:hidden;}
  #app{width:100%;max-width:430px;height:100%;max-height:932px;border-radius:12px;overflow:hidden;position:relative;background:linear-gradient(180deg,var(--bg-deep) 0%, var(--bg-mid) 100%);box-shadow:0 18px 40px rgba(0,0,0,0.6)}
  /* canvases stacked */
  #screenWrap{position:relative;width:100%;height:100%}
  canvas.layer{position:absolute;left:0;top:0;width:100%;height:100%;display:block}
  canvas#bg{z-index:10}
  canvas#battle{z-index:20}
  canvas#bloom{z-index:25;pointer-events:none}
  canvas#hud{z-index:40;pointer-events:none}
  canvas#cockpit{z-index:50;pointer-events:none}
  canvas#halftone{z-index:79;pointer-events:none;opacity:0.18}
  canvas#grain{z-index:80;pointer-events:none;opacity:0.06}

  /* UI overlay */
  .ui{position:absolute;left:0;right:0;top:0;padding:12px;display:flex;flex-direction:column;align-items:center;z-index:90;pointer-events:none}
  .topRow{width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;pointer-events:auto}
  .statBox{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:flex;gap:8px;align-items:center;font-weight:800;color:#fff}
  .bigTimer{font-size:40px;font-weight:900;letter-spacing:1px;display:flex;align-items:center;gap:10px}
  .timerSubtitle{font-size:10px;opacity:0.9;margin-top:-6px;text-align:center}
  #controls{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:center;gap:12px;pointer-events:auto;z-index:95}
  .btn{background:linear-gradient(180deg,#0ff 0%, #7afcff 100%);border-radius:12px;padding:10px 14px;font-weight:900;color:#041026;border:2px solid rgba(0,0,0,0.35);font-size:14px;min-width:96px;text-align:center;user-select:none;touch-action:manipulation}
  .btn.secondary{background:linear-gradient(180deg,var(--core-pink) 0%, #ff8fc9 100%);color:#041026}
  .btn.ghost{background:transparent;border:2px dashed rgba(255,255,255,0.06);color:#fff}
  .btn[aria-disabled="true"],.btn.disabled{opacity:0.35;pointer-events:none}
  /* holo crawl (inside cockpit) */
  .holo{position:absolute;left:50%;transform:translateX(-50%);bottom:18%;width:86%;max-width:380px;z-index:60;color:var(--film-yellow);font-weight:800;line-height:1.6;text-align:center;pointer-events:none}
  .letterbox{position:absolute;left:0;right:0;height:12%;background:#000;z-index:99;pointer-events:none;opacity:0;transition:opacity 260ms}
  .letterbox.top{top:0}
  .letterbox.bottom{bottom:0}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (max-width:420px){ .bigTimer{font-size:32px} .btn{min-width:84px;padding:8px 10px;font-size:13px} }
</style>
</head>
<body>
<div id="app" role="application" aria-label="Titan Omega Chrono Sync cockpit">
  <div id="screenWrap">
    <canvas id="bg" class="layer" width="430" height="932"></canvas>
    <canvas id="battle" class="layer" width="430" height="932"></canvas>
    <canvas id="bloom" class="layer" width="430" height="932"></canvas>
    <canvas id="hud" class="layer" width="430" height="932"></canvas>
    <canvas id="cockpit" class="layer" width="430" height="932"></canvas>
    <canvas id="halftone" class="layer" width="430" height="932"></canvas>
    <canvas id="grain" class="layer" width="430" height="932"></canvas>

    <div class="letterbox top" id="letterboxTop" aria-hidden="true"></div>
    <div class="letterbox bottom" id="letterboxBottom" aria-hidden="true"></div>

    <div class="holo" id="holoCrawl" aria-hidden="false">
      <div style="font-size:18px;margin-bottom:8px">PROLOGUE</div>
      <div id="crawlText" style="font-size:14px;opacity:0.95;line-height:1.6">
        THE ORBITING TITAN OMEGA HAS RUPTURED THE CHRONO GRID.<br>
        A LONE PILOT MUST SYNC THE CHRONO CORE BEFORE THE ORBIT COLLAPSES.<br>
        SUIT UP. TWO MINUTES OF STEADY RHYTHM WILL RESTORE THE CORE AND BRING THE TITAN DOWN.<br>
        THIS IS YOUR MISSION. THIS IS YOUR MOMENT.
      </div>
    </div>
  </div>

  <div class="ui" aria-hidden="false">
    <div class="topRow">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="statBox"><div style="font-size:18px">ðŸ’Ž</div><div><div style="font-size:12px;opacity:0.9">CRYSTALS</div><div id="crystals" style="font-size:16px">0</div></div></div>
        <div class="statBox"><div style="font-size:12px;opacity:0.9">CALLSIGN</div><div id="pilotName" style="font-weight:900">â€”</div></div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:center">
        <div class="bigTimer" role="timer" aria-live="assertive" aria-atomic="true">
          <div id="timerText">02:00</div>
        </div>
        <div class="timerSubtitle">CHRONO SYNC</div>
      </div>

      <div class="statBox"><div style="font-size:18px">ðŸ”¥</div><div><div style="font-size:12px;opacity:0.9">STREAK</div><div id="streak" style="font-size:16px">0</div></div></div>
    </div>
  </div>

  <div id="controls">
    <button id="tapBtn" class="btn ghost" aria-label="Diagnostics">DIAGNOSTICS</button>
    <button id="startBtn" class="btn" aria-label="Engage">ENGAGE</button>
    <button id="pauseBtn" class="btn secondary" aria-label="Hold">HOLD</button>
    <button id="backBtn" class="btn ghost" aria-label="Return">RETURN</button>
    <button id="muteBtn" class="btn ghost" aria-label="Silence">SILENCE</button>
    <button id="skipBtn" class="btn ghost" aria-label="Skip count">SKIP</button>
  </div>

  <div style="position:absolute;left:12px;bottom:12px;font-size:12px;opacity:0.9;z-index:95">CALLSIGN: <span id="pilotFooter">â€”</span></div>

  <div style="position:absolute;top:12px;right:12px;z-index:95;pointer-events:auto">
    <input id="pilotInput" placeholder="ENTER CALLSIGN" style="padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-weight:700" />
  </div>
</div>

<script>
/* Final polished single-file cockpit POV game
   - Single set of canvases
   - Safe DOM init
   - Deterministic 120s drain
   - Slow holo crawl, countdown, main session, final explosion
   - Grain & halftone overlays throttled
   - Lightweight procedural audio (optional)
*/

/* CONFIG */
const CONFIG = {
  W: 430, H: 932,
  titleHold: 1.2,
  crawlDuration: 18,
  preCountdown: 5,
  duration: 120,
  bossMaxHP: 100,
  grainHz: 10,
  maxParticles: 220,
  maxDebris: 140,
  starCount: 160
};

/* STATE */
const STATE = {
  running: false,
  brushing: false,
  paused: false,
  mute: false,
  lastTime: 0,
  bossHP: CONFIG.bossMaxHP,
  crystals: 0,
  streak: 0,
  pilot: '',
  countdown: CONFIG.preCountdown,
  crawlPlaying: false,
  reducedMotion: false,
  drainPerSecond: CONFIG.bossMaxHP / CONFIG.duration,
  mainStart: 0,
  gauge: 1.0,
  cameraShake: 0,
  dolly: 1.0
};

/* DOM & CANVAS refs */
let bg, battle, bloom, hud, cockpit, grain, halftone;
let bgCtx, battleCtx, bloomCtx, hudCtx, cockpitCtx, grainCtx, halftoneCtx;
let timerTextEl, crystalsEl, streakEl, pilotNameEl, pilotFooterEl;
let pilotInputEl, startBtn, pauseBtn, tapBtn, backBtn, muteBtn, skipBtn, holoCrawlEl, letterboxTop, letterboxBottom;

/* Visual pools */
const particles = [];
const debris = [];
const sparkles = [];

/* Audio */
let audioCtx = null, masterGain = null;
function ensureAudio(){
  if(audioCtx) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = STATE.mute ? 0 : 1;
    masterGain.connect(audioCtx.destination);
  }catch(e){ audioCtx = null; }
}
function playTone(freq, dur=0.08, type='sine', vol=0.08){
  if(!audioCtx || STATE.mute) return;
  const t = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = 0.0001;
  o.connect(g); g.connect(masterGain);
  o.start(t);
  g.gain.exponentialRampToValueAtTime(vol, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  o.stop(t + dur + 0.02);
}

/* Utilities */
const $ = id => document.getElementById(id);
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
const now = () => performance.now()/1000;
const fmt = s => { s = Math.max(0, Math.floor(s)); return String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0'); };

/* Minimal starfield and scorch state */
const stars = [];
const TITAN_scorch = [];
let HERO_hands = 0;
let threshold75=false, threshold50=false, threshold25=false;

/* DOMContentLoaded init */
document.addEventListener('DOMContentLoaded', () => {
  // canvases
  bg = $('bg'); battle = $('battle'); bloom = $('bloom'); hud = $('hud'); cockpit = $('cockpit'); grain = $('grain'); halftone = $('halftone');
  bgCtx = bg.getContext('2d'); battleCtx = battle.getContext('2d'); bloomCtx = bloom.getContext('2d');
  hudCtx = hud.getContext('2d'); cockpitCtx = cockpit.getContext('2d'); grainCtx = grain.getContext('2d'); halftoneCtx = halftone.getContext('2d');

  // elements
  timerTextEl = $('timerText'); crystalsEl = $('crystals'); streakEl = $('streak'); pilotNameEl = $('pilotName'); pilotFooterEl = $('pilotFooter');
  pilotInputEl = $('pilotInput'); startBtn = $('startBtn'); pauseBtn = $('pauseBtn'); tapBtn = $('tapBtn'); backBtn = $('backBtn'); muteBtn = $('muteBtn'); skipBtn = $('skipBtn');
  holoCrawlEl = $('holoCrawl'); letterboxTop = $('letterboxTop'); letterboxBottom = $('letterboxBottom');

  // wire controls
  startBtn.addEventListener('click', startPrecountdown);
  tapBtn.addEventListener('click', handleTap);
  pauseBtn.addEventListener('click', togglePause);
  backBtn.addEventListener('click', ()=> { /* simple return to intro: reset */ resetToIntro(); });
  muteBtn.addEventListener('click', ()=> { STATE.mute = !STATE.mute; if(masterGain) masterGain.gain.value = STATE.mute ? 0 : 1; updateMuteUI(); });
  skipBtn.addEventListener('click', skipCountdownOrCrawl);
  pilotInputEl.addEventListener('input', ()=> { STATE.pilot = pilotInputEl.value.trim().slice(0,20); pilotNameEl.textContent = STATE.pilot || 'â€”'; pilotFooterEl.textContent = STATE.pilot || 'â€”'; localStorage.setItem('titan_pilot', STATE.pilot); });

  // load persisted
  STATE.crystals = JSON.parse(localStorage.getItem('titan_crystals') || '0');
  STATE.streak = JSON.parse(localStorage.getItem('titan_streak') || '0');
  STATE.pilot = localStorage.getItem('titan_pilot') || '';
  STATE.mute = JSON.parse(localStorage.getItem('titan_mute') || 'false');
  pilotInputEl.value = STATE.pilot;
  pilotNameEl.textContent = STATE.pilot || 'â€”';
  pilotFooterEl.textContent = STATE.pilot || 'â€”';
  updateUI();

  // canvas logical size
  [bg,battle,bloom,hud,cockpit,grain,halftone].forEach(c => { c.width = CONFIG.W; c.height = CONFIG.H; });

  // prepare starfield
  for(let i=0;i<CONFIG.starCount;i++) stars.push({x:Math.random()*CONFIG.W,y:Math.random()*CONFIG.H,z:Math.random(),size:Math.random()*2+0.5,speed:10+Math.random()*120});

  // halftone & grain
  drawHalftone();
  setInterval(drawGrain, 1000 / CONFIG.grainHz);

  // start loop
  STATE.lastTime = performance.now();
  requestAnimationFrame(loop);

  // small convenience: start intro crawl shortly
  setTimeout(()=> startIntroFlow(), 300);
});

/* UI helpers */
function updateUI(){
  timerTextEl.textContent = fmt(CONFIG.duration);
  crystalsEl.textContent = STATE.crystals;
  streakEl.textContent = STATE.streak;
  updateMuteUI();
}
function updateMuteUI(){ muteBtn.textContent = STATE.mute ? 'SOUND ON' : 'SILENCE'; localStorage.setItem('titan_mute', JSON.stringify(STATE.mute)); }

/* Crawl & title */
function startIntroFlow(){
  ensureAudio();
  letterboxTop.style.opacity = '1'; letterboxBottom.style.opacity = '1';
  setTimeout(()=> {
    holoCrawlEl.style.transition = `transform ${CONFIG.crawlDuration}s cubic-bezier(.2,.8,.2,1), opacity 300ms`;
    holoCrawlEl.style.transform = 'translateY(-260%)';
    holoCrawlEl.style.opacity = '1';
    STATE.crawlPlaying = true;
    if(audioCtx && !STATE.mute) playTone(1200,0.12,'sawtooth',0.08);
    setTimeout(()=> {
      STATE.crawlPlaying = false;
      letterboxTop.style.opacity = '0'; letterboxBottom.style.opacity = '0';
      startPrecountdown();
    }, CONFIG.crawlDuration * 1000);
  }, CONFIG.titleHold * 1000);
}

/* Pre-countdown */
let countdownTimer = null;
function startPrecountdown(){
  ensureAudio();
  STATE.countdown = CONFIG.preCountdown;
  let t = Math.ceil(STATE.countdown);
  if(audioCtx && !STATE.mute) playTone(880,0.12,'sine');
  clearInterval(countdownTimer);
  countdownTimer = setInterval(()=> {
    t--;
    if(t > 0){
      if(audioCtx && !STATE.mute) playTone(880 - (t*40), 0.12, 'square');
    } else {
      clearInterval(countdownTimer);
      if(audioCtx && !STATE.mute) playTone(1200,0.18,'sawtooth');
      startMainTimer();
    }
  }, 1000);
}

/* Skip */
function skipCountdownOrCrawl(){
  if(STATE.crawlPlaying){
    STATE.crawlPlaying = false;
    holoCrawlEl.style.transition = 'none';
    holoCrawlEl.style.transform = 'translateY(-260%)';
    letterboxTop.style.opacity = '0'; letterboxBottom.style.opacity = '0';
    startPrecountdown();
  } else if(STATE.brushing && STATE.countdown > 0){
    clearInterval(countdownTimer);
    startMainTimer();
  }
}

/* Main timer start */
function startMainTimer(){
  STATE.bossHP = CONFIG.bossMaxHP;
  STATE.drainPerSecond = CONFIG.bossMaxHP / CONFIG.duration;
  STATE.mainStart = now();
  STATE.running = true;
  STATE.brushing = true;
  STATE.paused = false;
  updateUI();
}

/* Pause toggle */
function togglePause(){
  if(!STATE.running) return;
  STATE.paused = !STATE.paused;
  pauseBtn.textContent = STATE.paused ? 'REENGAGE' : 'HOLD';
}

/* Diagnostics tap */
function handleTap(){
  if(STATE.brushing) return;
  spawnSparkle(Math.random()*CONFIG.W, CONFIG.H*0.6 + Math.random()*CONFIG.H*0.2);
  if(audioCtx && !STATE.mute) playTone(1400,0.06,'sawtooth');
}

/* Update loop logic */
function update(dt){
  dt = clamp(dt, 0, 0.05);

  // stars
  for(const s of stars){ s.y += s.speed * dt; if(s.y > CONFIG.H + 10){ s.y = -10; s.x = Math.random()*CONFIG.W; s.z = Math.random(); } }

  // hero hands subtle (visual only)
  HERO_hands += (STATE.brushing ? 0.02 : -0.02) * dt * 60;

  // main deterministic drain
  if(STATE.running && STATE.brushing && !STATE.paused){
    STATE.bossHP -= STATE.drainPerSecond * dt;
    if(STATE.bossHP <= 0){ STATE.bossHP = 0; endBrushing(true); }
    else {
      const pct = STATE.bossHP / CONFIG.bossMaxHP;
      if(pct < 0.75 && !threshold75){ threshold75 = true; spawnDebrisBurst(14); if(audioCtx && !STATE.mute) playTone(660,0.12,'triangle'); }
      if(pct < 0.5 && !threshold50){ threshold50 = true; spawnDebrisBurst(18); if(audioCtx && !STATE.mute) playTone(520,0.12,'triangle'); }
      if(pct < 0.25 && !threshold25){ threshold25 = true; spawnDebrisBurst(26); if(audioCtx && !STATE.mute) playTone(420,0.12,'triangle'); }
    }
    if(STATE.bossHP / CONFIG.bossMaxHP < 0.3 && !STATE.reducedMotion) STATE.dolly = clamp(STATE.dolly + dt*0.006, 1.0, 1.06);
    else STATE.dolly = clamp(STATE.dolly - dt*0.01, 1.0, 1.06);
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.life-=dt; if(p.life<=0){particles.splice(i,1);continue;} p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=160*dt; p.rot+=p.rotV*dt; }
  for(let i=debris.length-1;i>=0;i--){ const d=debris[i]; d.life-=dt; if(d.life<=0){debris.splice(i,1);continue;} d.x+=d.vx*dt; d.y+=d.vy*dt; d.vy+=160*dt; d.rot+=d.rotV*dt; }
  for(let i=sparkles.length-1;i>=0;i--){ const s=sparkles[i]; s.age+=dt; if(s.age>=s.life){sparkles.splice(i,1);continue;} if(Math.random()<0.14) spawnParticle(s.x+(Math.random()-0.5)*8,s.y+(Math.random()-0.5)*8,(Math.random()-0.5)*120,(Math.random()-0.8)*-80,0.4+Math.random()*0.6,1+Math.random()*2,'#fff'); }

  // gauge smoothing
  const target = STATE.bossHP / CONFIG.bossMaxHP;
  STATE.gauge += (target - STATE.gauge) * clamp(dt*6, 0, 1);
}

/* End brushing */
function endBrushing(victory){
  STATE.running = false; STATE.brushing = false;
  if(victory){
    STATE.crystals += 5; STATE.streak += 1;
    localStorage.setItem('titan_crystals', JSON.stringify(STATE.crystals));
    localStorage.setItem('titan_streak', JSON.stringify(STATE.streak));
    if(audioCtx && !STATE.mute) finalNuke();
    triggerFinal();
  } else {
    STATE.streak = 0; localStorage.setItem('titan_streak', JSON.stringify(STATE.streak));
  }
  updateUI();
}

/* Final explosion */
let finalState = {active:false,t:0,phase:0};
function triggerFinal(){
  finalState = {active:true,t:0,phase:0};
  spawnDebrisBurst(220);
}
function finalNuke(){
  if(!audioCtx || STATE.mute) return;
  const t = audioCtx.currentTime;
  const sub = audioCtx.createOscillator(); sub.type='sine'; sub.frequency.value=60;
  const sg = audioCtx.createGain(); sg.gain.value=0.0001; sub.connect(sg); sg.connect(masterGain);
  sub.start(t); sg.gain.exponentialRampToValueAtTime(0.28, t+0.12); sg.gain.exponentialRampToValueAtTime(0.0001, t+2.2); sub.stop(t+2.3);
}

/* Spawn helpers */
function spawnParticle(x,y,vx,vy,life,size,color){ if(particles.length>=CONFIG.maxParticles) return; particles.push({x,y,vx,vy,life,maxLife:life,size,color,rot:Math.random()*Math.PI*2,rotV:(Math.random()-0.5)*6}); }
function spawnDebris(x,y,vx,vy,life,size,color){ if(debris.length>=CONFIG.maxDebris) return; debris.push({x,y,vx,vy,life,maxLife:life,size,color,rot:Math.random()*Math.PI*2,rotV:(Math.random()-0.5)*6,shape:Math.floor(Math.random()*3)}); }
function spawnSparkle(x,y){ if(sparkles.length>=120) return; sparkles.push({x,y,age:0,life:0.6+Math.random()*0.8,size:6+Math.random()*8,angle:Math.random()*Math.PI*2}); }
function spawnDebrisBurst(n){ for(let i=0;i<n;i++){ const ang=Math.random()*Math.PI*2; const spd=120+Math.random()*420; spawnDebris(CONFIG.W*0.5+(Math.random()-0.5)*120, CONFIG.H*0.45+(Math.random()-0.5)*80, Math.cos(ang)*spd, Math.sin(ang)*spd-40, 0.8+Math.random()*1.6, 6+Math.random()*12, '#cfcfcf'); } }

/* Rendering */
function render(){
  // background
  bgCtx.clearRect(0,0,CONFIG.W,CONFIG.H);
  const g = bgCtx.createLinearGradient(0,0,0,CONFIG.H); g.addColorStop(0,'#020617'); g.addColorStop(1,'#041026');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,CONFIG.W,CONFIG.H);
  for(const s of stars){ const b=0.06+s.z*0.18; bgCtx.fillStyle=`rgba(255,255,255,${b})`; bgCtx.beginPath(); bgCtx.ellipse(s.x,s.y,s.size*(1+s.z*1.2),s.size*(1+s.z*1.2),0,0,Math.PI*2); bgCtx.fill(); }

  // battle
  battleCtx.clearRect(0,0,CONFIG.W,CONFIG.H);
  drawTitan(battleCtx);
  drawParticles(battleCtx);

  // bloom
  bloomCtx.clearRect(0,0,CONFIG.W,CONFIG.H);
  drawBloom(bloomCtx);

  // hud
  hudCtx.clearRect(0,0,CONFIG.W,CONFIG.H);
  drawHUD(hudCtx);

  // cockpit overlay
  cockpitCtx.clearRect(0,0,CONFIG.W,CONFIG.H);
  drawCockpit(cockpitCtx);

  // final explosion simple choreography
  if(finalState.active){
    finalState.t += 1/60;
    if(finalState.phase===0){ hudCtx.save(); hudCtx.fillStyle='rgba(255,255,255,0.9)'; hudCtx.fillRect(0,0,CONFIG.W,CONFIG.H); hudCtx.restore(); finalState.phase=1; finalState.t=0; }
    else if(finalState.phase===1){ if(finalState.t>0.6){ finalState.phase=2; finalState.t=0; } }
    else if(finalState.phase===2){ if(finalState.t>3.2){ finalState.active=false; showVictory(); } }
  }
}

/* Draw Titan */
function drawTitan(ctx){
  const x=CONFIG.W*0.5, y=CONFIG.H*0.28, w=CONFIG.W*0.62, h=180;
  ctx.save();
  roundRect(ctx, x-w/2, y-h/2, w, h, 18); ctx.fillStyle='#0b1220'; ctx.fill(); ctx.lineWidth=4; ctx.strokeStyle='#0a0a0a'; ctx.stroke();
  const coreR=40; const hpPct=STATE.bossHP/CONFIG.bossMaxHP; const glow=0.2+(1-hpPct)*1.4;
  const grad=ctx.createRadialGradient(x,y,0,x,y,coreR*3); grad.addColorStop(0,`rgba(255,255,255,${0.9*glow})`); grad.addColorStop(0.3,`rgba(255,120,180,${0.6*glow})`); grad.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y,coreR*3,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x,y,coreR,0,Math.PI*2); ctx.fillStyle='rgba(255,80,150,0.95)'; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
  for(const s of TITAN_scorch){ ctx.save(); const grd=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r); grd.addColorStop(0,'rgba(0,0,0,0.6)'); grd.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=grd; ctx.beginPath(); ctx.ellipse(s.x,s.y,s.r,s.r*0.6,s.rot,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  ctx.restore();
}

/* Draw particles & debris */
function drawParticles(ctx){
  for(const d of debris){ ctx.save(); ctx.translate(d.x,d.y); ctx.rotate(d.rot); ctx.fillStyle=d.color; ctx.beginPath(); if(d.shape===0){ ctx.moveTo(-d.size,-d.size); ctx.lineTo(d.size,0); ctx.lineTo(-d.size,d.size); } else if(d.shape===1){ ctx.moveTo(0,-d.size); ctx.lineTo(d.size,d.size); ctx.lineTo(-d.size,d.size); } else { ctx.moveTo(-d.size,-d.size); ctx.lineTo(d.size,-d.size); ctx.lineTo(0,d.size); } ctx.closePath(); ctx.fill(); ctx.restore(); }
  for(const p of particles){ const life=p.life/p.maxLife; ctx.globalAlpha=clamp(life,0,1); ctx.fillStyle=p.color; ctx.beginPath(); ctx.ellipse(p.x,p.y,p.size,p.size,p.rot,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
  for(const s of sparkles){ const t=s.age/s.life; const alpha=1-t; ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.angle + t*6); ctx.globalAlpha=alpha; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(0,-s.size*0.6); ctx.lineTo(s.size*0.2,0); ctx.lineTo(0,s.size*0.6); ctx.lineTo(-s.size*0.2,0); ctx.closePath(); ctx.fill(); ctx.restore(); }
}

/* Bloom */
function drawBloom(ctx){
  const x=CONFIG.W*0.5, y=CONFIG.H*0.28, r=40;
  const grd=ctx.createRadialGradient(x,y,0,x,y,r*6); grd.addColorStop(0,'rgba(255,220,240,0.9)'); grd.addColorStop(0.2,'rgba(255,120,180,0.45)'); grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(x,y,r*6,0,Math.PI*2); ctx.fill();
}

/* HUD */
function drawHUD(ctx){
  ctx.save(); ctx.font='700 28px system-ui'; ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.fillText(timerTextEl.textContent, CONFIG.W/2, 90); ctx.restore();
  const gx=CONFIG.W/2, gy=CONFIG.H-160, gr=48;
  ctx.save(); ctx.lineWidth=10; ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.beginPath(); ctx.arc(gx,gy,gr,-Math.PI*0.75,Math.PI*0.75); ctx.stroke();
  ctx.beginPath(); ctx.strokeStyle='rgba(255,80,150,0.95)'; ctx.lineWidth=10; const end=-Math.PI*0.75 + (Math.PI*1.5)*(1-STATE.gauge); ctx.arc(gx,gy,gr,-Math.PI*0.75,end,true); ctx.stroke();
  const needle=-Math.PI*0.75 + (Math.PI*1.5)*(1-STATE.gauge); ctx.translate(gx,gy); ctx.rotate(needle); ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(0,-6); ctx.lineTo(gr+6,0); ctx.lineTo(0,6); ctx.closePath(); ctx.fill(); ctx.restore();
  const barW=220, barH=10, bx=(CONFIG.W-barW)/2, by=52; ctx.save(); ctx.fillStyle='rgba(255,255,255,0.06)'; roundRect(ctx,bx,by,barW,barH,6); ctx.fill(); ctx.fillStyle='#ff6fa0'; roundRect(ctx,bx,by,barW*(STATE.bossHP/CONFIG.bossMaxHP),barH,6); ctx.fill(); ctx.restore();
  drawLamp(ctx, CONFIG.W-110, 60, 'ARM', STATE.bossHP/CONFIG.bossMaxHP < 0.95);
  drawLamp(ctx, CONFIG.W-110, 92, 'SYNC', STATE.bossHP/CONFIG.bossMaxHP < 0.75);
  drawLamp(ctx, CONFIG.W-110, 124, 'CRIT', STATE.bossHP/CONFIG.bossMaxHP < 0.25);
}
function drawLamp(ctx,x,y,label,on){ ctx.save(); ctx.fillStyle = on ? (label==='CRIT' ? '#ff3fb5' : '#00f0ff') : 'rgba(255,255,255,0.06)'; ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='700 10px system-ui'; ctx.textAlign='left'; ctx.fillText(' '+label, x+14, y+4); ctx.restore(); }

/* Cockpit overlay */
function drawCockpit(ctx){
  ctx.save(); ctx.fillStyle='#071a2a'; roundRect(ctx,-6,80,120,CONFIG.H-160,18); ctx.fill(); roundRect(ctx,CONFIG.W-114,80,120,CONFIG.H-160,18); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.03)'; for(let y=110;y<CONFIG.H-110;y+=28){ ctx.beginPath(); ctx.arc(18,y,2,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(CONFIG.W-18,y,2,0,Math.PI*2); ctx.fill(); }
  const grd=ctx.createRadialGradient(CONFIG.W*0.2,CONFIG.H*0.15,0,CONFIG.W*0.2,CONFIG.H*0.15,260); grd.addColorStop(0,'rgba(255,255,255,0.06)'); grd.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=grd; ctx.fillRect(0,0,CONFIG.W,CONFIG.H);
  ctx.strokeStyle='rgba(255,255,255,0.02)'; ctx.lineWidth=1; for(let i=0;i<8;i++){ ctx.beginPath(); const sx=Math.random()*CONFIG.W*0.8+CONFIG.W*0.1; const sy=Math.random()*CONFIG.H*0.6+CONFIG.H*0.1; ctx.moveTo(sx,sy); ctx.quadraticCurveTo(sx+(Math.random()-0.5)*40, sy+(Math.random()-0.5)*40, sx+(Math.random()-0.5)*80, sy+(Math.random()-0.5)*20); ctx.stroke(); }
  ctx.fillStyle='#071a2a'; ctx.fillRect(CONFIG.W/2-80, CONFIG.H-220, 40, 18); ctx.fillRect(CONFIG.W/2+40, CONFIG.H-220, 40, 18);
  ctx.restore();
}

/* Grain & halftone */
function drawGrain(){ const w=grain.width,h=grain.height; const img=grainCtx.createImageData(w,h); const data=img.data; for(let i=0;i<data.length;i+=4){ const v=Math.floor(Math.random()*255); data[i]=v; data[i+1]=v; data[i+2]=v; data[i+3]=12; } grainCtx.putImageData(img,0,0); }
function drawHalftone(){ const w=halftone.width,h=halftone.height; halftoneCtx.clearRect(0,0,w,h); halftoneCtx.fillStyle='rgba(0,0,0,0.06)'; const spacing=8; for(let y=0;y<h;y+=spacing){ for(let x=0;x<w;x+=spacing){ const r=(Math.sin((x+y)/40)+1)*1.2; halftoneCtx.beginPath(); halftoneCtx.arc(x,y,r,0,Math.PI*2); halftoneCtx.fill(); } } }

/* Victory overlay */
function showVictory(){ const el=document.createElement('div'); el.style.position='absolute'; el.style.inset='0'; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center'; el.style.zIndex='999'; el.style.background='linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.6))'; el.innerHTML=`<div style="text-align:center;color:#FFE08A;font-weight:900;font-size:28px;margin-bottom:12px">TITAN OMEGA FALLEN</div><div style="color:#00F0FF;font-weight:900;margin-bottom:12px">+5 CRYSTALS â€¢ STREAK +1</div><button id="closeVictory" style="padding:10px 14px;border-radius:10px;border:none;background:#0ff;color:#041026;font-weight:900">CONTINUE</button>`; document.body.appendChild(el); document.getElementById('closeVictory').addEventListener('click', ()=> el.remove()); }

/* Helpers */
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function resetToIntro(){ STATE.running=false; STATE.brushing=false; STATE.bossHP=CONFIG.bossMaxHP; STATE.gauge=1.0; threshold75=threshold50=threshold25=false; updateUI(); }

/* Loop */
function loop(ts){
  const nowMs = performance.now();
  let dt = (nowMs - STATE.lastTime)/1000;
  STATE.lastTime = nowMs;
  dt = clamp(dt, 0, 0.05);
  if(!STATE.paused) update(dt);
  render();
  const remaining = STATE.running ? Math.max(0, CONFIG.duration - (now() - STATE.mainStart)) : CONFIG.duration;
  timerTextEl.textContent = fmt(Math.ceil(remaining));
  crystalsEl.textContent = STATE.crystals;
  streakEl.textContent = STATE.streak;
  requestAnimationFrame(loop);
}

/* Start loop already scheduled in DOMContentLoaded; expose debug hooks */
window.__TITAN = { state: STATE, start: startPrecountdown, forceVictory: ()=>{ STATE.bossHP = 0; endBrushing(true); } };
</script>
</body>
</html>
