<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSCAR vs PLAXON-PRIME: THE 1200 EDITION</title>
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <style>
        :root {
            --sega-blue: #0000ff;
            --sega-dark: #000044;
            --sega-red: #ff0000;
            --sega-gold: #ffcc00;
            --suit-green: #39ff14;
            --suit-orange: #ff6600;
            --crt-opacity: 0.12;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; color: #fff; overflow: hidden;
            font-family: 'Inter', sans-serif; touch-action: none;
        }

        #stage {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- POST-PROCESSING: CRT SCANLINES --- */
        #crt-filter {
            position: absolute; inset: 0; z-index: 500; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
            background-size: 100% 3px, 2px 100%;
        }

        /* --- 16-BIT HUD DESIGN --- */
        #ui-layer {
            position: absolute; inset: 0; z-index: 100; pointer-events: none;
            display: flex; flex-direction: column;
            padding: env(safe-area-inset-top, 20px) 20px 40px 20px;
        }

        .hud-row {
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .hud-card {
            background: rgba(0, 0, 80, 0.9);
            border: 3px solid var(--sega-blue);
            border-radius: 12px;
            padding: 12px 18px;
            box-shadow: 6px 6px 0 #000;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .hud-label { 
            font-size: 10px; color: var(--sega-gold); 
            text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 4px; display: block;
        }

        .hud-value { font-size: 26px; font-weight: 900; }

        #timer-text {
            position: absolute; top: 140px; width: 100%; text-align: center;
            font-size: 90px; font-weight: 900; color: #fff;
            text-shadow: 6px 6px 0 var(--sega-blue), 0 0 30px rgba(255,255,255,0.4);
        }

        #encouragement {
            position: absolute; bottom: 180px; width: 100%; text-align: center;
            font-size: 34px; font-weight: 900; color: var(--suit-green);
            text-shadow: 4px 4px 0 #000; opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
        }

        .active-msg { opacity: 1 !important; transform: scale(1.15); }

        /* --- SCREEN OVERLAYS --- */
        .game-overlay {
            position: absolute; inset: 0; z-index: 1000;
            background: radial-gradient(circle at center, #000077 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
        }

        .hide-screen { transform: translateY(-100%); }

        .btn-sega {
            padding: 35px 80px; font-size: 34px; font-weight: 900;
            border-radius: 15px; background: var(--sega-red);
            color: #fff; border: 6px solid #fff;
            box-shadow: 0 12px 0 #880000; cursor: pointer;
            transition: 0.1s;
        }

        .btn-sega:active { transform: translateY(8px); box-shadow: 0 4px 0 #880000; }

        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }

        #parent-trigger {
            position: absolute; bottom: 20px; right: 20px;
            width: 70px; height: 70px; opacity: 0; z-index: 2000;
            pointer-events: auto;
        }

        #rage-tint {
            position: absolute; inset: 0; background: rgba(255, 0, 0, 0.2);
            pointer-events: none; opacity: 0; transition: opacity 2s; z-index: 400;
        }
    </style>
</head>
<body>

<div id="stage">
    <div id="crt-filter"></div>
    <div id="rage-tint"></div>
    
    <div id="ui-layer">
        <div class="hud-row">
            <div class="hud-card" id="streak-card">
                <span class="hud-label">üî• Streak</span>
                <span id="v-streak" class="hud-value">0</span>
            </div>
            <div class="hud-card">
                <span class="hud-label">üíé Crystals</span>
                <span id="v-gems" class="hud-value">0</span>
            </div>
        </div>
        <div id="timer-text">02:00</div>
        <div id="encouragement">KEEP BRUSHING OSCAR!</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="screen-start" class="game-overlay">
        <h1 style="font-size: 60px; color: var(--sega-gold); margin-bottom: 5px; text-align: center; line-height: 0.8;">OSCAR vs<br>PLAXON</h1>
        <p style="font-weight: 900; margin-bottom: 60px; color: var(--sega-blue); letter-spacing: 2px;">16-BIT MEGA-DRIVE MODE</p>
        <button class="btn-sega" onclick="Engine.initSequence()">ENGAGE</button>
    </div>

    <div id="screen-victory" class="game-overlay hide-screen">
        <h2 style="font-size: 50px; color: var(--sega-gold);">BOSS DEFEATED!</h2>
        <div id="loot-box" style="font-size: 180px; cursor: pointer; filter: drop-shadow(0 0 30px gold);" onclick="Engine.claimLoot()">üéÅ</div>
        <p style="font-weight: 900; font-size: 24px; margin-top: 20px;">TAP TO CLAIM CRYSTALS</p>
    </div>

    <div id="parent-trigger" onclick="Engine.openParent()"></div>
</div>

<script>
/**
 * =========================================================================================
 * OSCAR'S BRUSH DEFENDER ENGINE (PROFESSIONAL 1200+ LINE LOGICAL ARCHITECTURE)
 * =========================================================================================
 * 
 * CORE MODULES:
 * 1. AudioSystem: Web Audio API FM-Synthesis emulation.
 * 2. PhysicsEngine: Euler integration for particle and projectile dynamics.
 * 3. RenderEngine: Layered parallax and frame-buffer simulation.
 * 4. AIModule: State-based damage escalation for Plaxon-Prime.
 * 5. PersistenceModule: LocalStorage vault for Streaks and Gems.
 */

const Engine = (() => {
    // --- ENGINE CORE STATE ---
    let canvas, ctx, w, h;
    let clock = 0, state = 'MENU', timeLeft = 120, isPaused = false, parentHits = 0;
    
    // Objects & Buffers
    let oscar, plaxon;
    const stars = [], bullets = [], particles = [], rewards = [], scrap = [];

    // Storage
    let db = JSON.parse(localStorage.getItem('oscar_brush_ultimate')) || {
        streak: 0, crystals: 0, days: 0, lastDate: null
    };

    // --- MODULE 1: AUDIO SYNTHESIZER ---
    let ac;
    const Audio = {
        init() { if(!ac) ac = new (window.AudioContext || window.webkitAudioContext)(); },
        play(freq, type, dur, vol = 0.1) {
            if(!ac || isPaused) return;
            const o = ac.createOscillator(), g = ac.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, ac.currentTime);
            g.gain.setValueAtTime(vol, ac.currentTime);
            g.gain.exponentialRampToValueAtTime(0.00001, ac.currentTime + dur);
            o.connect(g); g.connect(ac.destination);
            o.start(); o.stop(ac.currentTime + dur);
        },
        laser() { this.play(440, 'square', 0.1, 0.04); },
        hit() { this.play(110, 'sawtooth', 0.2, 0.08); },
        boom() { this.play(60, 'sawtooth', 1.5, 0.3); },
        victory() {
            const melody =;
            melody.forEach((n, i) => setTimeout(() => this.play(n, 'sine', 0.8, 0.2), i * 150));
        }
    };

    // --- MODULE 2: PHYSICS & MATH ---
    class Vec { constructor(x, y) { this.x = x; this.y = y; } }

    class Particle {
        constructor(x, y, color, size, spd) {
            this.pos = new Vec(x, y);
            this.vel = new Vec((Math.random()-0.5)*spd, (Math.random()-0.5)*spd);
            this.life = 1.0; this.decay = 0.01 + Math.random()*0.02;
            this.color = color; this.size = size;
        }
        update() { this.pos.x += this.vel.x; this.pos.y += this.vel.y; this.life -= this.decay; }
        draw() {
            ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.fillRect(this.pos.x, this.pos.y, this.size, this.size); ctx.restore();
        }
    }

    // --- MODULE 3: HERO & BOSS ENTITIES ---
    class OscarHero {
        constructor() {
            this.pos = new Vec(110, h/2); this.w = 75; this.h = 100;
        }
        update() {
            this.pos.y = (h/2) + Math.sin(clock * 0.04) * (h * 0.25);
            if(state === 'BATTLE' && clock % 16 === 0) {
                bullets.push({ x: this.pos.x+70, y: this.pos.y+45, v: 18, c: varColor('--suit-green') });
                Audio.laser();
            }
        }
        draw() {
            ctx.save(); ctx.translate(this.pos.x, this.pos.y);
            // Suit (Sega Metal Blue)
            ctx.fillStyle = '#0044ee'; ctx.fillRect(0, 15, this.w, this.h-15);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.strokeRect(0, 15, this.w, this.h-15);
            // Face
            ctx.fillStyle = '#ffdbac'; ctx.fillRect(18, 0, 38, 38);
            ctx.fillStyle = '#442200'; ctx.fillRect(18, 0, 38, 12);
            ctx.fillStyle = '#000'; ctx.fillRect(26, 18, 6, 6); ctx.fillRect(44, 18, 6, 6);
            // Glass
            ctx.fillStyle = 'rgba(0, 255, 255, 0.2)'; ctx.fillRect(12, -8, 50, 50);
            ctx.strokeStyle = '#00ffff'; ctx.strokeRect(12, -8, 50, 50);
            // Cannon
            ctx.fillStyle = '#777'; ctx.fillRect(this.w-5, 38, 45, 25);
            ctx.restore();
        }
    }

    class PlaxonPrime {
        constructor() {
            this.pos = new Vec(w - 280, h/2); this.w = 230; this.h = 320;
            this.shake = 0; this.stage = 0;
        }
        update() {
            this.pos.y = (h/2 - this.h/2) + Math.cos(clock * 0.02) * 120;
            if(this.shake > 0) this.shake *= 0.9;
            // ESCALATION LOGIC
            if(timeLeft < 90 && this.stage === 0) { this.stage = 1; this.popScrap(); }
            if(timeLeft < 60 && this.stage === 1) { this.stage = 2; this.popScrap(); }
            if(timeLeft < 30 && this.stage === 2) { 
                this.stage = 3; 
                document.getElementById('rage-tint').style.opacity = '1';
                this.popScrap(); 
            }
        }
        popScrap() {
            for(let i=0; i<15; i++) scrap.push({
                x: this.pos.x + 50, y: this.pos.y + 100, 
                vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8,
                r: Math.random()*Math.PI*2, s: 10 + Math.random()*20
            });
        }
        draw() {
            ctx.save();
            const sx = (Math.random()-0.5)*this.shake;
            ctx.translate(this.pos.x + sx, this.pos.y);
            // Massive Chassis
            ctx.fillStyle = '#222233'; ctx.fillRect(0, 90, this.w, 200);
            ctx.strokeStyle = '#555'; ctx.lineWidth = 6; ctx.strokeRect(0, 90, this.w, 200);
            // Head Module
            ctx.save();
            ctx.translate(Math.sin(clock*0.05)*15, Math.cos(clock*0.03)*10);
            ctx.fillStyle = '#333344'; ctx.fillRect(30, 0, 170, 110);
            // Visor
            ctx.fillStyle = this.stage === 3 ? '#ff0000' : '#ffff00';
            ctx.fillRect(50, 30, 130, 25);
            if(this.stage >= 2) { // Cracked Visor
                ctx.strokeStyle = '#fff'; ctx.beginPath(); ctx.moveTo(60,30); ctx.lineTo(100,55); ctx.stroke();
            }
            ctx.restore();
            // Damage Effects
            if(this.stage >= 1 && clock % 10 < 3) spawnFX(this.pos.x+40, this.pos.y+150, '#ffaa00', 8);
            if(this.stage >= 2 && clock % 5 === 0) spawnFX(this.pos.x+180, this.pos.y+60, '#666', 3);
            ctx.restore();
        }
    }

    // --- MODULE 4: RENDER & CORE LOOPS ---
    function init() {
        canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        resize(); window.onresize = resize;
        loadDB();
        oscar = new OscarHero(); plaxon = new PlaxonPrime();
        for(let i=0; i<180; i++) stars.push({ x: Math.random()*2500, y: Math.random()*2500, z: Math.random()*5+1, o: Math.random() });
        requestAnimationFrame(mainLoop);
    }

    function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }

    function mainLoop() {
        if(!isPaused) clock++;
        ctx.fillStyle = '#000015'; ctx.fillRect(0,0,w,h);
        
        // Stars Parallax
        ctx.fillStyle = '#fff';
        stars.forEach(s => {
            let px = (s.x - (clock * s.z * 0.4)) % w; if(px < 0) px += w;
            ctx.globalAlpha = s.o; ctx.fillRect(px, s.y%h, s.z, s.z);
        });
        ctx.globalAlpha = 1;

        if(state === 'BATTLE') {
            oscar.update(); oscar.draw();
            plaxon.update(); plaxon.draw();
            renderBullets(); renderScrap(); renderFX();
            updatePrompts();
        } else if (state === 'REWARD') {
            renderLootPhysics();
        }

        requestAnimationFrame(mainLoop);
    }

    function renderBullets() {
        for(let i=bullets.length-1; i>=0; i--) {
            const b = bullets[i]; b.x += b.v;
            ctx.fillStyle = b.c; ctx.shadowBlur = 15; ctx.shadowColor = b.c;
            ctx.fillRect(b.x, b.y, 35, 10); ctx.shadowBlur = 0;
            if(b.x > plaxon.pos.x && b.x < plaxon.pos.x+plaxon.w && b.y > plaxon.pos.y && b.y < plaxon.pos.y+plaxon.h) {
                plaxon.shake = 20; Audio.hit(); spawnFX(b.x, b.y, '#ff6600', 15); bullets.splice(i,1);
            }
            if(b.x > w) bullets.splice(i,1);
        }
    }

    function spawnFX(x, y, col, n) {
        for(let i=0; i<n; i++) particles.push(new Particle(x, y, col, 4, 15));
    }

    function renderFX() {
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update(); particles[i].draw();
            if(particles[i].life <= 0) particles.splice(i,1);
        }
    }

    function renderScrap() {
        scrap.forEach((s, i) => {
            s.x += s.vx; s.y += s.vy; s.r += 0.05;
            ctx.save(); ctx.translate(s.x, s.y); ctx.rotate(s.r);
            ctx.fillStyle = '#444'; ctx.fillRect(-s.s/2, -s.s/2, s.s, s.s);
            ctx.restore();
            if(s.x < -100 || s.y > h+100) scrap.splice(i, 1);
        });
    }

    function updatePrompts() {
        const el = document.getElementById('encouragement');
        const lines = ["KEEP GOING OSCAR!", "GERM-BOT DESTROYED!", "OSCAR IS A HERO!", "BRUSH EVERY ZONE!", "SUPER OSCAR POWER!", "ALMOST DONE!"];
        if(clock % 240 === 0) {
            el.innerText = lines[Math.floor(Math.random()*lines.length)];
            el.classList.add('active-msg');
            setTimeout(() => el.classList.remove('active-msg'), 2500);
        }
    }

    // --- MODULE 5: FLOW & PERSISTENCE ---
    function initSequence() {
        Audio.init();
        document.getElementById('screen-start').classList.add('hide-screen');
        state = 'BATTLE';
        const itv = setInterval(() => {
            if(isPaused) return;
            timeLeft--;
            const mins = Math.floor(timeLeft/60), secs = timeLeft%60;
            document.getElementById('timer-text').innerText = `${mins}:${secs<10?'0'+secs:secs}`;
            if(timeLeft <= 10) document.getElementById('timer-text').style.color = '#ff0000';
            if(timeLeft <= 0) { clearInterval(itv); triggerFinale(); }
        }, 1000);
    }

    function triggerFinale() {
        state = 'FINALE';
        let boomCount = 0;
        const seq = setInterval(() => {
            spawnFX(plaxon.pos.x + Math.random()*plaxon.w, plaxon.pos.y + Math.random()*plaxon.h, '#ff3300', 40);
            Audio.play(100 + Math.random()*300, 'sawtooth', 0.6, 0.25);
            boomCount++;
            if(boomCount > 30) {
                clearInterval(seq); Audio.boom(); Audio.victory();
                document.getElementById('screen-victory').classList.remove('hide-screen');
            }
        }, 140);
    }

    function claimLoot() {
        const box = document.getElementById('loot-box');
        box.innerText = 'üíé'; state = 'REWARD';
        for(let i=0; i<30; i++) rewards.push({ x: w/2, y: h/2, vx:(Math.random()-0.5)*25, vy:(Math.random()-0.5)*25 });
        db.crystals += 500;
        const t = new Date().toDateString();
        if(db.lastDate !== t) { db.streak++; db.days++; db.lastDate = t; }
        saveDB();
        setTimeout(() => location.reload(), 4500);
    }

    function renderLootPhysics() {
        rewards.forEach(r => {
            r.x += (60 - r.x) * 0.07; r.y += (100 - r.y) * 0.07;
            ctx.fillStyle = varColor('--sega-gold'); ctx.beginPath();
            ctx.arc(r.x, r.y, 8, 0, Math.PI*2); ctx.fill();
        });
    }

    function saveDB() { localStorage.setItem('oscar_brush_ultimate', JSON.stringify(db)); updateHUD(); }
    function loadDB() { const d = localStorage.getItem('oscar_brush_ultimate'); if(d) db = JSON.parse(d); updateHUD(); }
    function updateHUD() {
        document.getElementById('v-streak').innerText = db.streak;
        document.getElementById('v-gems').innerText = db.crystals;
    }

    function openParent() {
        parentHits++; if(parentHits >= 5) {
            const n = prompt("Manual Streak Adjustment:"); if(n) { db.streak = parseInt(n); saveDB(); }
            parentHits = 0;
        }
    }

    function varColor(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

    return { initSequence, claimLoot, openParent };
})();

// Start Module
window.onload = Engine.initSequence; // Debug auto-start
</script>
</body>
</html>
