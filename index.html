<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>TITAN OMEGA â€” CHRONO SYNC (Toothbrush Mode)</title>
<style>
  /* ===========================
     GLOBAL & LAYOUT
     =========================== */
  :root{
    --bg:#041026;
    --neon:#00f0ff;
    --pink:#ff3fb5;
    --accent:#7afcff;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased;}
  body{display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);overflow:hidden;}
  #app{width:100%;max-width:430px;height:100%;max-height:932px;border-radius:12px;overflow:hidden;position:relative;background:linear-gradient(180deg,#041026 0%, #07102a 100%);box-shadow:0 12px 30px rgba(0,0,0,0.6)}
  .view{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;box-sizing:border-box}
  .hidden{display:none}

  /* Canvas */
  #screenWrap{position:relative;flex:1;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
  canvas#screen{width:100%;height:100%;image-rendering:pixelated;display:block;background:linear-gradient(180deg,#020617 0%, #041026 100%);}

  /* HUD */
  #hud{position:absolute;left:0;right:0;top:0;padding:12px;display:flex;flex-direction:column;align-items:center;pointer-events:none}
  .topRow{width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;pointer-events:auto}
  .statBox{background:var(--glass);padding:8px 10px;border-radius:10px;border:2px solid rgba(255,255,255,0.04);display:flex;gap:8px;align-items:center;font-weight:800;color:#fff}
  .bigTimer{font-size:44px;font-weight:900;letter-spacing:1px;text-shadow:0 0 12px rgba(0,255,255,0.18);display:flex;align-items:center;gap:10px}
  .ring{width:64px;height:64px;position:relative;display:inline-block}

  /* Boss HP */
  #bossBarWrap{position:absolute;top:86px;left:50%;transform:translateX(-50%);width:86%;max-width:380px;pointer-events:none}
  #bossBar{height:22px;background:linear-gradient(90deg,#2b2b2b,#111);border-radius:12px;overflow:hidden;border:3px solid rgba(0,0,0,0.6)}
  #bossHP{height:100%;width:100%;background:linear-gradient(90deg,#ff3fb5,#ffb86b);transform-origin:left center;transition:width 0.08s linear}
  #bossLabel{position:absolute;left:50%;top:-22px;transform:translateX(-50%);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,0.6);font-size:14px}

  /* Controls */
  #controls{position:absolute;bottom:18px;left:0;right:0;display:flex;justify-content:center;gap:12px;pointer-events:auto;padding:0 18px;box-sizing:border-box}
  .btn{background:linear-gradient(180deg,#0ff 0%, #7afcff 100%);border-radius:12px;padding:12px 16px;font-weight:900;color:#041026;border:3px solid rgba(0,0,0,0.35);box-shadow:0 8px 18px rgba(0,0,0,0.4);font-size:16px;min-width:120px;text-align:center;user-select:none;touch-action:manipulation}
  .btn.secondary{background:linear-gradient(180deg,#ff3fb5 0%, #ff8fc9 100%);color:#041026}
  .btn.ghost{background:transparent;border:2px dashed rgba(255,255,255,0.06);color:#fff}
  .btn[aria-disabled="true"],.btn.disabled{opacity:0.35;pointer-events:none;filter:grayscale(0.2) saturate(0.6)}

  /* Intro crawl */
  #intro{background:linear-gradient(180deg,#020617 0%, #041026 100%);align-items:stretch;padding:18px}
  .crawlWrap{flex:1;display:flex;align-items:flex-end;justify-content:center;position:relative;overflow:hidden}
  .crawl{width:100%;max-width:380px;color:#ffd;transform-origin:center bottom;perspective:800px;font-weight:800;line-height:1.4;text-align:center}
  .crawl p{margin:0 0 12px 0;font-size:18px;text-shadow:0 2px 8px rgba(0,0,0,0.6)}
  .crawl .title{font-size:20px;color:var(--accent);letter-spacing:1px}

  /* overlays */
  .scanlines{position:absolute;inset:0;pointer-events:none;background-image:linear-gradient(rgba(0,0,0,0.06) 50%, rgba(255,255,255,0.01) 51%);background-size:100% 4px;mix-blend-mode:overlay;opacity:0.6}
  .halftone{position:absolute;inset:0;pointer-events:none;background-image:
    radial-gradient(circle at 10% 10%, rgba(0,0,0,0.02) 0, transparent 20%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0.02) 0, transparent 20%);opacity:0.6;mix-blend-mode:overlay}

  /* hero portrait in HUD */
  .heroPortrait{width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#071a2a,#0b1220);display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.06);font-weight:900;color:#fff}

  /* small */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (max-width:420px){ .bigTimer{font-size:36px} .btn{min-width:100px;padding:10px 12px;font-size:15px} }
</style>
</head>
<body>
<div id="app" role="application" aria-label="Titan Omega Chrono Sync toothbrush game">
  <!-- INTRO VIEW -->
  <section id="viewIntro" class="view" aria-hidden="false">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="font-weight:900;font-size:18px;color:var(--accent)">TITAN OMEGA</div>
        <div style="font-size:12px;opacity:0.9">CHRONO SYNC</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:12px;opacity:0.9">Pilot</label>
        <input id="pilotInput" type="text" inputmode="text" placeholder="Your name" style="padding:6px 8px;border-radius:8px;border:2px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-weight:700;min-width:120px" />
      </div>
    </div>

    <div class="crawlWrap" aria-hidden="false">
      <!-- cinematic Star-Wars-esque crawl: slanted perspective -->
      <div id="crawl" class="crawl" aria-live="polite" role="article" aria-label="Mission briefing" style="transform:translateY(40%) rotateX(28deg) scale(1)">
        <div class="title">MISSION: CHRONO SYNC</div>
        <p style="font-size:16px;opacity:0.95">A rogue Titan Omega drifts through orbit, corrupting the Chrono Grid. The Chrono Core must be synced before the orbit collapses.</p>
        <p style="font-size:16px">Pilot, suit up. You are the exoâ€‘suit hero â€” a kid with a brave heart and a neon laser. Two minutes of steady brushing will sync the core and bring the Titan down.</p>
        <p style="font-size:14px;opacity:0.9">This cinematic crawl is editable in the source. Default duration 5 seconds. Reduced motion available.</p>
      </div>
    </div>

    <div style="display:flex;gap:10px;justify-content:center;padding:12px">
      <button id="startIntroBtn" class="btn" aria-label="Start mission" touch-action="manipulation">START MISSION</button>
      <button id="skipIntroBtn" class="btn secondary" aria-label="Skip intro" touch-action="manipulation">SKIP INTRO</button>
    </div>

    <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-top:6px">
      <label style="display:flex;gap:6px;align-items:center"><input id="reducedMotion" type="checkbox" /> Reduced motion</label>
      <label style="display:flex;gap:6px;align-items:center"><input id="highContrast" type="checkbox" /> High contrast</label>
    </div>
  </section>

  <!-- GAME VIEW -->
  <section id="viewGame" class="view hidden" aria-hidden="true">
    <div id="screenWrap" aria-hidden="false">
      <canvas id="screen" width="430" height="932" role="img" aria-label="Game screen"></canvas>
      <div class="scanlines"></div>
      <div class="halftone"></div>

      <div id="hud" aria-hidden="false">
        <div class="topRow">
          <div style="display:flex;gap:8px;align-items:center">
            <div class="statBox" id="crystalBox" aria-live="polite"><div style="font-size:18px">ðŸ’Ž</div><div><div class="label">Crystals</div><div id="crystals" style="font-size:16px">0</div></div></div>
            <div class="heroPortrait" title="Pilot portrait" id="heroPortrait">ðŸ‘¦</div>
          </div>

          <div class="bigTimer" role="timer" aria-live="assertive" aria-atomic="true">
            <div class="ring" aria-hidden="true" id="progressRing"></div>
            <div id="timerText">02:00</div>
          </div>

          <div class="statBox" id="streakBox" aria-live="polite"><div style="font-size:18px">ðŸ”¥</div><div><div class="label">Streak</div><div id="streak" style="font-size:16px">0</div></div></div>
        </div>
      </div>

      <div id="bossBarWrap" aria-hidden="false">
        <div id="bossLabel">TITAN CORE</div>
        <div id="bossBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100" aria-label="Titan health">
          <div id="bossHP"></div>
        </div>
      </div>
    </div>

    <div id="controls" role="toolbar" aria-label="Game controls">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="tapBtn" class="btn ghost" aria-label="Tap for sparkle" touch-action="manipulation">TAP FOR SPARKLE</button>
        <button id="startBtn" class="btn" aria-label="Start brushing" touch-action="manipulation">START</button>
        <button id="pauseBtn" class="btn secondary" aria-label="Pause" touch-action="manipulation">PAUSE</button>
        <button id="backIntroBtn" class="btn ghost" aria-label="Back to intro" touch-action="manipulation">BACK</button>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="muteBtn" class="btn ghost" aria-label="Mute" touch-action="manipulation">MUTE</button>
        <button id="skipBtn" class="btn ghost" aria-label="Skip countdown" touch-action="manipulation">SKIP</button>
      </div>
    </div>

    <div style="position:absolute;left:12px;bottom:12px;font-size:12px;opacity:0.9">Pilot: <span id="pilotName">â€”</span></div>
  </section>
</div>

<!-- ===========================
     SCRIPT: organized sections
     =========================== -->
<script>
/* ===========================
   CONFIG
   =========================== */
const CONFIG = {
  canvasW: 430,
  canvasH: 932,
  crawlDuration: 5.0,
  preCountdown: 5.0,
  duration: 120.0,
  bossMaxHP: 100.0,
  particlePoolSize: 220,
  debrisPoolSize: 120,
  sparklePoolSize: 80,
  starCount: 120,
  maxActiveParticles: 180,
  maxActiveDebris: 100,
  audioEnabledDefault: true,
  localKeys: {
    crystals: 'titan_crystals',
    streak: 'titan_streak',
    best: 'titan_best',
    pilot: 'titan_pilot',
    mute: 'titan_mute'
  }
};

/* ===========================
   STATE
   =========================== */
const STATE = {
  view: 'intro',
  running: false,
  brushing: false,
  paused: false,
  mute: false,
  audioReady: false,
  lastTime: 0,
  bossHP: CONFIG.bossMaxHP,
  bossMaxHP: CONFIG.bossMaxHP,
  crystals: 0,
  streak: 0,
  best: 0,
  pilot: '',
  countdown: CONFIG.preCountdown,
  crawlPlaying: false,
  reducedMotion: false,
  highContrast: false,
  drainPerSecond: CONFIG.bossMaxHP / CONFIG.duration,
  mainStartTime: 0,
  mainElapsed: 0,
  cameraShake: {x:0,y:0,amt:0}
};

/* ===========================
   CANVAS SETUP
   =========================== */
const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d', { alpha: false });
canvas.width = CONFIG.canvasW;
canvas.height = CONFIG.canvasH;

/* ===========================
   UTILS
   =========================== */
function $(id){return document.getElementById(id)}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function now(){return performance.now()/1000}
function fmtTime(s){ s = Math.max(0, Math.floor(s)); const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }
function saveLS(key,val){localStorage.setItem(key,JSON.stringify(val))}
function loadLS(key,def){try{const v=JSON.parse(localStorage.getItem(key));return v===null?def:v}catch(e){return def}}

/* ===========================
   AUDIO
   =========================== */
let audioCtx = null;
let masterGain = null;
function ensureAudio(){
  if(audioCtx) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = STATE.mute ? 0 : 1;
    masterGain.connect(audioCtx.destination);
    STATE.audioReady = true;
  }catch(e){
    STATE.audioReady = false;
  }
}
function setMute(m){
  STATE.mute = m;
  if(masterGain) masterGain.gain.value = m ? 0 : 1;
  saveLS(CONFIG.localKeys.mute, m);
  updateMuteUI();
}
function tone(freq=880, dur=0.12, type='sine', when=0, vol=0.12){
  if(!STATE.audioReady || STATE.mute) return;
  const t = audioCtx.currentTime + when;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = 0.0001;
  o.connect(g); g.connect(masterGain);
  o.start(t);
  g.gain.exponentialRampToValueAtTime(vol, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  o.stop(t + dur + 0.02);
}
function laserSound(){ tone(1600 + Math.random()*400, 0.06, 'sawtooth', 0, 0.08); }
function smallExplode(){ tone(220 + Math.random()*80, 0.18, 'sine', 0, 0.12); tone(1200 + Math.random()*400, 0.08, 'triangle', 0.02, 0.06); }
function bigBoom(){ tone(80, 0.9, 'sine', 0, 0.28); tone(220, 0.6, 'sine', 0.02, 0.18); tone(1200, 0.6, 'sawtooth', 0.04, 0.06); }
function victoryTone(){ tone(880,0.18,'sine',0,0.14); tone(1320,0.9,'sine',0.06,0.08); }

/* ===========================
   POOLS
   =========================== */
class Pool {
  constructor(createFn, size){
    this.createFn = createFn;
    this.items = [];
    for(let i=0;i<size;i++) this.items.push(createFn());
  }
  acquire(){ return this.items.length ? this.items.pop() : this.createFn(); }
  release(item){ this.items.push(item); }
}
function createParticle(){ return {x:0,y:0,vx:0,vy:0,life:0,maxLife:0,size:1,color:'#fff',rot:0,rotV:0}; }
function createDebris(){ return {x:0,y:0,vx:0,vy:0,life:0,maxLife:0,size:4,color:'#aaa',rot:0,rotV:0,shape:0}; }
function createSparkle(){ return {x:0,y:0,age:0,life:0,size:0,angle:0}; }

const particlePool = new Pool(createParticle, CONFIG.particlePoolSize);
const debrisPool = new Pool(createDebris, CONFIG.debrisPoolSize);
const sparklePool = new Pool(createSparkle, CONFIG.sparklePoolSize);

const activeParticles = [];
const activeDebris = [];
const activeSparkles = [];

/* ===========================
   STARS
   =========================== */
const stars = [];
function initStars(){
  stars.length = 0;
  for(let i=0;i<CONFIG.starCount;i++){
    stars.push({
      x: Math.random()*CONFIG.canvasW,
      y: Math.random()*CONFIG.canvasH,
      z: Math.random(),
      size: Math.random()*2+0.5,
      speed: 10 + Math.random()*80
    });
  }
}

/* ===========================
   TITAN & HERO (EXO-SUIT)
   =========================== */
const TITAN = { x: CONFIG.canvasW*0.5, y: CONFIG.canvasH*0.28, w: CONFIG.canvasW*0.6, h: 160, coreR: 36, damageState: 0 };
const HERO = { x: CONFIG.canvasW*0.5, y: CONFIG.canvasH*0.78, w: 56, h: 72, fireCooldown: 0, fireRate: 0.12, jetBoost:0 };

/* Draw a more detailed exo-suit hero (kid) with helmet, visor, jetpack and muzzle flash */
function drawHero(){
  const x = HERO.x, y = HERO.y;
  ctx.save();
  ctx.translate(x, y);

  // body shadow
  ctx.fillStyle = '#071a2a';
  roundRect(ctx, -HERO.w/2 - 2, -HERO.h/2 - 2, HERO.w + 4, HERO.h + 4, 8);
  ctx.fill();

  // suit base
  roundRect(ctx, -HERO.w/2, -HERO.h/2, HERO.w, HERO.h, 8);
  ctx.fillStyle = '#0ff';
  ctx.fill();

  // chest plate
  ctx.fillStyle = '#041026';
  roundRect(ctx, -HERO.w/4, -HERO.h/4, HERO.w/2, HERO.h/3, 6);
  ctx.fill();

  // helmet
  ctx.beginPath();
  ctx.ellipse(0, -HERO.h/2 - 8, 22, 18, 0, 0, Math.PI*2);
  ctx.fillStyle = '#0b1220';
  ctx.fill();
  // visor
  ctx.beginPath();
  ctx.ellipse(0, -HERO.h/2 - 8, 14, 10, 0, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(0,240,255,0.95)';
  ctx.fill();
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 1;
  ctx.stroke();

  // jetpack (back)
  ctx.fillStyle = '#071a2a';
  ctx.fillRect(-HERO.w/2 - 6, -HERO.h/4, 12, HERO.h/2);
  ctx.fillRect(HERO.w/2 - 6, -HERO.h/4, 12, HERO.h/2);

  // small thruster flame when firing or boost
  if(HERO.jetBoost > 0){
    ctx.save();
    ctx.globalAlpha = HERO.jetBoost;
    const flameGrad = ctx.createLinearGradient(-6, HERO.h/4, 6, HERO.h/2 + 20);
    flameGrad.addColorStop(0, '#ffb86b');
    flameGrad.addColorStop(1, '#ff3fb5');
    ctx.fillStyle = flameGrad;
    ctx.beginPath();
    ctx.ellipse(0, HERO.h/2 + 6, 10 + HERO.jetBoost*8, 18 + HERO.jetBoost*12, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  ctx.restore();

  // muzzle flash and laser origin
  if(STATE.brushing){
    // beam origin slightly above hero center
    const ox = x;
    const oy = y - HERO.h*0.28;
    // small muzzle flash
    ctx.save();
    ctx.globalCompositeOperation = 'lighter';
    const g = ctx.createRadialGradient(ox, oy, 0, ox, oy, 28);
    g.addColorStop(0, 'rgba(255,255,255,0.9)');
    g.addColorStop(0.2, 'rgba(255,200,220,0.8)');
    g.addColorStop(1, 'rgba(255,63,181,0.0)');
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(ox, oy, 28, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}

/* ===========================
   INPUT
   =========================== */
document.addEventListener('DOMContentLoaded', initHandlers, {passive:true});
function initHandlers(){
  const startIntroBtn = $('startIntroBtn');
  const skipIntroBtn = $('skipIntroBtn');
  const startBtn = $('startBtn');
  const pauseBtn = $('pauseBtn');
  const tapBtn = $('tapBtn');
  const backIntroBtn = $('backIntroBtn');
  const muteBtn = $('muteBtn');
  const skipBtn = $('skipBtn');
  const pilotInput = $('pilotInput');
  const reducedMotion = $('reducedMotion');
  const highContrast = $('highContrast');

  // Load persistent
  STATE.crystals = loadLS(CONFIG.localKeys.crystals, 0);
  STATE.streak = loadLS(CONFIG.localKeys.streak, 0);
  STATE.best = loadLS(CONFIG.localKeys.best, 0);
  STATE.pilot = loadLS(CONFIG.localKeys.pilot, '');
  STATE.mute = loadLS(CONFIG.localKeys.mute, !CONFIG.audioEnabledDefault ? true : false);

  $('crystals').textContent = STATE.crystals;
  $('streak').textContent = STATE.streak;
  $('pilotName').textContent = STATE.pilot || 'â€”';
  pilotInput.value = STATE.pilot || '';
  $('heroPortrait').textContent = STATE.pilot ? STATE.pilot.charAt(0).toUpperCase() : 'ðŸ‘¦';

  STATE.reducedMotion = reducedMotion.checked;
  STATE.highContrast = highContrast.checked;
  reducedMotion.addEventListener('change', ()=>{ STATE.reducedMotion = reducedMotion.checked; });
  highContrast.addEventListener('change', ()=>{ STATE.highContrast = highContrast.checked; document.body.style.filter = STATE.highContrast ? 'contrast(1.2) saturate(1.2)' : 'none'; });

  // Audio resume on gesture
  function resumeAudioOnGesture(){
    ensureAudio();
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().then(()=>{ STATE.audioReady = true; });
    document.removeEventListener('touchend', resumeAudioOnGesture);
    document.removeEventListener('click', resumeAudioOnGesture);
  }
  document.addEventListener('touchend', resumeAudioOnGesture, {passive:true});
  document.addEventListener('click', resumeAudioOnGesture, {passive:true});

  // Buttons
  startIntroBtn.addEventListener('click', startIntroFlow);
  startIntroBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); startIntroFlow(); });

  skipIntroBtn.addEventListener('click', ()=>{ playCrawl(true); });
  skipIntroBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); playCrawl(true); });

  startBtn.addEventListener('click', ()=>{ startPrecountdown(); });
  startBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); startPrecountdown(); });

  pauseBtn.addEventListener('click', togglePause);
  pauseBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); togglePause(); });

  tapBtn.addEventListener('click', ()=>{ handleTap(); });
  tapBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); handleTap(); });

  backIntroBtn.addEventListener('click', ()=>{ setView('intro'); });
  backIntroBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); setView('intro'); });

  muteBtn.addEventListener('click', ()=>{ setMute(!STATE.mute); });
  muteBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); setMute(!STATE.mute); });

  skipBtn.addEventListener('click', ()=>{ skipCountdownOrCrawl(); });
  skipBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); skipCountdownOrCrawl(); });

  pilotInput.addEventListener('input', ()=>{ STATE.pilot = pilotInput.value.trim().slice(0,20); $('pilotName').textContent = STATE.pilot || 'â€”'; $('heroPortrait').textContent = STATE.pilot ? STATE.pilot.charAt(0).toUpperCase() : 'ðŸ‘¦'; saveLS(CONFIG.localKeys.pilot, STATE.pilot); });

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){ e.preventDefault(); if(!STATE.brushing) handleTap(); }
    if(e.key === 'p' || e.key === 'P'){ e.preventDefault(); if(!STATE.brushing) togglePause(); }
    if(e.key === 'm' || e.key === 'M'){ e.preventDefault(); setMute(!STATE.mute); }
  });

  // Init visuals
  initStars();
  resetBoss();
  updateMuteUI();
  updateButtonsEnabled(true);
  drawStaticHUD();
  window.__TITAN = { state: STATE, startGame: startPrecountdown, setView, forceVictory: ()=>{ STATE.bossHP = 0; updateBossUI(); endBrushing(true); } };
}

/* ===========================
   UI helpers
   =========================== */
function updateMuteUI(){ const muteBtn = $('muteBtn'); muteBtn.textContent = STATE.mute ? 'UNMUTE' : 'MUTE'; muteBtn.setAttribute('aria-pressed', String(STATE.mute)); }
function updateBossUI(){ const hpPct = clamp(STATE.bossHP / STATE.bossMaxHP, 0, 1); $('bossHP').style.width = (hpPct*100) + '%'; $('bossBar').setAttribute('aria-valuenow', Math.round(hpPct*100)); }
function updateTimerUI(remaining){ $('timerText').textContent = fmtTime(Math.ceil(remaining)); $('timerText').setAttribute('aria-live','assertive'); }
function updateCrystalsUI(){ $('crystals').textContent = STATE.crystals; }
function updateStreakUI(){ $('streak').textContent = STATE.streak; }

function updateButtonsEnabled(enabled){
  const ids = ['tapBtn','startBtn','pauseBtn','backIntroBtn','skipBtn'];
  ids.forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(enabled){ el.removeAttribute('aria-disabled'); el.classList.remove('disabled'); el.setAttribute('tabindex','0'); }
    else { el.setAttribute('aria-disabled','true'); el.classList.add('disabled'); el.setAttribute('tabindex','-1'); }
  });
}

function setView(v){
  STATE.view = v;
  if(v === 'intro'){
    $('viewIntro').classList.remove('hidden');
    $('viewGame').classList.add('hidden');
    $('viewIntro').setAttribute('aria-hidden','false');
    $('viewGame').setAttribute('aria-hidden','true');
  } else {
    $('viewIntro').classList.add('hidden');
    $('viewGame').classList.remove('hidden');
    $('viewIntro').setAttribute('aria-hidden','true');
    $('viewGame').setAttribute('aria-hidden','false');
  }
}

/* ===========================
   INTRO CRAWL (Star-Wars-esque)
   =========================== */
let crawlTimer = null;
function startIntroFlow(){
  ensureAudio();
  setView('intro');
  playCrawl(false);
}
function playCrawl(skip=false){
  const crawlEl = $('crawl');
  const duration = skip ? 0.05 : CONFIG.crawlDuration;
  // Reset and apply perspective transform for cinematic slant
  crawlEl.style.transition = 'none';
  crawlEl.style.transform = 'translateY(40%) rotateX(28deg) scale(1)';
  void crawlEl.offsetWidth;
  crawlEl.style.transition = `transform ${duration}s linear`;
  crawlEl.style.transform = 'translateY(-220%) rotateX(28deg) scale(0.6)';
  if(STATE.audioReady && !STATE.mute) { tone(1200,0.12,'sawtooth'); tone(1600,0.08,'sine',0.08); }
  STATE.crawlPlaying = true;
  clearTimeout(crawlTimer);
  crawlTimer = setTimeout(()=>{ STATE.crawlPlaying = false; startPrecountdown(); }, Math.max(50, duration*1000));
}

/* ===========================
   PRE-COUNTDOWN
   =========================== */
let countdownInterval = null;
function startPrecountdown(){
  setView('game');
  updateButtonsEnabled(false);
  STATE.brushing = true;
  STATE.countdown = CONFIG.preCountdown;
  updateTimerUI(STATE.countdown + CONFIG.duration);
  startCountdownVisual(STATE.countdown);
  ensureAudio();
  let t = Math.ceil(STATE.countdown);
  if(STATE.audioReady && !STATE.mute) tone(880,0.12,'sine');
  clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    t--;
    if(t>0){
      if(STATE.audioReady && !STATE.mute) tone(880 - (t*40), 0.12, 'square');
    } else {
      clearInterval(countdownInterval);
      if(STATE.audioReady && !STATE.mute) tone(1200,0.18,'sawtooth');
      startMainTimer();
    }
  },1000);
}
function skipCountdownOrCrawl(){
  if(STATE.crawlPlaying){
    clearTimeout(crawlTimer);
    STATE.crawlPlaying = false;
    startPrecountdown();
  } else if(STATE.brushing && STATE.countdown > 0){
    clearInterval(countdownInterval);
    startMainTimer();
  }
}

/* Countdown visual overlay */
let countdownOverlayTimer = null;
function startCountdownVisual(seconds){
  const overlay = document.createElement('div');
  overlay.style.position='absolute';
  overlay.style.inset='0';
  overlay.style.display='flex';
  overlay.style.alignItems='center';
  overlay.style.justifyContent='center';
  overlay.style.pointerEvents='none';
  overlay.style.fontSize='120px';
  overlay.style.fontWeight='900';
  overlay.style.color='rgba(255,255,255,0.95)';
  overlay.style.textShadow='0 6px 18px rgba(0,0,0,0.6)';
  overlay.style.zIndex='999';
  overlay.id = 'countOverlay';
  $('screenWrap').appendChild(overlay);
  let t = Math.ceil(seconds);
  overlay.textContent = t;
  if(STATE.audioReady && !STATE.mute) tone(880,0.12,'sine');
  countdownOverlayTimer = setInterval(()=>{
    t--;
    if(t>0){
      overlay.textContent = t;
      if(STATE.audioReady && !STATE.mute) tone(880 - (t*40), 0.12, 'square');
    } else {
      clearInterval(countdownOverlayTimer);
      overlay.remove();
    }
  },1000);
}

/* ===========================
   MAIN TIMER & DRAIN LOGIC
   ===========================
   Deterministic drain formula:
     drainPerSecond = bossMaxHP / duration
   Each frame: bossHP -= drainPerSecond * dt
   Clamping dt (e.g., dt <= 0.05s) prevents large jumps after tab suspension.
   This guarantees bossHP reaches zero exactly at duration seconds.
   =========================== */
let mainStartTime = 0;
function startMainTimer(){
  resetBoss();
  mainStartTime = now();
  STATE.mainStartTime = mainStartTime;
  STATE.mainElapsed = 0;
  STATE.brushing = true;
  STATE.paused = false;
  STATE.running = true;
  updateButtonsEnabled(false);
  updateTimerUI(CONFIG.duration);
  STATE.lastTime = performance.now();
  requestAnimationFrame(loop);
}

/* ===========================
   TAP ACTION (sparkles) - disabled during brushing
   =========================== */
function handleTap(){
  if(STATE.brushing) return;
  spawnSparkle(Math.random()*CONFIG.canvasW, CONFIG.canvasH*0.6 + Math.random()*CONFIG.canvasH*0.2);
  if(STATE.audioReady && !STATE.mute) laserSound();
}

/* ===========================
   SPAWN HELPERS
   =========================== */
function spawnParticle(x,y,vx,vy,life,size,color){
  if(activeParticles.length >= CONFIG.maxActiveParticles){
    const p = activeParticles.shift();
    Object.assign(p,{x,y,vx,vy,life,maxLife:life,size,color,rot:Math.random()*Math.PI*2,rotV:(Math.random()-0.5)*6});
    activeParticles.push(p);
    return p;
  }
  const p = particlePool.acquire();
  p.x=x; p.y=y; p.vx=vx; p.vy=vy; p.life=life; p.maxLife=life; p.size=size; p.color=color; p.rot=Math.random()*Math.PI*2; p.rotV=(Math.random()-0.5)*6;
  activeParticles.push(p);
  return p;
}
function spawnDebris(x,y,vx,vy,life,size,color){
  if(activeDebris.length >= CONFIG.maxActiveDebris){
    const d = activeDebris.shift();
    Object.assign(d,{x,y,vx,vy,life,maxLife:life,size,color,rot:Math.random()*Math.PI*2,rotV:(Math.random()-0.5)*6});
    activeDebris.push(d);
    return d;
  }
  const d = debrisPool.acquire();
  d.x=x; d.y=y; d.vx=vx; d.vy=vy; d.life=life; d.maxLife=life; d.size=size; d.color=color; d.rot=Math.random()*Math.PI*2; d.rotV=(Math.random()-0.5)*6; d.shape = Math.floor(Math.random()*3);
  activeDebris.push(d);
  return d;
}
function spawnSparkle(x,y){
  const s = sparklePool.acquire();
  s.x=x; s.y=y; s.age=0; s.life=0.6 + Math.random()*0.8; s.size=6 + Math.random()*8; s.angle=Math.random()*Math.PI*2;
  activeSparkles.push(s);
  return s;
}

/* ===========================
   UPDATE (per-frame)
   =========================== */
function update(dt){
  dt = clamp(dt, 0, 0.05);

  // Stars
  for(let s of stars){
    s.y += s.speed * dt;
    if(s.y > CONFIG.canvasH + 10){ s.y = -10; s.x = Math.random()*CONFIG.canvasW; s.z = Math.random(); }
  }

  // Hero idle and firing visuals
  HERO.fireCooldown = Math.max(0, HERO.fireCooldown - dt);
  if(STATE.brushing){
    // hero jet boost subtle when firing
    HERO.jetBoost = clamp(HERO.jetBoost + dt*2, 0, 1);
    // spawn continuous laser impact visuals on titan
    if(Math.random() < 0.18){
      const hitX = TITAN.x + (Math.random()-0.5)*(TITAN.w*0.45);
      const hitY = TITAN.y + (Math.random()-0.5)*(TITAN.h*0.35);
      spawnSparkle(hitX, hitY);
      for(let i=0;i<3;i++){
        spawnParticle(hitX, hitY, (Math.random()-0.5)*200, (Math.random()-0.8)*-120, 0.4 + Math.random()*0.6, 1 + Math.random()*3, Math.random()<0.5 ? '#fff' : '#ff3fb5');
      }
      if(STATE.audioReady && !STATE.mute) laserSound();
    }
  } else {
    HERO.jetBoost = clamp(HERO.jetBoost - dt*2, 0, 1);
    if(HERO.fireCooldown <= 0){
      HERO.fireCooldown = HERO.fireRate;
      spawnParticle(HERO.x, HERO.y - 10, (Math.random()-0.5)*20, -120 + Math.random()*-40, 0.18, 1.5, '#7afcff');
    }
  }

  // Main brushing deterministic drain
  if(STATE.running && STATE.brushing && !STATE.paused){
    STATE.bossHP -= STATE.drainPerSecond * dt;
    if(STATE.bossHP <= 0){
      STATE.bossHP = 0;
      updateBossUI();
      endBrushing(true);
      return;
    }
    STATE.mainElapsed = now() - STATE.mainStartTime;
    const remaining = Math.max(0, CONFIG.duration - STATE.mainElapsed);
    updateTimerUI(remaining);

    // progressive damage thresholds
    const hpPct = STATE.bossHP / STATE.bossMaxHP;
    const prevState = TITAN.damageState;
    if(hpPct <= 0.75 && hpPct > 0.5) TITAN.damageState = 1;
    else if(hpPct <= 0.5 && hpPct > 0.25) TITAN.damageState = 2;
    else if(hpPct <= 0.25) TITAN.damageState = 3;
    if(TITAN.damageState !== prevState){
      for(let i=0;i<12;i++){
        const ang = Math.random()*Math.PI*2;
        const spd = 80 + Math.random()*240;
        spawnDebris(TITAN.x + (Math.random()-0.5)*TITAN.w*0.6, TITAN.y + (Math.random()-0.5)*TITAN.h*0.6, Math.cos(ang)*spd, Math.sin(ang)*spd - 40, 0.8 + Math.random()*1.2, 6 + Math.random()*8, '#cfcfcf');
      }
      if(STATE.audioReady && !STATE.mute) smallExplode();
      STATE.cameraShake.amt = 6 + TITAN.damageState*6;
    }
    STATE.cameraShake.amt = Math.max(0, STATE.cameraShake.amt - dt*6);
  }

  // Particles
  for(let i=activeParticles.length-1;i>=0;i--){
    const p = activeParticles[i];
    p.life -= dt;
    if(p.life <= 0){
      activeParticles.splice(i,1);
      particlePool.release(p);
      continue;
    }
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vy += 160 * dt;
    p.rot += p.rotV * dt;
  }

  // Debris
  for(let i=activeDebris.length-1;i>=0;i--){
    const d = activeDebris[i];
    d.life -= dt;
    if(d.life <= 0){
      activeDebris.splice(i,1);
      debrisPool.release(d);
      continue;
    }
    d.x += d.vx * dt;
    d.y += d.vy * dt;
    d.vy += 160 * dt;
    d.rot += d.rotV * dt;
  }

  // Sparkles
  for(let i=activeSparkles.length-1;i>=0;i--){
    const s = activeSparkles[i];
    s.age += dt;
    if(s.age >= s.life){
      activeSparkles.splice(i,1);
      sparklePool.release(s);
      continue;
    }
    if(Math.random() < 0.14){
      spawnParticle(s.x + (Math.random()-0.5)*8, s.y + (Math.random()-0.5)*8, (Math.random()-0.5)*120, (Math.random()-0.8)*-80, 0.4 + Math.random()*0.6, 1 + Math.random()*2, '#fff');
    }
  }
}

/* ===========================
   END BRUSHING & FINAL EXPLOSION
   =========================== */
function endBrushing(victory){
  STATE.running = false;
  STATE.brushing = false;
  updateButtonsEnabled(true);
  if(victory){
    STATE.crystals += 5;
    STATE.streak += 1;
    STATE.best = Math.max(STATE.best, STATE.streak);
    saveLS(CONFIG.localKeys.crystals, STATE.crystals);
    saveLS(CONFIG.localKeys.streak, STATE.streak);
    saveLS(CONFIG.localKeys.best, STATE.best);
    if(STATE.audioReady && !STATE.mute) bigBoom();
    triggerFinalExplosion();
  } else {
    STATE.streak = 0;
    saveLS(CONFIG.localKeys.streak, STATE.streak);
  }
  updateCrystalsUI();
  updateStreakUI();
  updateBossUI();
  updateTimerUI(0);
  for(let i=0;i<20;i++){
    spawnParticle(CONFIG.canvasW*0.5 + (Math.random()-0.5)*80, CONFIG.canvasH*0.45 + (Math.random()-0.5)*40, (Math.random()-0.5)*200, (Math.random()-0.5)*-200, 0.6 + Math.random()*0.8, 2 + Math.random()*4, Math.random()<0.5 ? '#7afcff' : '#ff3fb5');
  }
}

/* Final explosion choreography */
let finalExplosionState = {phase:0, t:0, active:false};
function triggerFinalExplosion(){
  finalExplosionState = {phase:0, t:0, active:true};
  for(let i=0;i<160;i++){
    const ang = Math.random()*Math.PI*2;
    const spd = 200 + Math.random()*1200;
    spawnDebris(TITAN.x, TITAN.y, Math.cos(ang)*spd, Math.sin(ang)*spd - 80, 1.2 + Math.random()*1.8, 6 + Math.random()*10, '#ffd1e8');
  }
}

/* ===========================
   RENDER
   =========================== */
function render(){
  const shakeAmt = STATE.cameraShake.amt;
  const sx = (Math.random()-0.5) * shakeAmt;
  const sy = (Math.random()-0.5) * shakeAmt;

  ctx.save();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(sx, sy);

  // background
  const g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,'#020617'); g.addColorStop(1,'#041026');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // stars
  for(let s of stars){
    const b = 0.06 + s.z*0.18;
    ctx.fillStyle = `rgba(255,255,255,${b})`;
    const size = s.size * (1 + s.z*1.2);
    ctx.beginPath();
    ctx.ellipse(s.x, s.y, size, size, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // speed lines when brushing
  if(STATE.brushing){
    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
    ctx.lineWidth = 2;
    for(let i=0;i<10;i++){
      ctx.beginPath();
      const x = canvas.width * 0.6 + i*6;
      ctx.moveTo(x, 40 + (i%2)*6);
      ctx.lineTo(x + 40, 10 + (i%3)*8);
      ctx.stroke();
    }
  }

  // Titan
  drawTitan();

  // Hero (exosuit kid) drawn prominently
  drawHero();

  // Laser beam from hero to titan when brushing
  if(STATE.brushing){
    const px = HERO.x, py = HERO.y - HERO.h*0.28;
    const tx = TITAN.x, ty = TITAN.y;
    ctx.save();
    ctx.globalCompositeOperation = 'lighter';
    const grad = ctx.createLinearGradient(px, py, tx, ty);
    grad.addColorStop(0, 'rgba(0,240,255,0.95)');
    grad.addColorStop(0.5, 'rgba(255,63,181,0.95)');
    grad.addColorStop(1, 'rgba(255,255,255,0.6)');
    ctx.strokeStyle = grad;
    ctx.lineWidth = 8;
    ctx.beginPath();
    ctx.moveTo(px, py);
    const midx = (px + tx)/2 + Math.sin(now()*12)*6;
    const midy = (py + ty)/2 + Math.cos(now()*10)*6;
    ctx.quadraticCurveTo(midx, midy, tx, ty);
    ctx.stroke();
    ctx.restore();
  }

  // Debris
  for(let d of activeDebris){
    ctx.save();
    ctx.translate(d.x, d.y);
    ctx.rotate(d.rot);
    ctx.fillStyle = d.color;
    ctx.beginPath();
    if(d.shape === 0){
      ctx.moveTo(-d.size, -d.size);
      ctx.lineTo(d.size, 0);
      ctx.lineTo(-d.size, d.size);
    } else if(d.shape === 1){
      ctx.moveTo(0, -d.size);
      ctx.lineTo(d.size, d.size);
      ctx.lineTo(-d.size, d.size);
    } else {
      ctx.moveTo(-d.size, -d.size);
      ctx.lineTo(d.size, -d.size);
      ctx.lineTo(0, d.size);
    }
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  // Particles
  for(let p of activeParticles){
    const lifeRatio = p.life / p.maxLife;
    ctx.globalAlpha = clamp(lifeRatio,0,1);
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.ellipse(p.x, p.y, p.size, p.size, p.rot, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  // Sparkles
  for(let s of activeSparkles){
    const t = s.age / s.life;
    const alpha = 1 - t;
    ctx.save();
    ctx.translate(s.x, s.y);
    ctx.rotate(s.angle + t*6);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.moveTo(0, -s.size*0.6);
    ctx.lineTo(s.size*0.2, 0);
    ctx.lineTo(0, s.size*0.6);
    ctx.lineTo(-s.size*0.2, 0);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  // CRT scanlines
  ctx.fillStyle = 'rgba(0,0,0,0.02)';
  for(let y=0;y<canvas.height;y+=4){
    ctx.fillRect(0,y,canvas.width,1);
  }

  ctx.restore();

  // HUD ring
  drawTimerRing();

  // Final explosion sequence rendering
  if(finalExplosionState.active){
    finalExplosionState.t += 1/60;
    if(finalExplosionState.phase === 0){
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.restore();
      finalExplosionState.phase = 1;
      finalExplosionState.t = 0;
    } else if(finalExplosionState.phase === 1){
      const t = finalExplosionState.t;
      const maxT = 0.6;
      const r = (t/maxT) * Math.max(canvas.width, canvas.height) * 1.2;
      ctx.save();
      ctx.beginPath();
      ctx.strokeStyle = `rgba(255,200,220,${1 - t/maxT})`;
      ctx.lineWidth = 8 + (1 - t/maxT)*40;
      ctx.arc(TITAN.x, TITAN.y, r, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
      if(t < 0.2 && Math.random() < 0.6){
        const ang = Math.random()*Math.PI*2;
        spawnDebris(TITAN.x, TITAN.y, Math.cos(ang)*(200+Math.random()*600), Math.sin(ang)*(200+Math.random()*600)-80, 1.2 + Math.random()*1.8, 6 + Math.random()*10, '#ffd1e8');
      }
      if(t > maxT){
        finalExplosionState.phase = 2;
        finalExplosionState.t = 0;
      }
    } else if(finalExplosionState.phase === 2){
      const t = finalExplosionState.t;
      if(t < 4 && Math.random() < 0.3){
        spawnParticle(TITAN.x + (Math.random()-0.5)*TITAN.w, TITAN.y + (Math.random()-0.5)*TITAN.h, (Math.random()-0.5)*40, -40 - Math.random()*40, 2 + Math.random()*2, 6 + Math.random()*8, 'rgba(80,80,90,0.6)');
      }
      if(t > 3.2){
        finalExplosionState.active = false;
        showVictoryOverlay();
      }
    }
  }
}

/* Draw Titan with visible damage */
function drawTitan(){
  const x = TITAN.x, y = TITAN.y, w = TITAN.w, h = TITAN.h;
  ctx.save();
  ctx.shadowColor = 'rgba(255,80,150,0.12)';
  ctx.shadowBlur = 18;
  roundRect(ctx, x - w/2, y - h/2, w, h, 18);
  ctx.fillStyle = '#0b1220';
  ctx.fill();
  ctx.lineWidth = 6;
  ctx.strokeStyle = '#111';
  ctx.stroke();
  ctx.restore();

  ctx.save();
  ctx.translate(x, y);
  const hpPct = clamp(STATE.bossHP / STATE.bossMaxHP, 0, 1);
  const glow = 0.2 + (1 - hpPct) * 1.2;
  const coreR = TITAN.coreR;
  const grad = ctx.createRadialGradient(0,0,6,0,0,coreR*3);
  grad.addColorStop(0, `rgba(255,255,255,${0.9*glow})`);
  grad.addColorStop(0.3, `rgba(255,120,180,${0.6*glow})`);
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(0, 0, coreR*3, 0, Math.PI*2);
  ctx.fill();

  ctx.beginPath();
  ctx.arc(0,0,coreR,0,Math.PI*2);
  ctx.fillStyle = `rgba(255,80,150,${0.9})`;
  ctx.fill();
  ctx.lineWidth = 4;
  ctx.strokeStyle = '#fff';
  ctx.stroke();

  if(TITAN.damageState >= 1){
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.beginPath();
    ctx.ellipse(-w*0.12, -h*0.08, 28, 12, -0.6, 0, Math.PI*2);
    ctx.fill();
  }
  if(TITAN.damageState >= 2){
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.moveTo(w*0.12, -h*0.05);
    ctx.lineTo(w*0.28, -h*0.02);
    ctx.lineTo(w*0.18, h*0.06);
    ctx.lineTo(w*0.06, h*0.02);
    ctx.closePath();
    ctx.fill();
  }
  if(TITAN.damageState >= 3){
    ctx.fillStyle = '#222';
    ctx.fillRect(-w*0.18, -h*0.06, w*0.36, h*0.12);
    for(let i=0;i<6;i++){
      ctx.strokeStyle = i%2 ? '#ff3fb5' : '#00f0ff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-w*0.16 + i*8, -h*0.04);
      ctx.lineTo(-w*0.16 + i*8 + Math.sin(i + Date.now()/400)*6, h*0.04);
      ctx.stroke();
    }
  }
  ctx.restore();
}

/* Timer ring (SVG) */
function drawTimerRing(){
  const ring = $('progressRing');
  const remaining = STATE.running && STATE.brushing ? Math.max(0, CONFIG.duration - (now() - STATE.mainStartTime)) : CONFIG.duration;
  const pct = clamp(remaining / CONFIG.duration, 0, 1);
  const size = 64;
  const stroke = 6;
  const r = (size - stroke)/2;
  const c = 2*Math.PI*r;
  const dash = c * pct;
  const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
    <defs><filter id="g"><feGaussianBlur stdDeviation="3" result="b"/></filter></defs>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="rgba(255,255,255,0.06)" stroke-width="${stroke}" fill="none"/>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="${STATE.highContrast ? '#fff' : '#00f0ff'}" stroke-width="${stroke}" stroke-linecap="round" fill="none"
      stroke-dasharray="${dash} ${c-dash}" transform="rotate(-90 ${size/2} ${size/2})" style="filter:url(#g);opacity:0.95"/>
  </svg>`;
  ring.innerHTML = svg;
}

/* ===========================
   LOOP
   =========================== */
function loop(ts){
  const nowMs = performance.now();
  let dt = (nowMs - STATE.lastTime)/1000;
  STATE.lastTime = nowMs;
  dt = clamp(dt, 0, 0.05);
  if(!STATE.paused) update(dt);
  render();
  requestAnimationFrame(loop);
}

/* ===========================
   STARTUP & HELPERS
   =========================== */
function drawStaticHUD(){
  updateBossUI();
  updateTimerUI(CONFIG.duration);
  updateCrystalsUI();
  updateStreakUI();
  drawTimerRing();
}
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

/* Victory overlay */
function showVictoryOverlay(){
  const overlay = document.createElement('div');
  overlay.style.position='absolute';
  overlay.style.inset='0';
  overlay.style.display='flex';
  overlay.style.alignItems='center';
  overlay.style.justifyContent='center';
  overlay.style.pointerEvents='auto';
  overlay.style.zIndex='999';
  overlay.style.flexDirection='column';
  overlay.style.background='linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.6))';
  overlay.innerHTML = `<div style="font-size:36px;font-weight:900;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,0.6);margin-bottom:12px">TITAN DOWN</div>
    <div style="font-size:18px;font-weight:900;color:var(--accent);margin-bottom:8px">+5 ðŸ’Ž  â€¢  Streak +1</div>
    <button id="closeVictory" class="btn" style="min-width:160px">CONTINUE</button>`;
  $('screenWrap').appendChild(overlay);
  $('closeVictory').addEventListener('click', ()=>{ overlay.remove(); });
}

/* Initialize */
(function init(){
  resetBoss();
  initStars();
  STATE.lastTime = performance.now();
  requestAnimationFrame(loop);
})();

/* Expose debug hooks */
window.__TITAN = window.__TITAN || {};
window.__TITAN.state = STATE;
window.__TITAN.startGame = startPrecountdown;
window.__TITAN.setView = setView;
window.__TITAN.resetBoss = resetBoss;
window.__TITAN.forceVictory = ()=>{ STATE.bossHP = 0; updateBossUI(); endBrushing(true); };

/* ===========================
   Helper functions used earlier but declared after for clarity
   =========================== */
function resetBoss(){
  STATE.bossHP = STATE.bossMaxHP = CONFIG.bossMaxHP;
  STATE.drainPerSecond = CONFIG.bossMaxHP / CONFIG.duration;
  TITAN.damageState = 0;
  updateBossUI();
}
</script>
</body>
</html>
