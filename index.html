<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TITAN OMEGA</title>
    <style>
        :root {
            --neon-blue: #00f2ff; --neon-pink: #ff00ff; --bright-yellow: #ffff00;
            --dark-bg: #050510; --comic-outline: 4px solid #000;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--dark-bg); color: white; font-family: 'Arial Black', sans-serif;
            overflow: hidden; touch-action: none;
        }
        /* CRT & Comic Overlay */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 4px, 3px 100%;
            opacity: 0.3;
        }
        .vignette {
            position: fixed; inset: 0; pointer-events: none; z-index: 101;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.6) 100%);
        }
        /* Intro Crawl Page */
        #intro-view {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; perspective: 400px; text-align: center;
        }
        .crawl-container {
            position: relative; width: 80%; height: 60%; overflow: hidden;
            transform: rotateX(25deg); mask-image: linear-gradient(transparent, black 30%);
        }
        .crawl-content {
            position: absolute; top: 100%; width: 100%;
            animation: crawl 8s linear forwards; color: var(--bright-yellow);
            font-size: 2.5rem; text-transform: uppercase; line-height: 1.5;
        }
        @keyframes crawl { 0% { top: 100%; } 100% { top: -150%; } }
        
        /* Game Page */
        #game-view { display: none; height: 100vh; position: relative; }
        #game-canvas { width: 100%; height: 100%; display: block; }
        
        /* HUD Elements */
        .hud {
            position: absolute; width: 100%; padding: 20px;
            display: flex; flex-direction: column; align-items: center; z-index: 10;
        }
        .hp-container {
            width: 80%; height: 30px; border: var(--comic-outline);
            background: #222; position: relative; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 15px var(--neon-pink);
        }
        #hp-bar {
            width: 100%; height: 100%; background: linear-gradient(90deg, #ff0055, #ff6600);
            transition: width 0.1s linear;
        }
        .timer-circle {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 180px; height: 180px; border-radius: 50%;
            border: 8px solid var(--neon-blue); display: flex;
            align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); font-size: 3rem; color: #fff;
            box-shadow: 0 0 30px var(--neon-blue);
        }
        .stats {
            position: absolute; bottom: 120px; width: 100%;
            display: flex; justify-content: space-around; font-size: 1.2rem;
            color: var(--neon-pink); text-shadow: 2px 2px #000;
        }
        /* Buttons */
        .controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center; gap: 20px;
        }
        button {
            padding: 15px 30px; font-size: 1.2rem; font-family: inherit;
            border: var(--comic-outline); border-radius: 10px; cursor: pointer;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-start { background: var(--bright-yellow); color: #000; }
        .btn-action { background: var(--neon-blue); color: #000; }
        button:disabled { opacity: 0.4; filter: grayscale(1); transform: scale(0.95); }
        
        #pre-countdown {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center;
            font-size: 12rem; color: var(--neon-pink); z-index: 200;
        }
    </style>
</head>
<body onload="init()">
    <div class="overlay"></div>
    <div class="vignette"></div>

    <!-- Intro View -->
    <div id="intro-view">
        <div class="crawl-container">
            <div class="crawl-content" id="crawl-text">
                Prepare for Sync...<br><br>The Germ Legion is invading!<br><br>Only the Chrono Brush can stop them...<br><br>Brush well, Pilot!
            </div>
        </div>
        <button class="btn-start" onclick="startSequence()">Start Mission</button>
    </div>

    <!-- Pre-Countdown Overlay -->
    <div id="pre-countdown">5</div>

    <!-- Game View -->
    <div id="game-view">
        <div class="hud">
            <div class="hp-container"><div id="hp-bar"></div></div>
            <div class="timer-circle" id="timer-display">02:00</div>
        </div>
        <canvas id="game-canvas"></canvas>
        <div class="stats">
            <div>CRYSTALS: <span id="crystal-count">0</span></div>
            <div>STREAK: <span id="streak-count">0</span></div>
        </div>
        <div class="controls">
            <button id="tap-btn" class="btn-action" onmousedown="handleTap()">Sparkle!</button>
            <button id="mute-btn" onclick="toggleMute()">Mute</button>
        </div>
    </div>

    <script>
        let audioCtx, isMuted = false, state = 'intro';
        let timer = 120, crystals = parseInt(localStorage.getItem('titan_crystals')) || 0;
        let streak = parseInt(localStorage.getItem('titan_streak')) || 0;
        let canvas, ctx, particles = [];

        function init() {
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);
            document.getElementById('crystal-count').innerText = crystals;
            document.getElementById('streak-count').innerText = streak;
            
            // iOS PWA Scroll Prevention
            document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // Procedural Web Audio API sound generation
        function playSfx(freq, type, duration) {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + duration);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function startSequence() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.getElementById('intro-view').style.display = 'none';
            const countdownEl = document.getElementById('pre-countdown');
            countdownEl.style.display = 'flex';
            
            let count = 5;
            const countInt = setInterval(() => {
                count--;
                playSfx(440, 'square', 0.1);
                if (count <= 0) {
                    clearInterval(countInt);
                    countdownEl.style.display = 'none';
                    startGame();
                } else {
                    countdownEl.innerText = count;
                }
            }, 1000);
        }

        function startGame() {
            document.getElementById('game-view').style.display = 'block';
            document.getElementById('tap-btn').disabled = true;
            state = 'brushing';
            
            const gameLoop = setInterval(() => {
                timer -= 0.1;
                updateHUD();
                drawBoss();
                if (timer <= 0) {
                    clearInterval(gameLoop);
                    endSession();
                }
            }, 100);
            animate();
        }

        function updateHUD() {
            const m = Math.floor(timer / 60);
            const s = Math.floor(timer % 60);
            document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            document.getElementById('hp-bar').style.width = (timer / 120 * 100) + '%';
        }

        function drawBoss() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Simple procedural boss (bouncing orb)
            const bounce = Math.sin(Date.now() / 200) * 20;
            ctx.shadowBlur = 20; ctx.shadowColor = '#ff00ff';
            ctx.fillStyle = '#ff00ff';
            ctx.beginPath();
            ctx.arc(canvas.width/2, canvas.height/3 + bounce, 60, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw particles
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.alpha -= 0.02;
                ctx.fillStyle = `rgba(0, 242, 255, ${p.alpha})`;
                ctx.fillRect(p.x, p.y, 4, 4);
                if (p.alpha <= 0) particles.splice(i, 1);
            });
        }

        function handleTap() {
            if (state !== 'finished') return;
            crystals += 10;
            localStorage.setItem('titan_crystals', crystals);
            document.getElementById('crystal-count').innerText = crystals;
            playSfx(880, 'sine', 0.2);
            for(let i=0; i<10; i++) particles.push({
                x: canvas.width/2, y: canvas.height/3, 
                vx: Math.random()*10-5, vy: Math.random()*10-5, alpha: 1
            });
        }

        function endSession() {
            state = 'finished';
            streak++;
            localStorage.setItem('titan_streak', streak);
            document.getElementById('streak-count').innerText = streak;
            document.getElementById('tap-btn').disabled = false;
            document.getElementById('timer-display').innerText = "WIN!";
            playSfx(523.25, 'triangle', 0.5); // Victory chime
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? 'Unmute' : 'Mute';
        }

        function animate() {
            if (state === 'brushing' || state === 'finished') {
                drawBoss();
                requestAnimationFrame(animate);
            }
        }
    </script>
</body>
</html>
