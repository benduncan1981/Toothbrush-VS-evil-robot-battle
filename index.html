<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EXO-BRUSH: TITAN FALL</title>
    <style>
        :root { --p1: #081820; --p2: #346856; --p3: #88c070; --p4: #e0f8d0; --gold: #fcc201; --red: #ff4545; }
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; height: 100%; font-family: 'Courier New', Courier, monospace; }
        #stage { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { background: var(--p1); image-rendering: pixelated; width: 100%; height: 100%; max-width: 430px; aspect-ratio: 9/19.5; border-left: 2px solid #222; border-right: 2px solid #222; }
        
        /* Scanline Overlay */
        #stage::after { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; z-index: 5; }

        #ui-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; background: rgba(0,0,0,0.85); color: var(--p4); text-align: center; }
        .start-btn { padding: 25px 50px; background: var(--p2); border: 6px solid var(--p4); color: white; font-size: 28px; font-weight: 900; cursor: pointer; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%); transition: transform 0.1s; }
        .start-btn:active { transform: scale(0.9); }
        
        #parent-gate { position: absolute; bottom: 0; right: 0; width: 64px; height: 64px; z-index: 100; cursor: default; }
    </style>
</head>
<body>

<div id="stage">
    <canvas id="c"></canvas>
    <div id="ui-overlay">
        <div id="sync-text" style="font-size: 18px; letter-spacing: 4px; margin-bottom: 10px;">NEURAL LINK STANDBY</div>
        <div id="timer-display" style="font-size: 120px; font-weight: 900; margin-bottom: 20px;">READY</div>
        <button class="start-btn" onclick="initCore()">ENGAGE BRUSH</button>
    </div>
    <div id="parent-gate" ontouchstart="handleGate()"></div>
</div>

<script>
/** 
 * GBA-MAX ENGINE
 * High-performance 16-bit logic for neurodivergent engagement
 */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui-overlay');
const timerVal = document.getElementById('timer-display');

let state = {
    active: false,
    time: 120,
    frame: 0,
    shake: 0,
    shots: 0,
    crystals: parseInt(localStorage.getItem('gba_crystals_v1')) || 0,
    streak: parseInt(localStorage.getItem('gba_streak_v1')) || 0,
    particles: []
};

// Audio Engine (Premium Synth)
let audioCtx;
const playSound = (freq, type, dur, vol=0.1) => {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + dur);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
};

function initCore() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.querySelector('.start-btn').style.display = 'none';
    let count = 5;
    const countdown = setInterval(() => {
        timerVal.innerText = count;
        playSound(200 + (6-count)*100, 'square', 0.2);
        count--;
        if(count < 0) {
            clearInterval(countdown);
            ui.style.display = 'none';
            state.active = true;
            canvas.width = 430; canvas.height = 932; // iPhone 15 Res
            requestAnimationFrame(gameLoop);
        }
    }, 1000);
}

// Particle System
const spawnParticles = (x, y, color, count, speed) => {
    for(let i=0; i<count; i++) {
        state.particles.push({
            x, y, 
            vx: (Math.random()-0.5)*speed, 
            vy: (Math.random()-0.5)*speed, 
            life: 1, 
            c: color
        });
    }
};

function drawHero(x, y) {
    const recoil = Math.sin(state.frame * 0.8) * (state.shake * 0.5);
    // Draw Pilot Body (16-bit style)
    ctx.fillStyle = '#e0f8d0';
    ctx.fillRect(x - 30, y + recoil, 60, 80); // Chassis
    ctx.fillStyle = '#00ffff'; 
    ctx.fillRect(x - 20, y + 10 + recoil, 40, 20); // Visor
    // Cannon
    ctx.fillStyle = '#346856';
    ctx.fillRect(x + 20, y + 40 + recoil, 40, 15);
    
    if(state.frame % 20 === 0) { // Muzzle Flash
        ctx.fillStyle = '#fff';
        ctx.fillRect(x + 60, y + 35 + recoil, 20, 25);
        state.shake = 10;
        state.shots++;
        playSound(150, 'sawtooth', 0.1, 0.05);
        spawnParticles(x+60, y+45, '#fff', 5, 10);
    }
}

function drawTitan(stage) {
    const drift = Math.sin(state.frame * 0.02) * 20;
    const centerX = 215 + drift;
    const centerY = 250;
    
    // Core
    const colors = ['#88c070', '#fcc201', '#ff4545', '#ff0000'];
    ctx.fillStyle = colors[stage];
    ctx.beginPath();
    ctx.arc(centerX, centerY, 100, 0, Math.PI*2);
    ctx.fill();

    // Damage Sparks
    if(stage > 1 && state.frame % 5 === 0) {
        spawnParticles(centerX + (Math.random()-0.5)*150, centerY + (Math.random()-0.5)*150, '#fff', 2, 5);
    }
}

function gameLoop() {
    if(!state.active) return;
    
    // 1. Logic
    state.frame++;
    if(state.frame % 60 === 0) state.time--;
    if(state.shake > 0) state.shake *= 0.9;

    // 2. Render
    ctx.fillStyle = '#081820';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Parallax Stars
    ctx.fillStyle = '#346856';
    for(let i=0; i<30; i++) {
        let py = (i * 40 + state.frame * 2) % canvas.height;
        ctx.fillRect((i * 77) % canvas.width, py, 4, 4);
    }

    // Shake Application
    ctx.save();
    if(state.shake > 1) ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake);

    const stage = Math.min(3, Math.floor((120 - state.time) / 30));
    drawTitan(stage);
    drawHero(215, 650 + Math.sin(state.frame*0.05)*30);

    // Particles
    state.particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.02;
        ctx.fillStyle = p.c;
        ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 6, 6);
        if(p.life <= 0) state.particles.splice(i, 1);
    });
    ctx.restore();
    ctx.globalAlpha = 1;

    // HUD
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0, 0, canvas.width, 120);
    ctx.fillStyle = '#fff';
    ctx.font = "900 30px 'Courier New'";
    ctx.fillText(`TIME: ${Math.max(0, state.time)}s`, 30, 60);
    ctx.fillStyle = '#fcc201';
    ctx.fillText(`CRYSTALS: ${state.crystals}`, 30, 100);

    if(state.time <= 0) return triggerMegaExplosion();
    requestAnimationFrame(gameLoop);
}

function triggerMegaExplosion() {
    state.active = false;
    playSound(60, 'sawtooth', 2, 0.5); // Deep sub boom
    spawnParticles(215, 250, '#fff', 300, 40);
    spawnParticles(215, 250, '#fcc201', 200, 30);
    
    let flash = 0;
    const endInt = setInterval(() => {
        ctx.fillStyle = `rgba(255,255,255, ${1 - flash})`;
        ctx.fillRect(0,0,canvas.width, canvas.height);
        flash += 0.05;
        if(flash >= 1) {
            clearInterval(endInt);
            showLoot();
        }
    }, 30);
}

function showLoot() {
    const earned = Math.floor(state.shots / 6) + (state.streak * 2);
    state.crystals += earned;
    state.streak++;
    localStorage.setItem('gba_crystals_v1', state.crystals);
    localStorage.setItem('gba_streak_v1', state.streak);
    
    ui.style.display = 'flex';
    timerVal.innerText = "VICTORY";
    timerVal.style.fontSize = "60px";
    document.getElementById('sync-text').innerText = `+${earned} CRYSTALS ACQUIRED`;
    document.getElementById('sync-text').style.color = "gold";
}

let gateTaps = 0;
function handleGate() {
    gateTaps++;
    if(gateTaps >= 5) {
        const p = prompt("ADMIN PIN:");
        if(p === "1234") {
            state.crystals = parseInt(prompt("Set Crystals:", state.crystals));
            localStorage.setItem('gba_crystals_v1', state.crystals);
            location.reload();
        }
        gateTaps = 0;
    }
}
</script>
</body>
</html>
